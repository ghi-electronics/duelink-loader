import{r as e,d as a,c as t,o as s,a as i,e as l,f as n,g as o,t as c,u as r,n as u,h as d,b as v}from"./runtime-dom.esm-bundler-to4JhdcG.js";import{m as w,u as p}from"./mitt-CapaXOQL.js";const g={class:"page"},h={class:"button-row"},f={key:0,class:"overlay"},m={class:"dialog"},b={class:"dialog-body"},y={key:1,class:"overlay"},k={class:"dialog"},U={class:"dialog-buttons"},D={key:2,class:"overlay"},_={class:"dialog",style:{width:"25vw"}},E={key:0,class:"fas fa-exclamation-triangle",style:{"margin-right":"8px"}},C={class:"dialog-body"},L={class:"update-driver-progress-container"},x={class:"progress-text"},T={key:3,class:"overlay"},A={class:"dialog",style:{width:"25vw"}},S={key:0,class:"fas fa-exclamation-triangle",style:{"margin-right":"8px"}},F={class:"dialog-body"},B={class:"update-driver-progress-container"},I={class:"progress-text"},q="Firmware detected.\nAre you sure you want to erase all and enter DFU mode?",j=2048,M=134217728;v({__name:"update",setup(v){const O=w(),H=p({progress:null},O);e("");const P=e("");function W(e){return new Promise(a=>setTimeout(a,e))}const Y=e(!1),N=e(!1),z=e(!1),G=e(!1),V=e(0);e(1);const $=e(q);async function J(){for(Y.value=!1,V.value=0,z.value=!0,await H.eraseall_dms_execute();H.eraseall_status_dms.value<2;)await W(250),V.value=50;V.value=100,await W(250),z.value=!1,N.value=!0}async function K(){Y.value=!1,H.isConnected&&(await H.disconnect(),await W(250))}let Q;const R=e(!1);e(!1);const X=a({});async function Z(e){const a=X[e];await async function(e){try{0!==(await se()).status&&(await Q.controlTransferOut({requestType:"class",recipient:"interface",request:4,value:0,index:0}),await W(100));const a=e.byteLength;await async function(e){P.value="Erasing...";const a=Math.ceil(e/j);for(let t=0;t<a;t++){const e=M+t*j,s=new Uint8Array(5);s[0]=65,s[1]=255&e,s[2]=e>>8&255,s[3]=e>>16&255,s[4]=e>>24&255,await te(0,s),await ie(),ae(t,a)}P.value="Erased.",ae(0,100)}(a),V.value=0,G.value=!1,await W(250),G.value=!0,P.value="Writing...";let t=new Uint8Array(5);t[0]=33,t[1]=0,t[2]=0,t[3]=0,t[4]=8,await te(0,t),await ie();let s=0,i=2;for(;s<a;){const t=e.slice(s,s+1024);await te(i,t),await ie(),s+=t.byteLength,i++,ae(s,a)}await async function(){let e=new Uint8Array(5);try{return e[0]=33,e[1]=0,e[2]=0,e[3]=0,e[4]=8,await te(0,e),await ie(),await te(0,new ArrayBuffer(0)),await ie(),1}catch(a){}return 0}()}catch(a){}}(a.image)}async function ee(){await async function(){try{R.value=!1,Q=await navigator.usb.requestDevice({filters:[{vendorId:1155,productId:57105}]}),await Q.open(),Q.configuration||await Q.selectConfiguration(1),await Q.claimInterface(0),R.value=!0}catch(e){e.value="Connection error: "+e,R.value=!1}}(),R.value&&(V.value=0,G.value=!0,await async function(e){const a=X[e];if(!a||!Array.isArray(a.versions)||0===a.versions.length)return;const t=a.versions.reduce((e,a)=>a.id>e.id?a:e).url;try{const e=await fetch(t);if(!e.ok)throw new Error(`HTTP ${e.status}`);const s=await e.blob(),i=await s.arrayBuffer();a.image=i}catch(s){a.image=null}}("DUELink"),await Z("DUELink"),G.value=!1)}function ae(e,a){V.value=Math.round(e/a*100),V.value}async function te(e,a){const t=await Q.controlTransferOut({requestType:"class",recipient:"interface",request:1,value:e,index:0},a);if("ok"!==t.status)throw new Error("DNLOAD transfer failed at block "+e);return t}async function se(){const e=await Q.controlTransferIn({requestType:"class",recipient:"interface",request:3,value:0,index:0},6);if("ok"===e.status&&e.data&&6===e.data.byteLength){const a=new DataView(e.data.buffer);return{status:a.getUint8(0),pollTimeout:a.getUint8(1)|a.getUint8(2)<<8|a.getUint8(3)<<16,state:a.getUint8(4),iString:a.getUint8(5)}}throw new Error("Failed to read DFU status.")}async function ie(){for(;;){const e=await se();if(5===e.state||2===e.state)break;await W(e.pollTimeout)}}return async function(){try{const e=await fetch("https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/duelink-fw.json"),a=await e.json();Object.keys(a).forEach(e=>{X[e]=a[e],X[e].isGlb=!1,X[e].image=null})}catch(e){}}(),(e,a)=>(s(),t("div",g,[a[11]||(a[11]=i('<h1 class="title">DUELink Loader</h1><p class="subtitle"> This page will help in updating DUELink firmware and its related Driver. </p><hr class="divider"><h2 class="section-title">Step 1 (Erase All)</h2><div class="card-container"><div class="card"><img src="https://www.duelink.com/img/catalog/mcduestem-b-1.webp" alt="Module with USB" class="card-image"><p class="card-text"> If your module has a USB connector, just plug it in! </p></div><div class="card"><img src="https://www.duelink.com/img/usbhook-rgb3.webp" alt="USB Hook" class="card-image"><p class="card-text"> If your module has a <code>U</code> Uplink connector, you need a USB adaptor, like USB Hook. </p></div></div><p class="subtitle"> Click the <strong>Erase All</strong> button, then select the device. You should only see one named <em>DUELink Official</em> or <em>DUELink MicroBlocks</em>. </p><img src="https://www.duelink.com/img/console-connect-dfu.webp" alt="Select DFU device" class="screenshot">',7)),l("div",h,[l("button",{class:"outline-button",onClick:a[0]||(a[0]=e=>async function(){if(H.eraseall_status_dms.value=0,0==H.isConnected.value){for(H.eraseall_vid_dms.value=0,H.connection_mode.value=2,await H.eraseall_dms_connect();0==H.eraseall_status_dms.value;)await W(100);await W(100)}if(0!=H.eraseall_vid_dms.value){let e=65535&H.eraseall_vid_dms.value;$.value=62208==e?"DUELink "+q:"MicroBlocks "+q,Y.value=!0}}())}," Erase All ")]),a[12]||(a[12]=i('<p class="subtitle"> If <strong>Erase All</strong> failed, visit the <a href="https://www.duelink.com/docs/loader" target="_blank"> loader documentation page </a>. </p><hr class="divider"><h2 class="section-title">Step 2 (Load Firmware/Driver)</h2><p class="subtitle"> This step will update the firmware on a single device, or on the first device in a chain. </p><p class="subtitle"> Click the button below then select the <em>DFU in FS Mode</em> device and click <strong>Connect</strong>. </p><p class="subtitle"> If using Windows, <a href="https://www.duelink.com/bin/usb-drivers/win-usb-dfu.zip" target="_blank">download</a> and install the DFU driver first. </p><img src="https://www.duelink.com/img/console-connect-dfu.webp" alt="DFU selection" class="screenshot">',7)),l("div",{class:"button-row"},[l("button",{class:"outline-button",onClick:ee}," Load DUELink Firmware/Driver "),a[2]||(a[2]=l("hr",{class:"divider"},null,-1)),a[3]||(a[3]=l("p",{class:"subtitle"},[o(" The update steps are now complete on a single device."),l("br"),l("br"),o(" Continue to step 3 if you have multiple devices in a chain that you want to update. ")],-1))]),a[13]||(a[13]=i('<hr class="divider"><h2 class="section-title">Step 3 (Update Chain)</h2><p class="subtitle"> This optional step is for updating all modules in a chain (Daisylink). </p><p class="subtitle"> Click the <strong>Load Driver Script</strong> button, then select the device. You should only see one named <em>DUELink Official</em>. </p><img src="https://www.duelink.com/img/console-connect-dfu.webp" alt="Driver selection" class="screenshot"><div class="button-row"><button class="outline-button"> Update Chain </button></div>',6)),Y.value?(s(),t("div",f,[l("div",m,[a[6]||(a[6]=l("div",{class:"dialog-title"},[l("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),o(" Warning ")],-1)),l("div",b,[l("p",null,[o(c($.value),1),a[4]||(a[4]=l("br",null,null,-1)),a[5]||(a[5]=l("br",null,null,-1))])]),l("div",{class:"dialog-buttons"},[l("button",{class:"yes",onClick:J},"Yes"),l("button",{class:"no",onClick:K},"No")])])])):n("",!0),N.value?(s(),t("div",y,[l("div",k,[a[7]||(a[7]=l("div",{class:"dialog-title-success"},[l("i",{class:"fas fa-check-circle",style:{color:"green","margin-right":"8px"}}),o(" Success ")],-1)),a[8]||(a[8]=l("div",{class:"dialog-body"},[l("p",null,'"Erase All" operation completed.')],-1)),l("div",U,[l("button",{class:"no",onClick:a[1]||(a[1]=e=>{N.value=!1,r(H).isBusy=!1})},"Close")])])])):n("",!0),z.value?(s(),t("div",D,[l("div",_,[l("div",{class:u(["dialog-title",{"dialog-title-success":100===V.value}])},[V.value<100?(s(),t("i",E)):n("",!0),o(" "+c(V.value<100?"Please wait...":"Completed"),1)],2),l("div",C,[a[9]||(a[9]=l("br",null,null,-1)),l("div",L,[l("div",{class:"update-driver-progress-bar",style:d({width:V.value+"%"})},null,4)]),l("div",x,c(V.value)+"% ",1)])])])):n("",!0),G.value?(s(),t("div",T,[l("div",A,[l("div",{class:u(["dialog-title",{"dialog-title-success":100===V.value}])},[V.value<100?(s(),t("i",S)):n("",!0),o(" "+c((V.value,P.value)),1)],2),l("div",F,[a[10]||(a[10]=l("br",null,null,-1)),l("div",B,[l("div",{class:"update-driver-progress-bar",style:d({width:V.value+"%"})},null,4)]),l("div",I,c(V.value)+"% ",1)])])])):n("",!0)]))}}).mount("#app");
