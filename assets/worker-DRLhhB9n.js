!function(){"use strict";importScripts("../consumer-queue.min.js");const e=new TextDecoder,t=new TextEncoder;let a=!1,n=">",s="",r=null,i=!0,o=null,l=null,c="",u=null;const w=new ConsumerQueue,d=[">","$","&"],p=7071;let g=!1,v=!1,f=0;async function m(){U(`Port status ${a}`),await new Promise(e=>setTimeout(e,400)),[r]=await navigator.serial.getPorts();try{if(!r.connected)return;null!=r.readable&&null!=r.writable&&(r.readable.locked||r.writable.locked)&&(await N(),await new Promise(e=>setTimeout(e,1e3))),await r.open({baudRate:115200,dataBits:8,parity:"none",stopBits:1,flowControl:"none"})}catch(n){return postMessage({event:"ConnectFailed",message:n?.message,name:n.name,full:n}),void L(n?.message||"Unable to open port.")}if(r.addEventListener("disconnect",()=>{U("Port disconnected"),N()}),null==r?.writable)return void L("Port is not a writable.");if(null==r?.readable)return void L("Port is not a readable.");if(u=r.writable.getWriter(),l=r.readable.getReader(),o=async function(){let t,r=!0;for(i=!0;i;)try{const{value:n,done:o}=await l.read();U("Reading... Done?",o);const u=e.decode(n).replace(/\r/gm,"");if(a&&!d.includes(u.substring(-1,1))){if(s+=u,s.length>2e3)if(u.length<s.length){s=s.substring(u.length,s.length);const e=s.indexOf("\n");e>-1&&(s=s.substring(e+1,s.length)),r=!0}else s="",postMessage({event:"output",value:"Maximum output limit reached."}),r=!1;r&&postMessage({event:"output",value:s})}if(c+=u,!c)continue;let p=c.indexOf("\n");for(p>-1?c.split("\n").forEach(e=>U("->",e)):U("->",c);p>-1;)t=c.substring(0,p),t&&(U("queued:",t),w.push(t)),c=c.substring(p+1),p=c.indexOf("\n");">"!==c&&"$"!==c&&"&"!==c||(U("queued:",c),w.push(c),c=""),o&&(i=!1),await F(2)}catch(n){postMessage({event:"logError",message:n?.message||"There were problems reading."});break}}(),await F(200),0!=await async function(){v&&postMessage({event:"progress_percent",value:5});await u.write(t.encode("")),await F(400),await E(),v&&postMessage({event:"progress_percent",value:10});await u.write(t.encode("\n")),await F(400),await E(),v&&postMessage({event:"progress_percent",value:15});await u.write(t.encode("sel(1)\n")),await F(100),await E(),v&&postMessage({event:"progress_percent",value:20});await u.write(t.encode("")),await F(100),await E(),v&&postMessage({event:"progress_percent",value:25});await u.write(t.encode("\n")),await F(100),await E(),v&&postMessage({event:"progress_percent",value:30});1!=$&&(v&&postMessage({event:"progress_percent",value:35}),await u.write(t.encode(`sel(${$})\n`)),await F(50),await E(),v&&postMessage({event:"progress_percent",value:40}),await u.write(t.encode("")),await F(50),await E(),v&&postMessage({event:"progress_percent",value:45}),await u.write(t.encode("\n")),await F(50),await E());v&&postMessage({event:"progress_percent",value:60});v&&postMessage({event:"progress_percent",value:65});const e=await async function(){const e=await V("version()");for(const t of e){if(U("line",t,(t.match(/\./g)||[]).length),-1!=t.indexOf("GHI Electronics DUELink v")){return t.split(":")[0].substring(24)}}return}();if("string"==typeof e)return U("version found",e),postMessage({event:"version",value:e}),v&&postMessage({event:"progress_percent",value:100}),1;v&&postMessage({event:"progress_percent",value:71});return await N(),0}()){a=!0;const e=r.getInfo();postMessage({event:"connected"}),postMessage({event:"eraseall_vid_dms",value:e.usbVendorId<<16|e.usbProductId})}else postMessage({event:"ConnectFailed",message:"Unable to detect DUELink firmware.",name:"Device is busy"})}addEventListener("message",e=>{switch(U(`---- on "message", do task: ${e.data.task} ----`),e.data.task){case"clearOutput":s="";break;case"connect":$=e.data.value,v=!0,m();break;case"disconnect":N();break;case"eraseall_dms_execute_msg":!async function(){const e=r.getInfo();e.usbVendorId==p&&62209==e.usbProductId?(await u.write(new Uint8Array([250,15,199])),await F(200),postMessage({event:"eraseall_status_dms",value:2})):e.usbVendorId==p&&62208==e.usbProductId&&(await u.write(t.encode("\n")),await F(400),await u.write(t.encode("reset(1)\n")),await F(100),await u.write(t.encode("reset(1)\n")),await F(700),postMessage({event:"eraseall_status_dms",value:2}))}();break;case"eraseall_dms_connect_msg":!async function(e){U(`Port status ${a}`),await new Promise(e=>setTimeout(e,400)),[r]=await navigator.serial.getPorts();try{if(!r.connected)return;null!=r.readable&&null!=r.writable&&(r.readable.locked||r.writable.locked)&&(await N(),await new Promise(e=>setTimeout(e,1e3))),await r.open({baudRate:115200,dataBits:8,parity:"none",stopBits:1,flowControl:"none"})}catch(s){return postMessage({event:"ConnectFailed",message:s?.message,name:s.name,full:s}),void L(s?.message||"Unable to open port.")}if(r.addEventListener("disconnect",()=>{U("Port disconnected"),N()}),null==r?.writable)return void L("Port is not a writable.");if(null==r?.readable)return void L("Port is not a readable.");const n=r.getInfo();n.usbVendorId==p&&(u=r.writable.getWriter(),postMessage({event:"eraseall_vid_dms",value:n.usbVendorId<<16|n.usbProductId}));$=e,await u.write(t.encode(`sel(${$})\n`)),await F(50),await E(),postMessage({event:"eraseall_status_dms",value:1})}(e.data.value);break;case"driver_connect_msg":I(e.data.value);break;case"driver_connect_updadate_msg":T();break;case"sendescape":!async function(){await u.write(t.encode("")),await F(400),await E()}();break;case"do_clone_fw":!async function(e,t){let a=e;for(a=e;a<t;a++){x=0,postMessage({event:"clone_fw_dev",value:a+1}),postMessage({event:"progress_body_text",value:`Cloning firmware from device ${a} to device ${a+1}...`}),C(a),await F(100);let e=0;for(;0==x;)postMessage({event:"progress_percent",value:e}),e+=1,await F(300),e>99&&(e=99);if(x<0)break;e<90&&(e+=5),postMessage({event:"progress_percent",value:e}),postMessage({event:"progress_body_text",value:`Connecting to device ${a+1}...`}),v=!1,await I(a+1),v=!0,e<95&&(e+=5),postMessage({event:"progress_percent",value:e}),postMessage({event:"progress_body_text",value:`Found: ${h} at address: ${a+1}. Loading the driver onto device...`}),v=!1,await T(),v=!0,f>0&&(e<99&&(e=99),postMessage({event:"progress_percent",value:e}),postMessage({event:"progress_body_text",value:"Finishing loading the driverâ€¦"}),await F(2e3))}postMessage({event:"clone_fw_status",value:a})}(e.data.value1,e.data.value2)}});let b=null;let _="",h="",M="",y="",k=!1,P="",$=1;async function I(e){if(k=!1,$=e,await m(),await F(100),!a)return;await u.write(t.encode("\n")),await F(400),(await E()).pop(),await u.write(t.encode("Dver()\n")),await F(100);let n=await E();if(n.length>0){n.pop();let e=n.pop();_=e.includes("unknown identifier")?"N/A":e}if(await u.write(t.encode("Info(0)\n")),await F(100),n=await E(),n.length>0){n.pop();let e=n.pop();const t=Number(e).toString(16).toUpperCase().padStart(6,"0");M="0x"+t}await async function(){const e=await fetch("https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/duelink.json"),t=await e.json();b=Array.isArray(t.products)?t.products:[]}();const s=function(e){if(!b)return"NA";const t=String(e).toUpperCase(),a=b.find(e=>String(e.PID).toUpperCase()===t);return a?{name:a.name??"NA",partNumber:a.partNumber??"NA"}:"NA"}(M);"NA"!==s&&(h=s.name,y=s.partNumber,P="https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/code/driver/"+y.toLowerCase()+".txt",postMessage({event:"update_driver_path_msg",value:P}),postMessage({event:"driver_ver_msg",value:_}),postMessage({event:"device_name_msg",value:h}),k=!0)}async function T(){if(f=0,!a||!k)return void(f=-1);const e=P,n=await fetch(e);if(!n.ok)return void(f=-1);let s=(await n.text()).replace(/\r/gm,"").replace(/\t/gm," ").split(/\n/);v&&postMessage({event:"progress_percent",value:0}),await V("new all"),v&&postMessage({event:"progress_percent",value:10}),await V("pgmbrst()","&"),await F(250),v&&postMessage({event:"progress_percent",value:20});let r=0;for(let t of s){await F(2),0===t.trim().length&&(t=" "),U("line",`"${t}"`),await O(t+"\n"),r++;let e=Math.floor(r/s.length*70);e>70&&(e=70),e+=20,v&&postMessage({event:"progress_percent",value:e})}v&&postMessage({event:"progress_percent",value:95}),await O("\0"),await S(),await u.write(t.encode("run\n")),await F(100),await u.write(t.encode("Region(1)\n")),await F(100),await E(),await u.write(t.encode("run\n")),await F(1e3),await u.write(t.encode("$\n")),await F(250),v&&postMessage({event:"progress_percent",value:96}),await u.write(t.encode("# This is region 1 User\n")),await F(250),await u.write(t.encode("# Replace this with your code\n")),await F(250),v&&postMessage({event:"progress_percent",value:97}),await u.write(t.encode("# StatLed(200,200,10)\n")),await F(250),v&&postMessage({event:"progress_percent",value:99}),await u.write(t.encode(">\n")),await F(250),await E(),v&&postMessage({event:"progress_percent",value:100}),f=1}let x=0;async function C(e){await V(`sel(${e+1})`,null,"\n",1e3);const t=await V("Info(1)");if(t.length>0){if(Number(t.pop())>0){await V(`sel(${e})`,null,"\n",1e3);const t=await V("clone()",null,"\n",3e4);if(t.length>0){const a=Number(t.pop());if(a==e+1)return x=a,x}}}return await V("sel(1)"),x=-1,x}async function N(){try{await async function(){i=!1,o&&(await l.cancel(),await o,o=null)}(),u&&(await u.close(),await u.releaseLock(),u=null),l&&(await l.cancel(),await l.releaseLock(),l=null),await r.close(),A("Port disconnected.")}catch(e){a&&(A("There was an error while disconnecting."),L(e?.message||"Unknown error."))}finally{a=!1,postMessage({event:"disconnected"}),postMessage({event:"version",value:null})}}function E(){return new Promise(async e=>{const t=[];let a;do{a=await w.tryPop(),a?(t.push(a),U("flushed - push line:",a)):U("flushed: No line")}while(a);t.length||(c=""),U("flushed",t),e(t)})}function U(){}function L(e){postMessage({event:"logError",message:e})}function A(e){postMessage({event:"logEvent",message:e})}let D=!1;function R(e,t){const a=[...e];return a.length>1?a.pop():a?.[0]===t&&a.shift(),D=!1,a}function S(e=null,t=3e3){return D?[]:(D=!0,e||(e=n),new Promise(async a=>{const n=[];let s=!1,r=null;const i=()=>{t<0||(clearTimeout(r),r=setTimeout(()=>{s=!0,g=!1,a(R(n,e))},t))};try{let t;i();do{try{t=await w.pop()}catch(o){return U("read until",o.message||o,n),clearTimeout(r),g=!1,void a(R(n,e))}if(!t||s)break;if(i(),n.push(t),t.startsWith("!")){U("Error:",t);break}}while(t!==e)}finally{clearTimeout(r)}g=!s,a(R(n,e))}))}function F(e){return new Promise(t=>setTimeout(t,e))}async function O(e){let a=t.encode(e),n=a.length,s=0;for(;n>0;){const e=a.subarray(s,s+Math.min(10,n));await u.write(e);const t=await w.tryPop();if(t)return t;s+=10,n-=e.length,await F(1)}return null}async function V(e,a=null,s="\n",r=3e3){try{postMessage({event:"isTalking",value:!0}),await E(),u.write(t.encode(e+s)),">"!==e&&"$"!==e||(n=e),await F(50);const i=await S(a||n,r);return i}finally{postMessage({event:"isTalking",value:!1,lastCommand:e})}}}();
