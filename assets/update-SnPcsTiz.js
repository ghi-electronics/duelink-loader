import{_ as e,d as a,r as t,e as l,f as s,c as i,o as n,a as o,g as u,h as c,w as r,v,F as d,i as f,j as w,t as p,n as g,u as h,k as m,b as y}from"./_plugin-vue_export-helper-BG_x5QSZ.js";import{u as b,_,a as k}from"./useWebSerial-LOP2owsi.js";const C=""+new URL("../img/stamp-usb-connect.webp",import.meta.url).href,U=""+new URL("../img/usbhook-rgb3.webp",import.meta.url).href,D={class:"page"},x={class:"button-row"},L={key:0,class:"version-select"},E=["value"],S={key:1,class:"overlay"},T={class:"dialog"},F={class:"dialog-body"},A={key:2,class:"overlay"},q={class:"dialog"},M={class:"dialog-body"},O={class:"dialog-buttons"},P={key:3,class:"overlay"},B={class:"dialog"},I={class:"dialog-body"},j={class:"dialog-buttons"},N={key:4,class:"overlay"},W={class:"dialog"},Y={class:"dialog-body"},R={class:"dialog-buttons"},V={key:5,class:"overlay"},$={class:"dialog"},H={class:"dialog-body"},z={key:0,class:"firmware-warning"},G=["href"],J={key:6,class:"overlay"},K={class:"dialog",style:{width:"25vw"}},Q={key:0,class:"fas fa-exclamation-triangle",style:{"margin-right":"8px"}},X={class:"dialog-body"},Z={class:"update-driver-progress-container"},ee={class:"progress-text"},ae="Firmware detected.",te=2048,le=134217728;y(e({__name:"update",setup(e){const y=b();a(async()=>{await async function(){try{const e=await fetch("https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/duelink-fw.json"),a=await e.json();Object.keys(a).forEach(e=>{De[e]=a[e],De[e].isGlb=!1,De[e].image=null})}catch(e){}}()}),t("");const se=t(""),ie=t(""),ne=t(""),oe=t("");function ue(e){return new Promise(a=>setTimeout(a,e))}const ce=t(!1),re=t(!1),ve=t(!1),de=t(!1),fe=t(!1),we=t(!1),pe=t(0),ge=t(ae);async function he(){for(ce.value=!1,pe.value=0,ie.value="Please wait...",fe.value=!0,await y.eraseall_dms_execute();y.eraseall_status_dms.value<2;)await ue(250),pe.value=50;pe.value=100,ie.value="Done",await ue(250),fe.value=!1,ne.value="Erase all completed.",re.value=!0}async function me(){ce.value=!1,y.isConnected&&(await y.disconnect(),await ue(250))}async function ye(){if(de.value=!1,!y.isConnected.value){y.device_name.value="",y.driver_ver.value="",y.progress_percent.value=0,pe.value=0,y.update_driver_status.value=0,y.update_devaddr.value=1,y.connection_mode.value=1;if(await y.driver_connect()){for(ie.value="Please wait...",fe.value=!0,pe.value=0;0==y.update_driver_status.value;)await ue(100),pe.value=y.progress_percent.value;if(await ue(100),1==y.update_driver_status.value){let e=!1;const a=Date.now()+4e3;for(;!(y.isConnected.value&&""!=y.device_name.value&&""!=y.driver_ver.value||(await ue(100),Date.now()>a));)pe.value=y.progress_percent.value;y.isConnected.value&&Date.now()<a&&(e=!0),e&&(ie.value="Connected",xe.value="Device Name: "+y.device_name.value,Le.value="Firmware Version: "+y.version.value,we.value=!0,pe.value=100,fe.value=!1)}fe.value=!1,pe.value=0}}}async function be(){for(we.value=!1,ie.value="Please wait...",fe.value=!0,y.progress_percent.value=0,pe.value=0,y.driver_update();100!=y.progress_percent.value;)await ue(1),pe.value=y.progress_percent.value;y.update_driver_status.value=0,await y.disconnect(),await ue(10),fe.value=!1,ne.value="Load driver completed.",re.value=!0}async function _e(){y.isConnected.value&&(y.disconnect(),await ue(100)),we.value=!1}async function ke(){if(0==y.isConnected.value&&await async function(){if(y.connect_status.value=0,y.connection_mode.value=0,y.update_driver_status.value=0,pe.value=0,y.progress_percent.value=0,await y.connect()){for(ie.value="Connecting to device 1...",fe.value=!0,pe.value=0;0==y.connect_status.value&&(await ue(100),pe.value=y.progress_percent.value,71!=pe.value););y.connect_status.value>0&&(pe.value=99,await ue(100)),fe.value=!1,pe.value=0,await ue(100),y.connect_status.value<0&&(oe.value="Connection failed",ve.value=!0)}}(),0!=y.isConnected.value){for(y.clone_fw_status.value=0,ie.value="Please wait...",fe.value=!0,y.progress_percent.value=0,pe.value=0,y.do_clone_fw(1,200),y.progress_percent.value=0;0==y.clone_fw_status.value;)await ue(100),ie.value=y.progress_body_text.value,pe.value=y.progress_percent.value;await ue(100),fe.value=!1,y.disconnect(),y.clone_fw_status.value>1?(2==y.clone_fw_status.value?ne.value=`A total of ${y.clone_fw_status.value-1} device was successfully cloned and its driver updated.`:ne.value=`A total of ${y.clone_fw_status.value-1} devices were successfully cloned and had their drivers updated.`,re.value=!0):(oe.value="No devices were cloned successfully.",ve.value=!0)}}let Ce;const Ue=t(!1),De=l({}),xe=t("");t("");const Le=t(""),Ee=s(()=>De.DUELink),Se=t(0),Te=s(()=>Ee.value?.versions?[...Ee.value.versions].sort((e,a)=>a.id-e.id):[]),Fe=s(()=>Te.value[Se.value]||null),Ae=t(!0);async function qe(){const e=Ee;await async function(e){try{0!==(await Be()).status&&(await Ce.controlTransferOut({requestType:"class",recipient:"interface",request:4,value:0,index:0}),await ue(100));const a=e.byteLength;await async function(e){se.value="Erasing...",ie.value=se.value;const a=Math.ceil(e/te);for(let t=0;t<a;t++){const e=le+t*te,l=new Uint8Array(5);l[0]=65,l[1]=255&e,l[2]=e>>8&255,l[3]=e>>16&255,l[4]=e>>24&255,await Pe(0,l),await Ie(),Oe(t,a)}se.value="Erased.",ie.value=se.value,Oe(0,100)}(a),pe.value=0,fe.value=!1,await ue(250),fe.value=!0,se.value="Writing...",ie.value=se.value;let t=new Uint8Array(5);t[0]=33,t[1]=0,t[2]=0,t[3]=0,t[4]=8,await Pe(0,t),await Ie();let l=0,s=2;for(;l<a;){const t=e.slice(l,l+1024);await Pe(s,t),await Ie(),l+=t.byteLength,s++,Oe(l,a)}await async function(){let e=new Uint8Array(5);try{return e[0]=33,e[1]=0,e[2]=0,e[3]=0,e[4]=8,await Pe(0,e),await Ie(),await Pe(0,new ArrayBuffer(0)),await Ie(),1}catch(a){}return 0}(),se.value="Completed"}catch(a){se.value="Failed"}ie.value=se.value}(e.image)}async function Me(){await async function(){try{Ue.value=!1,Ce=await navigator.usb.requestDevice({filters:[{vendorId:1155,productId:57105}]}),await Ce.open(),Ce.configuration||await Ce.selectConfiguration(1),await Ce.claimInterface(0),Ue.value=!0}catch(e){e.value="Connection error: "+e,Ue.value=!1}}(),Ue.value&&(pe.value=0,ie.value="Please wait...",fe.value=!0,await async function(){const e=Te?.value[Se.value],a=e?.url;try{const e=await fetch(a);if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.blob(),l=await t.arrayBuffer();Ee.image=l}catch(t){Ee.image=null}}(),await qe(),fe.value=!1,"Completed"==se.value?de.value=!0:(oe.value="Loading firmware failed!",ve.value=!0))}function Oe(e,a){pe.value=Math.round(e/a*100),pe.value}async function Pe(e,a){const t=await Ce.controlTransferOut({requestType:"class",recipient:"interface",request:1,value:e,index:0},a);if("ok"!==t.status)throw new Error("DNLOAD transfer failed at block "+e);return t}async function Be(){const e=await Ce.controlTransferIn({requestType:"class",recipient:"interface",request:3,value:0,index:0},6);if("ok"===e.status&&e.data&&6===e.data.byteLength){const a=new DataView(e.data.buffer);return{status:a.getUint8(0),pollTimeout:a.getUint8(1)|a.getUint8(2)<<8|a.getUint8(3)<<16,state:a.getUint8(4),iString:a.getUint8(5)}}throw new Error("Failed to read DFU status.")}async function Ie(){for(;;){const e=await Be();if(5===e.state||2===e.state)break;await ue(e.pollTimeout)}}return(e,a)=>(n(),i("div",D,[a[27]||(a[27]=o('<h1 class="title" data-v-3fe35612>DUELink Loader</h1><p class="subtitle" data-v-3fe35612> Update modules with official firmware and drivers! </p><hr class="divider" data-v-3fe35612><h2 class="section-title" data-v-3fe35612>Step 1 (Erase All)</h2><div class="card-container" data-v-3fe35612><div class="card" data-v-3fe35612><img src="'+C+'" alt="Module with USB" class="card-image" data-v-3fe35612><p class="card-text" data-v-3fe35612> Plug-in the USB cable directly... </p></div><div class="card" data-v-3fe35612><img src="'+U+'" alt="USB Hook" class="card-image" data-v-3fe35612><p class="card-text" data-v-3fe35612> ...or use an adapter on the Uplink connector. </p></div></div><p class="subtitle" data-v-3fe35612> Click the <strong data-v-3fe35612>Erase All</strong> button. The pop-up window should have a device named <em data-v-3fe35612>DUELink Official</em> or <em data-v-3fe35612>DUELink MicroBlocks</em>.<br data-v-3fe35612><br data-v-3fe35612> Select the device then click <strong data-v-3fe35612>Connect</strong>. </p><img src="'+_+'" alt="Select COM device" class="screenshot" data-v-3fe35612>',7)),u("div",x,[u("button",{class:"outline-button",onClick:a[0]||(a[0]=e=>async function(){if(y.eraseall_status_dms.value=0,0==y.isConnected.value){for(y.eraseall_vid_dms.value=0,y.connection_mode.value=2,await y.eraseall_dms_connect();0==y.eraseall_status_dms.value;)await ue(100);await ue(100)}if(0!=y.eraseall_vid_dms.value){let e=65535&y.eraseall_vid_dms.value;ge.value=62208==e?"DUELink "+ae:"MicroBlocks "+ae,ce.value=!0}}())}," Erase All ")]),a[28]||(a[28]=o('<p class="subtitle" data-v-3fe35612> If the pop-up window didn&#39;t show the needed device or if <strong data-v-3fe35612>Erase All</strong> failed, visit the <a href="https://www.duelink.com/docs/loader" target="_blank" data-v-3fe35612> loader documentation page</a>. </p><hr class="divider" data-v-3fe35612><h2 class="section-title" data-v-3fe35612>Step 2 (Load Firmware/Driver)</h2><p class="subtitle" data-v-3fe35612> This step will update the firmware on a single device, or on the first device in a chain. </p><p class="subtitle" data-v-3fe35612> Click the button below then select the <em data-v-3fe35612>DFU in FS Mode</em> device and click <strong data-v-3fe35612>Connect</strong>. </p><p class="subtitle" data-v-3fe35612> If using Windows, <a href="https://www.duelink.com/bin/usb-drivers/win-usb-dfu.zip" target="_blank" data-v-3fe35612>download</a> and install the DFU driver first. </p><img src="'+k+'" alt="DFU selection" class="screenshot" data-v-3fe35612>',7)),Ee.value?(n(),i("div",L,[a[6]||(a[6]=u("label",{for:"version-select"}," Select firmware version: ",-1)),r(u("select",{id:"version-select","onUpdate:modelValue":a[1]||(a[1]=e=>Se.value=e)},[(n(!0),i(d,null,f(Te.value,(e,a)=>(n(),i("option",{key:e.id,value:a},p(e.name),9,E))),128))],512),[[v,Se.value]])])):c("",!0),u("div",{class:"button-row"},[u("button",{class:"outline-button",onClick:Me}," Load DUELink Firmware/Driver "),a[7]||(a[7]=u("hr",{class:"divider"},null,-1)),a[8]||(a[8]=u("p",{class:"subtitle"},[w(" The update steps are now complete on a single device."),u("br"),u("br"),w(" Continue to step 3 if you have multiple devices in a chain that you want to update. ")],-1))]),a[29]||(a[29]=o('<hr class="divider" data-v-3fe35612><h2 class="section-title" data-v-3fe35612>Step 3 (Update Chain)</h2><p class="subtitle" data-v-3fe35612> This optional step is for updating all modules in a chain (Daisylink). </p><p class="subtitle" data-v-3fe35612> Click the <strong data-v-3fe35612>Load Driver Script</strong> button, then select the device. You should only see one named <em data-v-3fe35612>DUELink Official</em>. </p><img src="'+_+'" alt="COM selection" class="screenshot" data-v-3fe35612>',5)),u("div",{class:"button-row"},[u("button",{class:"outline-button",onClick:ke}," Update Chain ")]),ce.value?(n(),i("div",S,[u("div",T,[a[12]||(a[12]=u("div",{class:"dialog-title"},[u("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),w(" Warning ")],-1)),u("div",F,[u("p",null,[w(p(ge.value),1),a[9]||(a[9]=u("br",null,null,-1)),a[10]||(a[10]=u("br",null,null,-1)),w(p("Are you sure you want to erase all?")),a[11]||(a[11]=u("br",null,null,-1))])]),u("div",{class:"dialog-buttons"},[u("button",{class:"yes",onClick:he},"Yes"),u("button",{class:"no",onClick:me},"No")])])])):c("",!0),re.value?(n(),i("div",A,[u("div",q,[a[13]||(a[13]=u("div",{class:"dialog-title-success"},[u("i",{class:"fas fa-check-circle",style:{color:"green","margin-right":"8px"}}),w(" Success ")],-1)),u("div",M,[u("p",null,p(ne.value),1)]),u("div",O,[u("button",{class:"no",onClick:a[2]||(a[2]=e=>{re.value=!1})},"Close")])])])):c("",!0),ve.value?(n(),i("div",P,[u("div",B,[a[14]||(a[14]=u("div",{class:"dialog-title"},[u("i",{class:"fa-solid fa-triangle-exclamation",style:{color:"#f5c542","margin-right":"8px"}}),w(" Failed ")],-1)),u("div",I,[u("p",null,p(oe.value),1)]),u("div",j,[u("button",{class:"no",onClick:a[3]||(a[3]=e=>{ve.value=!1})},"Close")])])])):c("",!0),de.value?(n(),i("div",N,[u("div",W,[a[18]||(a[18]=u("div",{class:"dialog-title-success"},[u("i",{class:"fas fa-question-circle",style:{color:"white","margin-right":"8px"}}),w(" Success ")],-1)),u("div",Y,[u("p",null,[w(" Firmware "+p(Fe.value?.name)+" updated. ",1),a[15]||(a[15]=u("br",null,null,-1)),a[16]||(a[16]=u("br",null,null,-1)),a[17]||(a[17]=w("Do you want to load driver? ",-1))])]),u("div",R,[u("button",{class:"yes",onClick:ye},"Yes"),u("button",{class:"no",onClick:a[4]||(a[4]=e=>de.value=!1)},"No")])])])):c("",!0),we.value?(n(),i("div",V,[u("div",$,[a[25]||(a[25]=u("div",{class:"dialog-title"},[u("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),w(" Warning ")],-1)),u("div",H,[u("p",null,p(xe.value),1),u("p",{style:g({color:Ae.value?"#000000":"#d9534f"})},p(Le.value),5),!1===Ae.value?(n(),i("p",z,[a[19]||(a[19]=w(" (Recommend: ",-1)),u("button",{class:"link-button underline",onClick:a[5]||(a[5]=e=>{we.value=!1})}," Update "),a[20]||(a[20]=w(" to the latest firmware.) ",-1))])):c("",!0),a[24]||(a[24]=u("br",null,null,-1)),u("p",null,[a[21]||(a[21]=w("Do you want to load ",-1)),u("a",{target:"_blank",href:h(y).update_driver_path.value},"this driver",8,G),a[22]||(a[22]=w("?",-1)),a[23]||(a[23]=u("br",null,null,-1))])]),u("div",{class:"dialog-buttons"},[u("button",{class:"yes",onClick:be},"Yes"),u("button",{class:"no",onClick:_e},"No")])])])):c("",!0),fe.value?(n(),i("div",J,[u("div",K,[u("div",{class:m(["dialog-title",{"dialog-title-success":100===pe.value}])},[pe.value<100?(n(),i("i",Q)):c("",!0),w(" "+p((pe.value,ie.value)),1)],2),u("div",X,[a[26]||(a[26]=u("br",null,null,-1)),u("div",Z,[u("div",{class:"update-driver-progress-bar",style:g({width:pe.value+"%"})},null,4)]),u("div",ee,p(pe.value)+"% ",1)])])])):c("",!0)]))}},[["__scopeId","data-v-3fe35612"]])).mount("#app");
