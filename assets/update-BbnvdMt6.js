import{_ as e,e as a,o as t,c as l,a as s,f as i,w as n,v as o,g as u,r as c,h as r,i as v,t as d,n as p,u as w,j as f,b as g,F as m,k as h,l as y,m as b,d as _}from"./Footer-CqatApVj.js";import{_ as k,a as C}from"./console-connect-dfu-CrgV8XxQ.js";import{u as U}from"./useWebSerial-Beh64OSw.js";const D=""+new URL("../img/stamp-usb-connect.webp",import.meta.url).href,E=""+new URL("../img/usbhook-rgb3.webp",import.meta.url).href,L={class:"page"},F={key:0,class:"version-select"},x=["value"],T={key:1,class:"overlay"},S={class:"dialog"},A={class:"dialog-body"},j={key:2,class:"overlay"},q={class:"dialog"},M={class:"dialog-body"},O={class:"dialog-buttons"},B={key:3,class:"overlay"},I={class:"dialog"},N={class:"dialog-body"},W={class:"dialog-buttons"},P={key:4,class:"overlay"},Y={class:"dialog"},R={class:"dialog-body"},V={class:"dialog-buttons"},H={key:5,class:"overlay"},z={class:"dialog"},G={class:"dialog-body"},$={key:0,class:"firmware-warning"},J=["href"],K={key:6,class:"overlay"},Q={class:"dialog",style:{width:"25vw"}},X={key:0,class:"fas fa-exclamation-triangle",style:{"margin-right":"8px"}},Z={class:"dialog-body"},ee={class:"progress-text"},ae={key:0},te={class:"update-driver-progress-container"},le={class:"progress-text"},se={class:"dialog-buttons"},ie="Firmware detected.",ne=2048,oe=134217728;_(e({__name:"update",setup(e){const _=U();a(async()=>{await async function(){try{const e=await fetch("https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/duelink-fw.json"),a=await e.json();Object.keys(a).forEach(e=>{Se[e]=a[e],Se[e].isGlb=!1,Se[e].image=null})}catch(e){}}()});const ue=b(""),ce=b(""),re=b(""),ve=b(""),de=b("");function pe(e){return new Promise(a=>setTimeout(a,e))}const we=b(!1),fe=b(!1),ge=b(!1),me=b(!1),he=b(!1),ye=b(!1),be=b(0),_e=b(!1),ke=b(ie);async function Ce(){for(we.value=!1,_e.value=!1,be.value=0,re.value="Erase All",ce.value="Erasing....",he.value=!0,await _.eraseall_dms_execute();_.eraseall_status_dms.value<2;)await pe(250),be.value=50;be.value=100,re.value="Done",await pe(250),he.value=!1,ve.value="Erase all completed.",fe.value=!0}async function Ue(){we.value=!1,_.isConnected&&(await _.disconnect(),await pe(250))}async function De(){if(me.value=!1,!_.isConnected.value){_.device_name.value="",_.driver_ver.value="",_.progress_percent.value=0,be.value=0,_.update_driver_status.value=0,_.update_devaddr.value=1,_.connection_mode.value=1;if(await _.driver_connect()){for(re.value="Driver Update",ce.value="Connecting...",he.value=!0,be.value=0;0==_.update_driver_status.value;)await pe(100),be.value=_.progress_percent.value;if(await pe(100),1==_.update_driver_status.value){let e=!1;const a=Date.now()+4e3;for(;!(_.isConnected.value&&""!=_.device_name.value&&""!=_.driver_ver.value||(await pe(100),Date.now()>a));)be.value=_.progress_percent.value;_.isConnected.value&&Date.now()<a&&(e=!0),e&&(Ae.value="Device Name: "+_.device_name.value,je.value="Firmware Version: "+_.version.value,ye.value=!0,be.value=100,he.value=!1)}he.value=!1,be.value=0}}}async function Ee(){for(ye.value=!1,re.value="Driver Update",ce.value="Writing driver...",he.value=!0,_.progress_percent.value=0,be.value=0,_.driver_update();100!=_.progress_percent.value;)await pe(1),be.value=_.progress_percent.value;_.update_driver_status.value=0,await _.disconnect(),await pe(10),he.value=!1,ve.value="Load driver completed.",fe.value=!0}async function Le(){_.isConnected.value&&(_.disconnect(),await pe(100)),ye.value=!1}async function Fe(){if(_e.value=!1,re.value="Update Chain",ce.value="Please wait...",0==_.isConnected.value&&await async function(){if(_.connect_status.value=0,_.connection_mode.value=0,_.update_driver_status.value=0,be.value=0,_.progress_percent.value=0,await _.connect()){for(ce.value="Connecting to device 1...",he.value=!0,be.value=0;0==_.connect_status.value&&(await pe(100),be.value=_.progress_percent.value,71!=be.value););_.connect_status.value>0&&(be.value=99,await pe(100)),he.value=!1,be.value=0,await pe(100),_.connect_status.value<0&&(de.value="Connection failed",ge.value=!0)}}(),0!=_.isConnected.value){for(_.clone_fw_status.value=0,await pe(50),he.value=!0,_.progress_percent.value=0,be.value=0,_.do_clone_fw(1,200),_.progress_percent.value=0;0==_.clone_fw_status.value;)await pe(100),ce.value=_.progress_body_text.value,be.value=_.progress_percent.value;if(await pe(100),_.disconnect(),_.clone_fw_status.value>1){const e=ce.value.split("\n");e.pop(),ce.value=e.join("\n"),_e.value=!0}else he.value=!1,de.value="No devices were cloned successfully.",ge.value=!0}}let xe;const Te=b(!1),Se=h({}),Ae=b(""),je=b(""),qe=y(()=>Se.DUELink),Me=b(0),Oe=y(()=>qe.value?.versions?[...qe.value.versions].sort((e,a)=>a.id-e.id):[]),Be=y(()=>Oe.value[Me.value]||null),Ie=b(!0);async function Ne(){const e=qe;await async function(e){try{0!==(await Re()).status&&(await xe.controlTransferOut({requestType:"class",recipient:"interface",request:4,value:0,index:0}),await pe(100));const a=e.byteLength;await async function(e){ue.value="Erasing...",ce.value=ue.value;const a=Math.ceil(e/ne);for(let t=0;t<a;t++){const e=oe+t*ne,l=new Uint8Array(5);l[0]=65,l[1]=255&e,l[2]=e>>8&255,l[3]=e>>16&255,l[4]=e>>24&255,await Ye(0,l),await Ve(),Pe(t,a)}ue.value="Erased.",ce.value=ue.value,Pe(0,100)}(a),be.value=0,he.value=!1,await pe(250),he.value=!0,ue.value="Writing...",ce.value=ue.value;let t=new Uint8Array(5);t[0]=33,t[1]=0,t[2]=0,t[3]=0,t[4]=8,await Ye(0,t),await Ve();let l=0,s=2;for(;l<a;){const t=e.slice(l,l+1024);await Ye(s,t),await Ve(),l+=t.byteLength,s++,Pe(l,a)}await async function(){let e=new Uint8Array(5);try{return e[0]=33,e[1]=0,e[2]=0,e[3]=0,e[4]=8,await Ye(0,e),await Ve(),await Ye(0,new ArrayBuffer(0)),await Ve(),1}catch(a){}return 0}(),ue.value="Completed"}catch(a){ue.value="Failed"}ce.value=ue.value}(e.image)}async function We(){await async function(){try{Te.value=!1,xe=await navigator.usb.requestDevice({filters:[{vendorId:1155,productId:57105}]}),await xe.open(),xe.configuration||await xe.selectConfiguration(1),await xe.claimInterface(0),Te.value=!0}catch(e){e.value="Connection error: "+e,Te.value=!1}}(),Te.value&&(be.value=0,re.value="Firmware Update",ce.value="Fetching firmware url...",he.value=!0,await async function(){const e=Oe?.value[Me.value],a=e?.url;try{const e=await fetch(a);if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.blob(),l=await t.arrayBuffer();qe.image=l}catch(t){qe.image=null}}(),await Ne(),he.value=!1,"Completed"==ue.value?me.value=!0:(de.value="Loading firmware failed!",ge.value=!0))}function Pe(e,a){be.value=Math.round(e/a*100),be.value}async function Ye(e,a){const t=await xe.controlTransferOut({requestType:"class",recipient:"interface",request:1,value:e,index:0},a);if("ok"!==t.status)throw new Error("DNLOAD transfer failed at block "+e);return t}async function Re(){const e=await xe.controlTransferIn({requestType:"class",recipient:"interface",request:3,value:0,index:0},6);if("ok"===e.status&&e.data&&6===e.data.byteLength){const a=new DataView(e.data.buffer);return{status:a.getUint8(0),pollTimeout:a.getUint8(1)|a.getUint8(2)<<8|a.getUint8(3)<<16,state:a.getUint8(4),iString:a.getUint8(5)}}throw new Error("Failed to read DFU status.")}async function Ve(){for(;;){const e=await Re();if(5===e.state||2===e.state)break;await pe(e.pollTimeout)}}return(e,a)=>(t(),l("div",L,[a[27]||(a[27]=s('<h1 class="title" data-v-7417ec08>DUELink Loader</h1><p data-v-7417ec08> Update modules with official firmware and drivers! </p><hr data-v-7417ec08><h2 data-v-7417ec08>Step 1: Erase All</h2><div class="card-container" data-v-7417ec08><div class="card" data-v-7417ec08><img src="'+D+'" alt="Module with USB" class="card-image" data-v-7417ec08><p data-v-7417ec08> Plug-in the USB cable directly... </p></div><div class="card" data-v-7417ec08><img src="'+E+'" alt="USB Hook" class="card-image" data-v-7417ec08><p data-v-7417ec08> ...or use an adapter on the Uplink connector. </p></div></div><p data-v-7417ec08> Click the <strong data-v-7417ec08>Erase All</strong> button. The pop-up window should have a device named <em data-v-7417ec08>DUELink Official</em> or <em data-v-7417ec08>DUELink MicroBlocks</em>.<br data-v-7417ec08><br data-v-7417ec08> Select the device then click <strong data-v-7417ec08>Connect</strong>. </p><img src="'+k+'" alt="Select COM device" data-v-7417ec08>',7)),i("div",null,[i("button",{class:"outline-button",onClick:a[0]||(a[0]=e=>async function(){if(_.eraseall_status_dms.value=0,0==_.isConnected.value){for(_.eraseall_vid_dms.value=0,_.connection_mode.value=2,await _.eraseall_dms_connect();0==_.eraseall_status_dms.value;)await pe(100);await pe(100)}if(0!=_.eraseall_vid_dms.value){let e=65535&_.eraseall_vid_dms.value;ke.value=62208==e?"DUELink "+ie:"MicroBlocks "+ie,we.value=!0}}())}," Erase All ")]),a[28]||(a[28]=s('<p data-v-7417ec08> If the pop-up window didn&#39;t show the needed device or if <strong data-v-7417ec08>Erase All</strong> failed, your device might already be erased. Try Step 2 or visit the <a href="https://www.duelink.com/docs/loader" target="_blank" data-v-7417ec08>loader documentation page</a>. </p><hr data-v-7417ec08><h2 data-v-7417ec08>Step 2: Load Firmware/Driver</h2><p data-v-7417ec08> This step will update the firmware on a single device, or on the first device in a chain. </p><p data-v-7417ec08> Click the button below then select the <em data-v-7417ec08>DFU in FS Mode</em> device and click <strong data-v-7417ec08>Connect</strong>. </p><p data-v-7417ec08> If using Windows, <a href="https://www.duelink.com/bin/usb-drivers/win-usb-dfu.zip" target="_blank" data-v-7417ec08>download</a> and install the DFU driver first. </p><img src="'+C+'" alt="DFU selection" data-v-7417ec08>',7)),qe.value?(t(),l("div",F,[a[7]||(a[7]=i("label",{for:"version-select"}," Select DUELink firmware version: ",-1)),n(i("select",{id:"version-select","onUpdate:modelValue":a[1]||(a[1]=e=>Me.value=e)},[(t(!0),l(u,null,c(Oe.value,(e,a)=>(t(),l("option",{key:e.id,value:a},d(e.name),9,x))),128))],512),[[o,Me.value]])])):r("",!0),i("div",null,[i("button",{class:"outline-button",onClick:We}," Load DUELink Firmware/Driver "),a[8]||(a[8]=i("p",null,[v(" The update steps are now complete on a single device."),i("br"),i("br"),v(" Continue to step 3 if you have multiple devices in a chain that you want to update. ")],-1))]),a[29]||(a[29]=i("hr",null,null,-1)),a[30]||(a[30]=i("h2",null,"Step 3: Update Chain",-1)),a[31]||(a[31]=i("p",null," This optional step uses the first module to update all other modules in a chain (Daisylink). ",-1)),a[32]||(a[32]=i("p",null,[v(" Click the "),i("strong",null,"Update Chain"),v(" button, then select the device. You should only see one named "),i("em",null,"DUELink Official"),v(". ")],-1)),a[33]||(a[33]=i("img",{src:k,alt:"COM selection"},null,-1)),i("div",null,[i("button",{class:"outline-button",onClick:Fe}," Update Chain ")]),a[34]||(a[34]=i("p",null,[v(" For any issues, consult the "),i("a",{href:"https://www.duelink.com/docs/loader",target:"_blank"}," loader documentation"),v(" page. ")],-1)),we.value?(t(),l("div",T,[i("div",S,[a[12]||(a[12]=i("div",{class:"dialog-title"},[i("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),v(" Warning ")],-1)),i("div",A,[i("p",null,[v(d(ke.value),1),a[9]||(a[9]=i("br",null,null,-1)),a[10]||(a[10]=i("br",null,null,-1)),v(d("Are you sure you want to erase all?")),a[11]||(a[11]=i("br",null,null,-1))])]),i("div",{class:"dialog-buttons"},[i("button",{class:"yes",onClick:Ce},"Yes"),i("button",{class:"no",onClick:Ue},"No")])])])):r("",!0),fe.value?(t(),l("div",j,[i("div",q,[a[13]||(a[13]=i("div",{class:"dialog-title-success"},[i("i",{class:"fas fa-check-circle",style:{color:"green","margin-right":"8px"}}),v(" Success ")],-1)),i("div",M,[i("p",null,d(ve.value),1)]),i("div",O,[i("button",{class:"no",onClick:a[2]||(a[2]=e=>{fe.value=!1})},"Close")])])])):r("",!0),ge.value?(t(),l("div",B,[i("div",I,[a[14]||(a[14]=i("div",{class:"dialog-title"},[i("i",{class:"fa-solid fa-triangle-exclamation",style:{color:"#f5c542","margin-right":"8px"}}),v(" Failed ")],-1)),i("div",N,[i("p",null,d(de.value),1)]),i("div",W,[i("button",{class:"no",onClick:a[3]||(a[3]=e=>{ge.value=!1})},"Close")])])])):r("",!0),me.value?(t(),l("div",P,[i("div",Y,[a[18]||(a[18]=i("div",{class:"dialog-title-success"},[i("i",{class:"fas fa-question-circle",style:{color:"white","margin-right":"8px"}}),v(" Success ")],-1)),i("div",R,[i("p",null,[v(" Firmware "+d(Be.value?.name)+" updated. ",1),a[15]||(a[15]=i("br",null,null,-1)),a[16]||(a[16]=i("br",null,null,-1)),a[17]||(a[17]=v("Do you want to load driver? ",-1))])]),i("div",V,[i("button",{class:"yes",onClick:De},"Yes"),i("button",{class:"no",onClick:a[4]||(a[4]=e=>me.value=!1)},"No")])])])):r("",!0),ye.value?(t(),l("div",H,[i("div",z,[a[25]||(a[25]=i("div",{class:"dialog-title"},[i("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),v(" Warning ")],-1)),i("div",G,[i("p",null,d(Ae.value),1),i("p",{style:p({color:Ie.value?"#000000":"#d9534f"})},d(je.value),5),!1===Ie.value?(t(),l("p",$,[a[19]||(a[19]=v(" (Recommend: ",-1)),i("button",{class:"link-button underline",onClick:a[5]||(a[5]=e=>{ye.value=!1})}," Update "),a[20]||(a[20]=v(" to the latest firmware.) ",-1))])):r("",!0),a[24]||(a[24]=i("br",null,null,-1)),i("p",null,[a[21]||(a[21]=v("Do you want to load ",-1)),i("a",{target:"_blank",href:w(_).update_driver_path.value},"this driver",8,J),a[22]||(a[22]=v("?",-1)),a[23]||(a[23]=i("br",null,null,-1))])]),i("div",{class:"dialog-buttons"},[i("button",{class:"yes",onClick:Ee},"Yes"),i("button",{class:"no",onClick:Le},"No")])])])):r("",!0),he.value?(t(),l("div",K,[i("div",Q,[i("div",{class:f(["dialog-title",{"dialog-title-success":!0===_e.value}])},[be.value<100?(t(),l("i",X)):r("",!0),v(" "+d((be.value,re.value)),1)],2),i("div",Z,[i("div",ee,d(ce.value),1),a[26]||(a[26]=i("br",null,null,-1)),_e.value?r("",!0):(t(),l("div",ae,[i("div",te,[i("div",{class:"update-driver-progress-bar",style:p({width:be.value+"%"})},null,4)]),i("div",le,d(be.value)+"% ",1)])),i("div",se,[_e.value?(t(),l("button",{key:0,class:"no",onClick:a[6]||(a[6]=e=>{he.value=!1,_e.value=!1})}," Close ")):r("",!0)])])])])):r("",!0),g(m)]))}},[["__scopeId","data-v-7417ec08"]])).mount("#app");
