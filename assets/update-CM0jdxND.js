import{_ as e,d as a,r as t,e as l,f as s,c as i,o as n,a as c,g as o,h as u,w as r,v,F as d,i as f,j as w,t as p,n as g,u as h,k as y,b as m}from"./_plugin-vue_export-helper-DDmiMxIv.js";import{u as _,_ as b,a as k}from"./useWebSerial-DcG7QIqv.js";const C=""+new URL("../img/usbhook-rgb3.webp",import.meta.url).href,U={class:"page"},D={class:"button-row"},x={key:0,class:"version-select"},E=["value"],L={key:1,class:"overlay"},S={class:"dialog"},F={class:"dialog-body"},T={key:2,class:"overlay"},A={class:"dialog"},B={class:"dialog-body"},I={class:"dialog-buttons"},q={key:3,class:"overlay"},P={class:"dialog"},j={class:"dialog-body"},M={class:"dialog-buttons"},N={key:4,class:"overlay"},O={class:"dialog"},W={class:"dialog-body"},Y={class:"dialog-buttons"},H={key:5,class:"overlay"},V={class:"dialog"},$={class:"dialog-body"},R={key:0,class:"firmware-warning"},z=["href"],G={key:6,class:"overlay"},J={class:"dialog",style:{width:"25vw"}},K={key:0,class:"fas fa-exclamation-triangle",style:{"margin-right":"8px"}},Q={class:"dialog-body"},X={class:"update-driver-progress-container"},Z={class:"progress-text"},ee="Firmware detected.",ae=2048,te=134217728;m(e({__name:"update",setup(e){const m=_();a(async()=>{await async function(){try{const e=await fetch("https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/duelink-fw.json"),a=await e.json();Object.keys(a).forEach(e=>{Ue[e]=a[e],Ue[e].isGlb=!1,Ue[e].image=null})}catch(e){}}()}),t("");const le=t(""),se=t(""),ie=t(""),ne=t("");function ce(e){return new Promise(a=>setTimeout(a,e))}const oe=t(!1),ue=t(!1),re=t(!1),ve=t(!1),de=t(!1),fe=t(!1),we=t(0),pe=t(ee);async function ge(){for(oe.value=!1,we.value=0,se.value="Please wait...",de.value=!0,await m.eraseall_dms_execute();m.eraseall_status_dms.value<2;)await ce(250),we.value=50;we.value=100,se.value="Done",await ce(250),de.value=!1,ie.value="Erase all completed.",ue.value=!0}async function he(){oe.value=!1,m.isConnected&&(await m.disconnect(),await ce(250))}async function ye(){if(ve.value=!1,!m.isConnected.value){m.device_name.value="",m.driver_ver.value="",m.progress_percent.value=0,we.value=0,m.update_driver_status.value=0,m.update_devaddr.value=1,m.connection_mode.value=1;if(await m.driver_connect()){for(se.value="Please wait...",de.value=!0,we.value=0;0==m.update_driver_status.value;)await ce(100),we.value=m.progress_percent.value;if(await ce(100),1==m.update_driver_status.value){let e=!1;const a=Date.now()+4e3;for(;!(m.isConnected.value&&""!=m.device_name.value&&""!=m.driver_ver.value||(await ce(100),Date.now()>a));)we.value=m.progress_percent.value;m.isConnected.value&&Date.now()<a&&(e=!0),e&&(se.value="Connected",De.value="Device Name: "+m.device_name.value,xe.value="Firmware Version: "+m.version.value,fe.value=!0,we.value=100,de.value=!1)}de.value=!1,we.value=0}}}async function me(){for(fe.value=!1,se.value="Please wait...",de.value=!0,m.progress_percent.value=0,we.value=0,m.driver_update();100!=m.progress_percent.value;)await ce(1),we.value=m.progress_percent.value;m.update_driver_status.value=0,await m.disconnect(),await ce(10),de.value=!1,ie.value="Load driver completed.",ue.value=!0}async function _e(){m.isConnected.value&&(m.disconnect(),await ce(100)),fe.value=!1}async function be(){if(0==m.isConnected.value&&await async function(){if(m.connect_status.value=0,m.connection_mode.value=0,m.update_driver_status.value=0,we.value=0,m.progress_percent.value=0,await m.connect()){for(se.value="Please wait while connecting...",de.value=!0,we.value=0;0==m.connect_status.value&&(await ce(100),we.value=m.progress_percent.value,71!=we.value););m.connect_status.value>0&&(we.value=99,await ce(100)),de.value=!1,we.value=0,await ce(100),m.connect_status.value<0&&(ne.value="Connection failed",re.value=!0)}}(),0!=m.isConnected.value){for(m.clone_fw_status.value=0,se.value="Please wait...",de.value=!0,m.progress_percent.value=0,we.value=0,m.do_clone_fw(1,3),m.progress_percent.value=0;0==m.clone_fw_status.value;)await ce(100),se.value=m.progress_body_text.value,we.value=m.progress_percent.value;await ce(100),de.value=!1,m.disconnect(),m.clone_fw_status.value>1?(2==m.clone_fw_status.value?ie.value=`A total of ${m.clone_fw_status.value-1} device was successfully cloned and its driver updated.`:ie.value=`A total of ${m.clone_fw_status.value-1} devices were successfully cloned and had their drivers updated.`,ue.value=!0):(ne.value="No devices were cloned successfully.",re.value=!0)}}let ke;const Ce=t(!1),Ue=l({}),De=t("");t("");const xe=t(""),Ee=s(()=>Ue.DUELink),Le=t(0),Se=s(()=>Ee.value?.versions?[...Ee.value.versions].sort((e,a)=>a.id-e.id):[]),Fe=s(()=>Se.value[Le.value]||null),Te=t(!0);async function Ae(){const e=Ee;await async function(e){try{0!==(await Pe()).status&&(await ke.controlTransferOut({requestType:"class",recipient:"interface",request:4,value:0,index:0}),await ce(100));const a=e.byteLength;await async function(e){le.value="Erasing...",se.value=le.value;const a=Math.ceil(e/ae);for(let t=0;t<a;t++){const e=te+t*ae,l=new Uint8Array(5);l[0]=65,l[1]=255&e,l[2]=e>>8&255,l[3]=e>>16&255,l[4]=e>>24&255,await qe(0,l),await je(),Ie(t,a)}le.value="Erased.",se.value=le.value,Ie(0,100)}(a),we.value=0,de.value=!1,await ce(250),de.value=!0,le.value="Writing...",se.value=le.value;let t=new Uint8Array(5);t[0]=33,t[1]=0,t[2]=0,t[3]=0,t[4]=8,await qe(0,t),await je();let l=0,s=2;for(;l<a;){const t=e.slice(l,l+1024);await qe(s,t),await je(),l+=t.byteLength,s++,Ie(l,a)}await async function(){let e=new Uint8Array(5);try{return e[0]=33,e[1]=0,e[2]=0,e[3]=0,e[4]=8,await qe(0,e),await je(),await qe(0,new ArrayBuffer(0)),await je(),1}catch(a){}return 0}(),le.value="Completed"}catch(a){le.value="Failed"}se.value=le.value}(e.image)}async function Be(){await async function(){try{Ce.value=!1,ke=await navigator.usb.requestDevice({filters:[{vendorId:1155,productId:57105}]}),await ke.open(),ke.configuration||await ke.selectConfiguration(1),await ke.claimInterface(0),Ce.value=!0}catch(e){e.value="Connection error: "+e,Ce.value=!1}}(),Ce.value&&(we.value=0,se.value="Please wait...",de.value=!0,await async function(){const e=Se?.value[Le.value],a=e?.url;try{const e=await fetch(a);if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.blob(),l=await t.arrayBuffer();Ee.image=l}catch(t){Ee.image=null}}(),await Ae(),de.value=!1,"Completed"==le.value&&(ve.value=!0))}function Ie(e,a){we.value=Math.round(e/a*100),we.value}async function qe(e,a){const t=await ke.controlTransferOut({requestType:"class",recipient:"interface",request:1,value:e,index:0},a);if("ok"!==t.status)throw new Error("DNLOAD transfer failed at block "+e);return t}async function Pe(){const e=await ke.controlTransferIn({requestType:"class",recipient:"interface",request:3,value:0,index:0},6);if("ok"===e.status&&e.data&&6===e.data.byteLength){const a=new DataView(e.data.buffer);return{status:a.getUint8(0),pollTimeout:a.getUint8(1)|a.getUint8(2)<<8|a.getUint8(3)<<16,state:a.getUint8(4),iString:a.getUint8(5)}}throw new Error("Failed to read DFU status.")}async function je(){for(;;){const e=await Pe();if(5===e.state||2===e.state)break;await ce(e.pollTimeout)}}return(e,a)=>(n(),i("div",U,[a[27]||(a[27]=c('<h1 class="title" data-v-c34e19f7>DUELink Loader</h1><p class="subtitle" data-v-c34e19f7> This page will help in updating DUELink firmware and its related Driver. </p><hr class="divider" data-v-c34e19f7><h2 class="section-title" data-v-c34e19f7>Step 1 (Erase All)</h2><div class="card-container" data-v-c34e19f7><div class="card" data-v-c34e19f7><img src="'+b+'" alt="Module with USB" class="card-image" data-v-c34e19f7><p class="card-text" data-v-c34e19f7> If your module has a USB connector, just plug it in! </p></div><div class="card" data-v-c34e19f7><img src="'+C+'" alt="USB Hook" class="card-image" data-v-c34e19f7><p class="card-text" data-v-c34e19f7> If your module has a <code data-v-c34e19f7>U</code> Uplink connector, you need a USB adaptor, like USB Hook. </p></div></div><p class="subtitle" data-v-c34e19f7> Click the <strong data-v-c34e19f7>Erase All</strong> button, then select the device. You should only see one named <em data-v-c34e19f7>DUELink Official</em> or <em data-v-c34e19f7>DUELink MicroBlocks</em>. </p><img src="'+k+'" alt="Select DFU device" class="screenshot" data-v-c34e19f7>',7)),o("div",D,[o("button",{class:"outline-button",onClick:a[0]||(a[0]=e=>async function(){if(m.eraseall_status_dms.value=0,0==m.isConnected.value){for(m.eraseall_vid_dms.value=0,m.connection_mode.value=2,await m.eraseall_dms_connect();0==m.eraseall_status_dms.value;)await ce(100);await ce(100)}if(0!=m.eraseall_vid_dms.value){let e=65535&m.eraseall_vid_dms.value;pe.value=62208==e?"DUELink "+ee:"MicroBlocks "+ee,oe.value=!0}}())}," Erase All ")]),a[28]||(a[28]=c('<p class="subtitle" data-v-c34e19f7> If <strong data-v-c34e19f7>Erase All</strong> failed, visit the <a href="https://www.duelink.com/docs/loader" target="_blank" data-v-c34e19f7> loader documentation page </a>. </p><hr class="divider" data-v-c34e19f7><h2 class="section-title" data-v-c34e19f7>Step 2 (Load Firmware/Driver)</h2><p class="subtitle" data-v-c34e19f7> This step will update the firmware on a single device, or on the first device in a chain. </p><p class="subtitle" data-v-c34e19f7> Click the button below then select the <em data-v-c34e19f7>DFU in FS Mode</em> device and click <strong data-v-c34e19f7>Connect</strong>. </p><p class="subtitle" data-v-c34e19f7> If using Windows, <a href="https://www.duelink.com/bin/usb-drivers/win-usb-dfu.zip" target="_blank" data-v-c34e19f7>download</a> and install the DFU driver first. </p><img src="'+k+'" alt="DFU selection" class="screenshot" data-v-c34e19f7>',7)),Ee.value?(n(),i("div",x,[a[6]||(a[6]=o("label",{for:"version-select"}," Select firmware version: ",-1)),r(o("select",{id:"version-select","onUpdate:modelValue":a[1]||(a[1]=e=>Le.value=e)},[(n(!0),i(d,null,f(Se.value,(e,a)=>(n(),i("option",{key:e.id,value:a},p(e.name),9,E))),128))],512),[[v,Le.value]])])):u("",!0),o("div",{class:"button-row"},[o("button",{class:"outline-button",onClick:Be}," Load DUELink Firmware/Driver "),a[7]||(a[7]=o("hr",{class:"divider"},null,-1)),a[8]||(a[8]=o("p",{class:"subtitle"},[w(" The update steps are now complete on a single device."),o("br"),o("br"),w(" Continue to step 3 if you have multiple devices in a chain that you want to update. ")],-1))]),a[29]||(a[29]=c('<hr class="divider" data-v-c34e19f7><h2 class="section-title" data-v-c34e19f7>Step 3 (Update Chain)</h2><p class="subtitle" data-v-c34e19f7> This optional step is for updating all modules in a chain (Daisylink). </p><p class="subtitle" data-v-c34e19f7> Click the <strong data-v-c34e19f7>Load Driver Script</strong> button, then select the device. You should only see one named <em data-v-c34e19f7>DUELink Official</em>. </p><img src="'+k+'" alt="Driver selection" class="screenshot" data-v-c34e19f7>',5)),o("div",{class:"button-row"},[o("button",{class:"outline-button",onClick:be}," Update Chain ")]),oe.value?(n(),i("div",L,[o("div",S,[a[12]||(a[12]=o("div",{class:"dialog-title"},[o("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),w(" Warning ")],-1)),o("div",F,[o("p",null,[w(p(pe.value),1),a[9]||(a[9]=o("br",null,null,-1)),a[10]||(a[10]=o("br",null,null,-1)),w(p("Are you sure you want to erase all?")),a[11]||(a[11]=o("br",null,null,-1))])]),o("div",{class:"dialog-buttons"},[o("button",{class:"yes",onClick:ge},"Yes"),o("button",{class:"no",onClick:he},"No")])])])):u("",!0),ue.value?(n(),i("div",T,[o("div",A,[a[13]||(a[13]=o("div",{class:"dialog-title-success"},[o("i",{class:"fas fa-check-circle",style:{color:"green","margin-right":"8px"}}),w(" Success ")],-1)),o("div",B,[o("p",null,p(ie.value),1)]),o("div",I,[o("button",{class:"no",onClick:a[2]||(a[2]=e=>{ue.value=!1})},"Close")])])])):u("",!0),re.value?(n(),i("div",q,[o("div",P,[a[14]||(a[14]=o("div",{class:"dialog-title"},[o("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),w(" Failed ")],-1)),o("div",j,[o("p",null,p(ne.value),1)]),o("div",M,[o("button",{class:"no",onClick:a[3]||(a[3]=e=>{re.value=!1})},"Close")])])])):u("",!0),ve.value?(n(),i("div",N,[o("div",O,[a[18]||(a[18]=o("div",{class:"dialog-title-success"},[o("i",{class:"fas fa-question-circle",style:{color:"white","margin-right":"8px"}}),w(" Success ")],-1)),o("div",W,[o("p",null,[w(" Firmware "+p(Fe.value?.name)+" updated. ",1),a[15]||(a[15]=o("br",null,null,-1)),a[16]||(a[16]=o("br",null,null,-1)),a[17]||(a[17]=w("Do you want to load driver? ",-1))])]),o("div",Y,[o("button",{class:"yes",onClick:ye},"Yes"),o("button",{class:"no",onClick:a[4]||(a[4]=e=>ve.value=!1)},"No")])])])):u("",!0),fe.value?(n(),i("div",H,[o("div",V,[a[25]||(a[25]=o("div",{class:"dialog-title"},[o("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),w(" Warning ")],-1)),o("div",$,[o("p",null,p(De.value),1),o("p",{style:g({color:Te.value?"#000000":"#d9534f"})},p(xe.value),5),!1===Te.value?(n(),i("p",R,[a[19]||(a[19]=w(" (Recommend: ",-1)),o("button",{class:"link-button underline",onClick:a[5]||(a[5]=e=>{fe.value=!1})}," Update "),a[20]||(a[20]=w(" to the latest firmware.) ",-1))])):u("",!0),a[24]||(a[24]=o("br",null,null,-1)),o("p",null,[a[21]||(a[21]=w("Do you want to load ",-1)),o("a",{target:"_blank",href:h(m).update_driver_path.value},"this driver",8,z),a[22]||(a[22]=w("?",-1)),a[23]||(a[23]=o("br",null,null,-1))])]),o("div",{class:"dialog-buttons"},[o("button",{class:"yes",onClick:me},"Yes"),o("button",{class:"no",onClick:_e},"No")])])])):u("",!0),de.value?(n(),i("div",G,[o("div",J,[o("div",{class:y(["dialog-title",{"dialog-title-success":100===we.value}])},[we.value<100?(n(),i("i",K)):u("",!0),w(" "+p((we.value,se.value)),1)],2),o("div",Q,[a[26]||(a[26]=o("br",null,null,-1)),o("div",X,[o("div",{class:"update-driver-progress-bar",style:g({width:we.value+"%"})},null,4)]),o("div",Z,p(we.value)+"% ",1)])])])):u("",!0)]))}},[["__scopeId","data-v-c34e19f7"]])).mount("#app");
