import{_ as a,d as e,o as t,c as l,a as s,e as i,w as n,v as u,F as o,r,f as d,g as c,t as v,n as f,u as p,h as w,i as g,j as h,k as m,b as y}from"./_plugin-vue_export-helper-C4YAnmRp.js";import{u as _,_ as b,a as k}from"./useWebSerial-nrh-lQ6J.js";const C=""+new URL("../img/stamp-usb-connect.webp",import.meta.url).href,U=""+new URL("../img/usbhook-rgb3.webp",import.meta.url).href,D={class:"page"},E={key:0,class:"version-select"},L=["value"],x={key:1,class:"overlay"},F={class:"dialog"},S={class:"dialog-body"},T={key:2,class:"overlay"},A={class:"dialog"},q={class:"dialog-body"},M={class:"dialog-buttons"},O={key:3,class:"overlay"},B={class:"dialog"},I={class:"dialog-body"},j={class:"dialog-buttons"},N={key:4,class:"overlay"},W={class:"dialog"},P={class:"dialog-body"},Y={class:"dialog-buttons"},R={key:5,class:"overlay"},V={class:"dialog"},$={class:"dialog-body"},H={key:0,class:"firmware-warning"},z=["href"],G={key:6,class:"overlay"},J={class:"dialog",style:{width:"25vw"}},K={key:0,class:"fas fa-exclamation-triangle",style:{"margin-right":"8px"}},Q={class:"dialog-body"},X={class:"progress-text"},Z={class:"update-driver-progress-container"},aa={class:"progress-text"},ea="Firmware detected.",ta=2048,la=134217728;y(a({__name:"update",setup(a){const y=_();e(async()=>{await async function(){try{const a=await fetch("https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/duelink-fw.json"),e=await a.json();Object.keys(e).forEach(a=>{Ea[a]=e[a],Ea[a].isGlb=!1,Ea[a].image=null})}catch(a){}}()});const sa=m(""),ia=m(""),na=m(""),ua=m(""),oa=m("");function ra(a){return new Promise(e=>setTimeout(e,a))}const da=m(!1),ca=m(!1),va=m(!1),fa=m(!1),pa=m(!1),wa=m(!1),ga=m(0),ha=m(ea);async function ma(){for(da.value=!1,ga.value=0,na.value="Erase All",ia.value="Erasing....",pa.value=!0,await y.eraseall_dms_execute();y.eraseall_status_dms.value<2;)await ra(250),ga.value=50;ga.value=100,na.value="Done",await ra(250),pa.value=!1,ua.value="Erase all completed.",ca.value=!0}async function ya(){da.value=!1,y.isConnected&&(await y.disconnect(),await ra(250))}async function _a(){if(fa.value=!1,!y.isConnected.value){y.device_name.value="",y.driver_ver.value="",y.progress_percent.value=0,ga.value=0,y.update_driver_status.value=0,y.update_devaddr.value=1,y.connection_mode.value=1;if(await y.driver_connect()){for(na.value="Driver Update",ia.value="Connecting...",pa.value=!0,ga.value=0;0==y.update_driver_status.value;)await ra(100),ga.value=y.progress_percent.value;if(await ra(100),1==y.update_driver_status.value){let a=!1;const e=Date.now()+4e3;for(;!(y.isConnected.value&&""!=y.device_name.value&&""!=y.driver_ver.value||(await ra(100),Date.now()>e));)ga.value=y.progress_percent.value;y.isConnected.value&&Date.now()<e&&(a=!0),a&&(La.value="Device Name: "+y.device_name.value,xa.value="Firmware Version: "+y.version.value,wa.value=!0,ga.value=100,pa.value=!1)}pa.value=!1,ga.value=0}}}async function ba(){for(wa.value=!1,na.value="Driver Update",ia.value="Writing driver...",pa.value=!0,y.progress_percent.value=0,ga.value=0,y.driver_update();100!=y.progress_percent.value;)await ra(1),ga.value=y.progress_percent.value;y.update_driver_status.value=0,await y.disconnect(),await ra(10),pa.value=!1,ua.value="Load driver completed.",ca.value=!0}async function ka(){y.isConnected.value&&(y.disconnect(),await ra(100)),wa.value=!1}async function Ca(){if(na.value="Update Chain",0==y.isConnected.value&&await async function(){if(y.connect_status.value=0,y.connection_mode.value=0,y.update_driver_status.value=0,ga.value=0,y.progress_percent.value=0,await y.connect()){for(ia.value="Connecting to device 1...",pa.value=!0,ga.value=0;0==y.connect_status.value&&(await ra(100),ga.value=y.progress_percent.value,71!=ga.value););y.connect_status.value>0&&(ga.value=99,await ra(100)),pa.value=!1,ga.value=0,await ra(100),y.connect_status.value<0&&(oa.value="Connection failed",va.value=!0)}}(),0!=y.isConnected.value){for(y.clone_fw_status.value=0,ia.value="Please wait...",pa.value=!0,y.progress_percent.value=0,ga.value=0,y.do_clone_fw(1,200),y.progress_percent.value=0;0==y.clone_fw_status.value;)await ra(100),ia.value=y.progress_body_text.value,ga.value=y.progress_percent.value;await ra(100),pa.value=!1,y.disconnect(),y.clone_fw_status.value>1?(2==y.clone_fw_status.value?ua.value=`A total of ${y.clone_fw_status.value-1} device was successfully cloned and its driver updated.`:ua.value=`A total of ${y.clone_fw_status.value-1} devices were successfully cloned and had their drivers updated.`,ca.value=!0):(oa.value="No devices were cloned successfully.",va.value=!0)}}let Ua;const Da=m(!1),Ea=g({}),La=m(""),xa=m(""),Fa=h(()=>Ea.DUELink),Sa=m(0),Ta=h(()=>Fa.value?.versions?[...Fa.value.versions].sort((a,e)=>e.id-a.id):[]),Aa=h(()=>Ta.value[Sa.value]||null),qa=m(!0);async function Ma(){const a=Fa;await async function(a){try{0!==(await ja()).status&&(await Ua.controlTransferOut({requestType:"class",recipient:"interface",request:4,value:0,index:0}),await ra(100));const e=a.byteLength;await async function(a){sa.value="Erasing...",ia.value=sa.value;const e=Math.ceil(a/ta);for(let t=0;t<e;t++){const a=la+t*ta,l=new Uint8Array(5);l[0]=65,l[1]=255&a,l[2]=a>>8&255,l[3]=a>>16&255,l[4]=a>>24&255,await Ia(0,l),await Na(),Ba(t,e)}sa.value="Erased.",ia.value=sa.value,Ba(0,100)}(e),ga.value=0,pa.value=!1,await ra(250),pa.value=!0,sa.value="Writing...",ia.value=sa.value;let t=new Uint8Array(5);t[0]=33,t[1]=0,t[2]=0,t[3]=0,t[4]=8,await Ia(0,t),await Na();let l=0,s=2;for(;l<e;){const t=a.slice(l,l+1024);await Ia(s,t),await Na(),l+=t.byteLength,s++,Ba(l,e)}await async function(){let a=new Uint8Array(5);try{return a[0]=33,a[1]=0,a[2]=0,a[3]=0,a[4]=8,await Ia(0,a),await Na(),await Ia(0,new ArrayBuffer(0)),await Na(),1}catch(e){}return 0}(),sa.value="Completed"}catch(e){sa.value="Failed"}ia.value=sa.value}(a.image)}async function Oa(){await async function(){try{Da.value=!1,Ua=await navigator.usb.requestDevice({filters:[{vendorId:1155,productId:57105}]}),await Ua.open(),Ua.configuration||await Ua.selectConfiguration(1),await Ua.claimInterface(0),Da.value=!0}catch(a){a.value="Connection error: "+a,Da.value=!1}}(),Da.value&&(ga.value=0,na.value="Firmware Update",ia.value="Fetching firmware url...",pa.value=!0,await async function(){const a=Ta?.value[Sa.value],e=a?.url;try{const a=await fetch(e);if(!a.ok)throw new Error(`HTTP ${a.status}`);const t=await a.blob(),l=await t.arrayBuffer();Fa.image=l}catch(t){Fa.image=null}}(),await Ma(),pa.value=!1,"Completed"==sa.value?fa.value=!0:(oa.value="Loading firmware failed!",va.value=!0))}function Ba(a,e){ga.value=Math.round(a/e*100),ga.value}async function Ia(a,e){const t=await Ua.controlTransferOut({requestType:"class",recipient:"interface",request:1,value:a,index:0},e);if("ok"!==t.status)throw new Error("DNLOAD transfer failed at block "+a);return t}async function ja(){const a=await Ua.controlTransferIn({requestType:"class",recipient:"interface",request:3,value:0,index:0},6);if("ok"===a.status&&a.data&&6===a.data.byteLength){const e=new DataView(a.data.buffer);return{status:e.getUint8(0),pollTimeout:e.getUint8(1)|e.getUint8(2)<<8|e.getUint8(3)<<16,state:e.getUint8(4),iString:e.getUint8(5)}}throw new Error("Failed to read DFU status.")}async function Na(){for(;;){const a=await ja();if(5===a.state||2===a.state)break;await ra(a.pollTimeout)}}return(a,e)=>(t(),l("div",D,[e[26]||(e[26]=s('<h1 class="title" data-v-695dfd44>DUELink Loader</h1><p data-v-695dfd44> Update modules with official firmware and drivers! </p><hr data-v-695dfd44><h2 data-v-695dfd44>Step 1: Erase All</h2><div class="card-container" data-v-695dfd44><div class="card" data-v-695dfd44><img src="'+C+'" alt="Module with USB" class="card-image" data-v-695dfd44><p data-v-695dfd44> Plug-in the USB cable directly... </p></div><div class="card" data-v-695dfd44><img src="'+U+'" alt="USB Hook" class="card-image" data-v-695dfd44><p data-v-695dfd44> ...or use an adapter on the Uplink connector. </p></div></div><p data-v-695dfd44> Click the <strong data-v-695dfd44>Erase All</strong> button. The pop-up window should have a device named <em data-v-695dfd44>DUELink Official</em> or <em data-v-695dfd44>DUELink MicroBlocks</em>.<br data-v-695dfd44><br data-v-695dfd44> Select the device then click <strong data-v-695dfd44>Connect</strong>. </p><img src="'+b+'" alt="Select COM device" data-v-695dfd44>',7)),i("div",null,[i("button",{class:"outline-button",onClick:e[0]||(e[0]=a=>async function(){if(y.eraseall_status_dms.value=0,0==y.isConnected.value){for(y.eraseall_vid_dms.value=0,y.connection_mode.value=2,await y.eraseall_dms_connect();0==y.eraseall_status_dms.value;)await ra(100);await ra(100)}if(0!=y.eraseall_vid_dms.value){let a=65535&y.eraseall_vid_dms.value;ha.value=62208==a?"DUELink "+ea:"MicroBlocks "+ea,da.value=!0}}())}," Erase All ")]),e[27]||(e[27]=s('<p data-v-695dfd44> If the pop-up window didn&#39;t show the needed device or if <strong data-v-695dfd44>Erase All</strong> failed, your device might already be erased. Try Step 2 or visit the <a href="https://www.duelink.com/docs/loader" target="_blank" data-v-695dfd44>loader documentation page</a>. </p><hr data-v-695dfd44><h2 data-v-695dfd44>Step 2: Load Firmware/Driver</h2><p data-v-695dfd44> This step will update the firmware on a single device, or on the first device in a chain. </p><p data-v-695dfd44> Click the button below then select the <em data-v-695dfd44>DFU in FS Mode</em> device and click <strong data-v-695dfd44>Connect</strong>. </p><p data-v-695dfd44> If using Windows, <a href="https://www.duelink.com/bin/usb-drivers/win-usb-dfu.zip" target="_blank" data-v-695dfd44>download</a> and install the DFU driver first. </p><img src="'+k+'" alt="DFU selection" data-v-695dfd44>',7)),Fa.value?(t(),l("div",E,[e[6]||(e[6]=i("label",{for:"version-select"}," Select DUELink firmware version: ",-1)),n(i("select",{id:"version-select","onUpdate:modelValue":e[1]||(e[1]=a=>Sa.value=a)},[(t(!0),l(o,null,r(Ta.value,(a,e)=>(t(),l("option",{key:a.id,value:e},v(a.name),9,L))),128))],512),[[u,Sa.value]])])):d("",!0),i("div",null,[i("button",{class:"outline-button",onClick:Oa}," Load DUELink Firmware/Driver "),e[7]||(e[7]=i("p",null,[c(" The update steps are now complete on a single device."),i("br"),i("br"),c(" Continue to step 3 if you have multiple devices in a chain that you want to update. ")],-1))]),e[28]||(e[28]=i("hr",null,null,-1)),e[29]||(e[29]=i("h2",null,"Step 3: Update Chain",-1)),e[30]||(e[30]=i("p",null," This optional step is for updating all modules in a chain (Daisylink). ",-1)),e[31]||(e[31]=i("p",null,[c(" Click the "),i("strong",null,"Load Driver Script"),c(" button, then select the device. You should only see one named "),i("em",null,"DUELink Official"),c(". ")],-1)),e[32]||(e[32]=i("img",{src:b,alt:"COM selection"},null,-1)),i("div",null,[i("button",{class:"outline-button",onClick:Ca}," Update Chain ")]),e[33]||(e[33]=i("p",null,[c(" For any issues, consult the "),i("a",{href:"https://www.duelink.com/docs/loader",target:"_blank"}," loader documentation"),c(" page. ")],-1)),da.value?(t(),l("div",x,[i("div",F,[e[11]||(e[11]=i("div",{class:"dialog-title"},[i("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),c(" Warning ")],-1)),i("div",S,[i("p",null,[c(v(ha.value),1),e[8]||(e[8]=i("br",null,null,-1)),e[9]||(e[9]=i("br",null,null,-1)),c(v("Are you sure you want to erase all?")),e[10]||(e[10]=i("br",null,null,-1))])]),i("div",{class:"dialog-buttons"},[i("button",{class:"yes",onClick:ma},"Yes"),i("button",{class:"no",onClick:ya},"No")])])])):d("",!0),ca.value?(t(),l("div",T,[i("div",A,[e[12]||(e[12]=i("div",{class:"dialog-title-success"},[i("i",{class:"fas fa-check-circle",style:{color:"green","margin-right":"8px"}}),c(" Success ")],-1)),i("div",q,[i("p",null,v(ua.value),1)]),i("div",M,[i("button",{class:"no",onClick:e[2]||(e[2]=a=>{ca.value=!1})},"Close")])])])):d("",!0),va.value?(t(),l("div",O,[i("div",B,[e[13]||(e[13]=i("div",{class:"dialog-title"},[i("i",{class:"fa-solid fa-triangle-exclamation",style:{color:"#f5c542","margin-right":"8px"}}),c(" Failed ")],-1)),i("div",I,[i("p",null,v(oa.value),1)]),i("div",j,[i("button",{class:"no",onClick:e[3]||(e[3]=a=>{va.value=!1})},"Close")])])])):d("",!0),fa.value?(t(),l("div",N,[i("div",W,[e[17]||(e[17]=i("div",{class:"dialog-title-success"},[i("i",{class:"fas fa-question-circle",style:{color:"white","margin-right":"8px"}}),c(" Success ")],-1)),i("div",P,[i("p",null,[c(" Firmware "+v(Aa.value?.name)+" updated. ",1),e[14]||(e[14]=i("br",null,null,-1)),e[15]||(e[15]=i("br",null,null,-1)),e[16]||(e[16]=c("Do you want to load driver? ",-1))])]),i("div",Y,[i("button",{class:"yes",onClick:_a},"Yes"),i("button",{class:"no",onClick:e[4]||(e[4]=a=>fa.value=!1)},"No")])])])):d("",!0),wa.value?(t(),l("div",R,[i("div",V,[e[24]||(e[24]=i("div",{class:"dialog-title"},[i("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),c(" Warning ")],-1)),i("div",$,[i("p",null,v(La.value),1),i("p",{style:f({color:qa.value?"#000000":"#d9534f"})},v(xa.value),5),!1===qa.value?(t(),l("p",H,[e[18]||(e[18]=c(" (Recommend: ",-1)),i("button",{class:"link-button underline",onClick:e[5]||(e[5]=a=>{wa.value=!1})}," Update "),e[19]||(e[19]=c(" to the latest firmware.) ",-1))])):d("",!0),e[23]||(e[23]=i("br",null,null,-1)),i("p",null,[e[20]||(e[20]=c("Do you want to load ",-1)),i("a",{target:"_blank",href:p(y).update_driver_path.value},"this driver",8,z),e[21]||(e[21]=c("?",-1)),e[22]||(e[22]=i("br",null,null,-1))])]),i("div",{class:"dialog-buttons"},[i("button",{class:"yes",onClick:ba},"Yes"),i("button",{class:"no",onClick:ka},"No")])])])):d("",!0),pa.value?(t(),l("div",G,[i("div",J,[i("div",{class:w(["dialog-title",{"dialog-title-success":100===ga.value}])},[ga.value<100?(t(),l("i",K)):d("",!0),c(" "+v((ga.value,na.value)),1)],2),i("div",Q,[i("div",X,v(ia.value),1),e[25]||(e[25]=i("br",null,null,-1)),i("div",Z,[i("div",{class:"update-driver-progress-bar",style:f({width:ga.value+"%"})},null,4)]),i("div",aa,v(ga.value)+"% ",1)])])])):d("",!0)]))}},[["__scopeId","data-v-695dfd44"]])).mount("#app");
