!function(){"use strict";importScripts("../consumer-queue.min.js");const e=new TextDecoder,t=new TextEncoder;let a=!1,n=">",s="",i=null,r=!0,o=null,l=null,c="",u=null;const w=new ConsumerQueue,d=[">","$","&"],p=7071;let g=!1,v=!0,f=0;async function m(){j(`Port status ${a}`),await new Promise(e=>setTimeout(e,400)),[i]=await navigator.serial.getPorts();try{if(null==i)return;i.connected&&null!=i.readable&&null!=i.writable&&(i.readable.locked||i.writable.locked)&&(await R(),await new Promise(e=>setTimeout(e,1e3))),await i.open({baudRate:115200,dataBits:8,parity:"none",stopBits:1,flowControl:"none"})}catch(t){return postMessage({event:"ConnectFailed",message:t?.message,name:t.name,full:t}),void B(t?.message||"Unable to open port.")}if(i.addEventListener("disconnect",()=>{j("Port disconnected"),R()}),null==i?.writable)return void B("Port is not a writable.");if(null==i?.readable)return void B("Port is not a readable.");if(u=i.writable.getWriter(),l=i.readable.getReader(),o=async function(){let n,i=!0;for(r=!0;r;)try{const{value:t,done:o}=await l.read();j("Reading... Done?",o);const u=e.decode(t).replace(/\r/gm,"");if(a&&!d.includes(u.substring(-1,1))){if(s+=u,s.length>2e3)if(u.length<s.length){s=s.substring(u.length,s.length);const e=s.indexOf("\n");e>-1&&(s=s.substring(e+1,s.length)),i=!0}else s="",postMessage({event:"output",value:"Maximum output limit reached."}),i=!1;i&&postMessage({event:"output",value:s})}if(c+=u,!c)continue;let p=c.indexOf("\n");for(p>-1?c.split("\n").forEach(e=>j("->",e)):j("->",c);p>-1;)n=c.substring(0,p),n&&(j("queued:",n),w.push(n)),c=c.substring(p+1),p=c.indexOf("\n");">"!==c&&"$"!==c&&"&"!==c||(j("queued:",c),w.push(c),c=""),o&&(r=!1),await H(2)}catch(t){postMessage({event:"logError",message:t?.message||"There were problems reading."});break}}(),await H(200),0!=await z()){a=!0;const e=i.getInfo();postMessage({event:"connected"}),postMessage({event:"eraseall_vid_dms",value:e.usbVendorId<<16|e.usbProductId})}else postMessage({event:"ConnectFailed",message:"Unable to detect DUELink firmware.",name:"Device is busy"})}async function _(){await u.write(t.encode("")),await H(400),await O()}addEventListener("message",e=>{switch(j(`---- on "message", do task: ${e.data.task} ----`),e.data.task){case"clearOutput":s="";break;case"connect":x=e.data.value,v=!0,m();break;case"disconnect":R();break;case"eraseall_dms_execute_msg":!async function(){const e=i.getInfo();e.usbVendorId==p&&62209==e.usbProductId?(await u.write(new Uint8Array([250,15,199])),await H(200),postMessage({event:"eraseall_status_dms",value:2})):e.usbVendorId==p&&62208==e.usbProductId&&(await u.write(t.encode("\n")),await H(400),await _(),await H(400),await u.write(t.encode("reset(1)\n")),await H(100),await u.write(t.encode("reset(1)\n")),await H(700),postMessage({event:"eraseall_status_dms",value:2}))}();break;case"eraseall_dms_connect_msg":!async function(e){j(`Port status ${a}`),await new Promise(e=>setTimeout(e,400)),[i]=await navigator.serial.getPorts();try{if(null==i)return;i.connected&&null!=i.readable&&null!=i.writable&&(i.readable.locked||i.writable.locked)&&(await R(),await new Promise(e=>setTimeout(e,1e3))),await i.open({baudRate:115200,dataBits:8,parity:"none",stopBits:1,flowControl:"none"})}catch(s){return postMessage({event:"ConnectFailed",message:s?.message,name:s.name,full:s}),void B(s?.message||"Unable to open port.")}if(i.addEventListener("disconnect",()=>{j("Port disconnected"),R()}),null==i?.writable)return void B("Port is not a writable.");if(null==i?.readable)return void B("Port is not a readable.");const n=i.getInfo();n.usbVendorId==p&&(u=i.writable.getWriter(),postMessage({event:"eraseall_vid_dms",value:n.usbVendorId<<16|n.usbProductId}));x=e,await u.write(t.encode(`sel(${x})\n`)),await H(50),await O(),postMessage({event:"eraseall_status_dms",value:1})}(e.data.value);break;case"driver_connect_msg":C(e.data.value);break;case"driver_connect_updadate_msg":T();break;case"sendescape":_();break;case"do_clone_fw":!async function(e,a){let n=e;for(A=await async function(){await u.write(t.encode("Info(0)\n")),await H(100);let e=await O();if(e.length>0){e.pop();let t=e.pop();const a=Number(t).toString(16).toUpperCase().padStart(6,"0");$="0x"+a}await h();const a=M($);return"NA"===a?void 0:a.name}(),E=A?`${A}(${e}) detected\n`:"",n=e;n<a;n++){U=0,postMessage({event:"clone_fw_dev",value:n+1}),L(n),await H(100);let e=0;for(;0==U;)postMessage({event:"progress_percent",value:e}),e+=1,await H(300),e>99&&(e=99);if(U<0)break;e<90&&(e+=5),postMessage({event:"progress_percent",value:e}),postMessage({event:"progress_body_text",value:E+`\nConnecting to device ${n+1}...`}),v=!1,await C(n+1),v=!0,e<95&&(e+=5),postMessage({event:"progress_percent",value:e}),postMessage({event:"progress_body_text",value:E+`\n${k} detected at address ${n+1}\nLoading the driver onto device...`}),v=!1,await T(),v=!0,f>0&&(e<99&&(e=99),postMessage({event:"progress_percent",value:e}),postMessage({event:"progress_body_text",value:E+`\n${k} detected at address ${n+1}\nFinishing loading the driver...`}),E+=`${k}(${n+1}) updated`,E+="\n",n>10&&(E=E.split("\n").slice(1).join("\n")),await H(2e3))}postMessage({event:"clone_fw_status",value:n})}(e.data.value1,e.data.value2);break;case"do_discover":!async function(){if(a){S=[];let e=1,t=0;for(;;){if(await D(!1,e)<0)break;t++,e++}return postMessage({event:"add_device_chain_status",value:t}),1}postMessage({event:"add_device_chain_status",value:-1})}()}});let b=null;async function h(){if(null==b){const e=await fetch("https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/duelink.json"),t=await e.json();b=Array.isArray(t.products)?t.products:[]}}function M(e){if(!b)return"NA";const t=String(e).toUpperCase(),a=b.find(e=>String(e.PID).toUpperCase()===t);return a?{name:a.name??"NA",partNumber:a.partNumber??"NA"}:"NA"}let y="",k="",$="",P="",I=!1,N="",x=1;async function C(e){if(I=!1,x=e,a){if(!(await z()))return}else await m();if(await H(100),!a)return;await u.write(t.encode("\n")),await H(400),(await O()).pop(),await u.write(t.encode("Dver()\n")),await H(100);let n=await O();if(n.length>0){n.pop();let e=n.pop();y=e.includes("unknown identifier")?"N/A":e}if(await u.write(t.encode("Info(0)\n")),await H(100),n=await O(),n.length>0){n.pop();let e=n.pop();const t=Number(e).toString(16).toUpperCase().padStart(6,"0");$="0x"+t}await h();const s=M($);"NA"!==s&&(k=s.name,P=s.partNumber,N="https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/code/driver/"+P.toLowerCase()+".txt",postMessage({event:"update_driver_path_msg",value:N}),postMessage({event:"driver_ver_msg",value:y}),postMessage({event:"device_name_msg",value:k}),I=!0)}async function T(){if(f=0,!a||!I)return void(f=-1);const e=N,n=await fetch(e);if(!n.ok)return void(f=-1);let s=(await n.text()).replace(/\r/gm,"").replace(/\t/gm," ").split(/\n/);v&&postMessage({event:"progress_percent",value:0}),await J("new all"),v&&postMessage({event:"progress_percent",value:10}),await J("pgmbrst()","&"),await H(250),v&&postMessage({event:"progress_percent",value:20});let i=0;for(let t of s){await H(2),0===t.trim().length&&(t=" "),j("line",`"${t}"`),await Q(t+"\n"),i++;let e=Math.floor(i/s.length*70);e>70&&(e=70),e+=20,v&&postMessage({event:"progress_percent",value:e})}v&&postMessage({event:"progress_percent",value:95}),await Q("\0"),await G(),await u.write(t.encode("run\n")),await H(100),await u.write(t.encode("Region(1)\n")),await H(100),await O(),await u.write(t.encode("run\n")),await H(1e3),await u.write(t.encode("$\n")),await H(250),v&&postMessage({event:"progress_percent",value:96}),await u.write(t.encode("# This is region 1 User\n")),await H(250),await u.write(t.encode("# Replace this with your code\n")),await H(250),v&&postMessage({event:"progress_percent",value:97}),await u.write(t.encode("# StatLed(200,200,10)\n")),await H(250),v&&postMessage({event:"progress_percent",value:99}),await u.write(t.encode(">\n")),await H(250),await O(),v&&postMessage({event:"progress_percent",value:100}),f=1}let U=0,E="";async function L(e){postMessage({event:"progress_body_text",value:E+`\nChecking if device ${e+1} existsâ€¦`});try{await J(`sel(${e+1})`,null,"\n",1e3);const t=await J("Info(1)");if(t.length>0){if(Number(t.pop())>.1){await J(`sel(${e})`,null,"\n",1e3),postMessage({event:"progress_body_text",value:E+`\nCloning firmware from device(${e}) to device(${e+1})...`});const t=await J("clone()",null,"\n",4e4);if(t.length>0){const a=Number(t.pop());if(a==e+1)return U=a,U}}}await J("sel(1)")}catch{}return E="",U=-1,U}let A="";let S=[];let V=0;async function D(e,n){if(!a)return-1;const s=performance.now();let i=e?`cmd("sel(${n})")`:`sel(${n})`;await J(i,null,"\n",1e3);if(performance.now()-s>500)return-2;i=e?'cmd("Info(0)")\n':"Info(0)\n",await u.write(t.encode(i)),await H(100);let r=await O(),o="";if(r.length>0){r.pop();let e=r.pop();o="0x"+Number(e).toString(16).toUpperCase().padStart(6,"0")}if(""!=o){i=e?'cmd("Info(3)")\n':"Info(3)\n",await u.write(t.encode(i)),await H(100),r=await O();let a=1;if(r.length>0){r.pop();let e=r.pop();a=Number(e)}if(1==a||2==a){await h();const s=M(o);if("NA"===s)return;{const r="https://www.duelink.com/img/catalog/",o="https://www.duelink.com/docs/products/";let l=s.partNumber,c=r+l.toLowerCase().slice(4)+"-1.webp",w=o+l.toLowerCase().slice(4);i=e?'cmd("Info(1)")\n':"Info(1)\n",await u.write(t.encode(i)),await H(100);const d=await O();let p=0;if(d.length>0){d.pop();let e=d.pop();p=Number(e)}if(p>0){const e={address:n,name:s.name,firmwareVersion:p,image:c,detail:w,dl_mode:2==a?2:0};if(function(e){S.push(e)}(e),postMessage({event:"add_device_chain",address:e.address,name:e.name,firmwareVersion:e.firmwareVersion,image:e.image,detail:e.detail,dl_mode:e.dl_mode}),await H(100),2==a){let e=1;for(V++;;){if(await D(V,e)<0)break;e++}}return 1}}}return-4}return-3}async function R(){try{await async function(){r=!1,o&&(await l.cancel(),await o,o=null)}(),u&&(await u.close(),await u.releaseLock(),u=null),l&&(await l.cancel(),await l.releaseLock(),l=null),await i.close(),F("Port disconnected.")}catch(e){a&&(F("There was an error while disconnecting."),B(e?.message||"Unknown error."))}finally{a=!1,postMessage({event:"disconnected"}),postMessage({event:"version",value:null})}}function O(){return new Promise(async e=>{const t=[];let a;do{a=await w.tryPop(),a?(t.push(a),j("flushed - push line:",a)):j("flushed: No line")}while(a);t.length||(c=""),j("flushed",t),e(t)})}function j(){}function B(e){postMessage({event:"logError",message:e})}function F(e){postMessage({event:"logEvent",message:e})}let q=!1;function W(e,t){const a=[...e];return a.length>1?a.pop():a?.[0]===t&&a.shift(),q=!1,a}function G(e=null,t=3e3){return q?[]:(q=!0,e||(e=n),new Promise(async a=>{const n=[];let s=!1,i=null;const r=()=>{t<0||(clearTimeout(i),i=setTimeout(()=>{s=!0,g=!1,a(W(n,e))},t))};try{let t;r();do{try{t=await w.pop()}catch(o){return j("read until",o.message||o,n),clearTimeout(i),g=!1,void a(W(n,e))}if(!t||s)break;if(r(),n.push(t),t.startsWith("!")){j("Error:",t);break}}while(t!==e)}finally{clearTimeout(i)}g=!s,a(W(n,e))}))}function H(e){return new Promise(t=>setTimeout(t,e))}async function Q(e){let a=t.encode(e),n=a.length,s=0;for(;n>0;){const e=a.subarray(s,s+Math.min(10,n));await u.write(e);const t=await w.tryPop();if(t)return t;s+=10,n-=e.length,await H(1)}return null}async function z(){v&&postMessage({event:"progress_percent",value:5}),await u.write(t.encode("")),await H(400),await O(),v&&postMessage({event:"progress_percent",value:10}),await u.write(t.encode("\n")),await H(400),await O(),v&&postMessage({event:"progress_percent",value:15}),await u.write(t.encode("sel(1)\n")),await H(100),await O(),v&&postMessage({event:"progress_percent",value:20}),await u.write(t.encode("")),await H(100),await O(),v&&postMessage({event:"progress_percent",value:25}),await u.write(t.encode("\n")),await H(100),await O(),v&&postMessage({event:"progress_percent",value:30}),1!=x&&(v&&postMessage({event:"progress_percent",value:35}),await u.write(t.encode(`sel(${x})\n`)),await H(50),await O(),v&&postMessage({event:"progress_percent",value:40}),await u.write(t.encode("")),await H(50),await O(),v&&postMessage({event:"progress_percent",value:45}),await u.write(t.encode("\n")),await H(50),await O()),v&&postMessage({event:"progress_percent",value:60}),v&&postMessage({event:"progress_percent",value:65});const e=await async function(){const e=await J("version()");for(const t of e)if(j("line",t,(t.match(/\./g)||[]).length),-1!=t.indexOf("GHI Electronics DUELink v"))return t.split(":")[0].substring(24)}();return"string"==typeof e?(postMessage({event:"version",value:e}),v&&postMessage({event:"progress_percent",value:100}),1):(v&&postMessage({event:"progress_percent",value:71}),await R(),0)}async function J(e,a=null,s="\n",i=3e3){try{postMessage({event:"isTalking",value:!0}),await O(),u.write(t.encode(e+s)),">"!==e&&"$"!==e||(n=e),await H(50);const r=await G(a||n,i);return r}finally{postMessage({event:"isTalking",value:!1,lastCommand:e})}}}();
