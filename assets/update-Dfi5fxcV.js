import{_ as a,d as e,r as t,e as l,f as s,c as i,o as n,a as o,g as u,h as c,w as r,v,F as d,i as p,j as w,t as g,n as f,u as h,k as m,b as y}from"./_plugin-vue_export-helper-DDmiMxIv.js";import{u as b,_,a as k}from"./useWebSerial-DcG7QIqv.js";const C=""+new URL("../img/usbhook-rgb3.webp",import.meta.url).href,U={class:"page"},D={class:"button-row"},x={key:0,class:"version-select"},E=["value"],L={key:1,class:"overlay"},S={class:"dialog"},F={class:"dialog-body"},T={key:2,class:"overlay"},A={class:"dialog"},B={class:"dialog-body"},I={class:"dialog-buttons"},q={key:3,class:"overlay"},P={class:"dialog"},j={class:"dialog-body"},M={class:"dialog-buttons"},O={key:4,class:"overlay"},N={class:"dialog"},W={class:"dialog-body"},Y={class:"dialog-buttons"},H={key:5,class:"overlay"},V={class:"dialog"},R={class:"dialog-body"},z={key:0,class:"firmware-warning"},G=["href"],$={key:6,class:"overlay"},J={class:"dialog",style:{width:"25vw"}},K={key:0,class:"fas fa-exclamation-triangle",style:{"margin-right":"8px"}},Q={class:"dialog-body"},X={class:"update-driver-progress-container"},Z={class:"progress-text"},aa="Firmware detected.",ea=2048,ta=134217728;y(a({__name:"update",setup(a){const y=b();e(async()=>{await async function(){try{const a=await fetch("https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/duelink-fw.json"),e=await a.json();Object.keys(e).forEach(a=>{Ua[a]=e[a],Ua[a].isGlb=!1,Ua[a].image=null})}catch(a){}}()}),t("");const la=t(""),sa=t(""),ia=t(""),na=t("");function oa(a){return new Promise(e=>setTimeout(e,a))}const ua=t(!1),ca=t(!1),ra=t(!1),va=t(!1),da=t(!1),pa=t(!1),wa=t(0),ga=t(aa);async function fa(){for(ua.value=!1,wa.value=0,sa.value="Please wait...",da.value=!0,await y.eraseall_dms_execute();y.eraseall_status_dms.value<2;)await oa(250),wa.value=50;wa.value=100,sa.value="Done",await oa(250),da.value=!1,ia.value="Erase all completed.",ca.value=!0}async function ha(){ua.value=!1,y.isConnected&&(await y.disconnect(),await oa(250))}async function ma(){if(va.value=!1,!y.isConnected.value){y.device_name.value="",y.driver_ver.value="",y.progress_percent.value=0,wa.value=0,y.update_driver_status.value=0,y.update_devaddr.value=1,y.connection_mode.value=1;if(await y.driver_connect()){for(sa.value="Please wait...",da.value=!0,wa.value=0;0==y.update_driver_status.value;)await oa(100),wa.value=y.progress_percent.value;if(await oa(100),1==y.update_driver_status.value){let a=!1;const e=Date.now()+4e3;for(;!(y.isConnected.value&&""!=y.device_name.value&&""!=y.driver_ver.value||(await oa(100),Date.now()>e));)wa.value=y.progress_percent.value;y.isConnected.value&&Date.now()<e&&(a=!0),a&&(sa.value="Connected",Da.value="Device Name: "+y.device_name.value,xa.value="Firmware Version: "+y.version.value,pa.value=!0,wa.value=100,da.value=!1)}da.value=!1,wa.value=0}}}async function ya(){for(pa.value=!1,sa.value="Please wait...",da.value=!0,y.progress_percent.value=0,wa.value=0,y.driver_update();100!=y.progress_percent.value;)await oa(1),wa.value=y.progress_percent.value;y.update_driver_status.value=0,await y.disconnect(),await oa(10),da.value=!1,ia.value="Load driver completed.",ca.value=!0}async function ba(){y.isConnected.value&&(y.disconnect(),await oa(100)),pa.value=!1}async function _a(){if(0==y.isConnected.value&&await async function(){if(y.connect_status.value=0,y.connection_mode.value=0,y.update_driver_status.value=0,wa.value=0,y.progress_percent.value=0,await y.connect()){for(sa.value="Please wait while connecting...",da.value=!0,wa.value=0;0==y.connect_status.value&&(await oa(100),wa.value=y.progress_percent.value,71!=wa.value););y.connect_status.value>0&&(wa.value=99,await oa(100)),da.value=!1,wa.value=0,await oa(100),y.connect_status.value<0&&(na.value="Connection failed",ra.value=!0)}}(),0!=y.isConnected.value){for(y.clone_fw_status.value=0,sa.value="Please wait...",da.value=!0,y.progress_percent.value=0,wa.value=0,y.do_clone_fw(1,3),y.progress_percent.value=0;0==y.clone_fw_status.value;)await oa(100),sa.value=y.progress_body_text.value,wa.value=y.progress_percent.value;await oa(100),da.value=!1,y.clone_fw_status.value}}let ka;const Ca=t(!1),Ua=l({}),Da=t("");t("");const xa=t(""),Ea=s(()=>Ua.DUELink),La=t(0),Sa=s(()=>Ea.value?.versions?[...Ea.value.versions].sort((a,e)=>e.id-a.id):[]),Fa=s(()=>Sa.value[La.value]||null),Ta=t(!0);async function Aa(){const a=Ea;await async function(a){try{0!==(await Pa()).status&&(await ka.controlTransferOut({requestType:"class",recipient:"interface",request:4,value:0,index:0}),await oa(100));const e=a.byteLength;await async function(a){la.value="Erasing...",sa.value=la.value;const e=Math.ceil(a/ea);for(let t=0;t<e;t++){const a=ta+t*ea,l=new Uint8Array(5);l[0]=65,l[1]=255&a,l[2]=a>>8&255,l[3]=a>>16&255,l[4]=a>>24&255,await qa(0,l),await ja(),Ia(t,e)}la.value="Erased.",sa.value=la.value,Ia(0,100)}(e),wa.value=0,da.value=!1,await oa(250),da.value=!0,la.value="Writing...",sa.value=la.value;let t=new Uint8Array(5);t[0]=33,t[1]=0,t[2]=0,t[3]=0,t[4]=8,await qa(0,t),await ja();let l=0,s=2;for(;l<e;){const t=a.slice(l,l+1024);await qa(s,t),await ja(),l+=t.byteLength,s++,Ia(l,e)}await async function(){let a=new Uint8Array(5);try{return a[0]=33,a[1]=0,a[2]=0,a[3]=0,a[4]=8,await qa(0,a),await ja(),await qa(0,new ArrayBuffer(0)),await ja(),1}catch(e){}return 0}(),la.value="Completed"}catch(e){la.value="Failed"}sa.value=la.value}(a.image)}async function Ba(){await async function(){try{Ca.value=!1,ka=await navigator.usb.requestDevice({filters:[{vendorId:1155,productId:57105}]}),await ka.open(),ka.configuration||await ka.selectConfiguration(1),await ka.claimInterface(0),Ca.value=!0}catch(a){a.value="Connection error: "+a,Ca.value=!1}}(),Ca.value&&(wa.value=0,sa.value="Please wait...",da.value=!0,await async function(){const a=Sa?.value[La.value],e=a?.url;try{const a=await fetch(e);if(!a.ok)throw new Error(`HTTP ${a.status}`);const t=await a.blob(),l=await t.arrayBuffer();Ea.image=l}catch(t){Ea.image=null}}(),await Aa(),da.value=!1,"Completed"==la.value&&(va.value=!0))}function Ia(a,e){wa.value=Math.round(a/e*100),wa.value}async function qa(a,e){const t=await ka.controlTransferOut({requestType:"class",recipient:"interface",request:1,value:a,index:0},e);if("ok"!==t.status)throw new Error("DNLOAD transfer failed at block "+a);return t}async function Pa(){const a=await ka.controlTransferIn({requestType:"class",recipient:"interface",request:3,value:0,index:0},6);if("ok"===a.status&&a.data&&6===a.data.byteLength){const e=new DataView(a.data.buffer);return{status:e.getUint8(0),pollTimeout:e.getUint8(1)|e.getUint8(2)<<8|e.getUint8(3)<<16,state:e.getUint8(4),iString:e.getUint8(5)}}throw new Error("Failed to read DFU status.")}async function ja(){for(;;){const a=await Pa();if(5===a.state||2===a.state)break;await oa(a.pollTimeout)}}return(a,e)=>(n(),i("div",U,[e[27]||(e[27]=o('<h1 class="title" data-v-62877687>DUELink Loader</h1><p class="subtitle" data-v-62877687> This page will help in updating DUELink firmware and its related Driver. </p><hr class="divider" data-v-62877687><h2 class="section-title" data-v-62877687>Step 1 (Erase All)</h2><div class="card-container" data-v-62877687><div class="card" data-v-62877687><img src="'+_+'" alt="Module with USB" class="card-image" data-v-62877687><p class="card-text" data-v-62877687> If your module has a USB connector, just plug it in! </p></div><div class="card" data-v-62877687><img src="'+C+'" alt="USB Hook" class="card-image" data-v-62877687><p class="card-text" data-v-62877687> If your module has a <code data-v-62877687>U</code> Uplink connector, you need a USB adaptor, like USB Hook. </p></div></div><p class="subtitle" data-v-62877687> Click the <strong data-v-62877687>Erase All</strong> button, then select the device. You should only see one named <em data-v-62877687>DUELink Official</em> or <em data-v-62877687>DUELink MicroBlocks</em>. </p><img src="'+k+'" alt="Select DFU device" class="screenshot" data-v-62877687>',7)),u("div",D,[u("button",{class:"outline-button",onClick:e[0]||(e[0]=a=>async function(){if(y.eraseall_status_dms.value=0,0==y.isConnected.value){for(y.eraseall_vid_dms.value=0,y.connection_mode.value=2,await y.eraseall_dms_connect();0==y.eraseall_status_dms.value;)await oa(100);await oa(100)}if(0!=y.eraseall_vid_dms.value){let a=65535&y.eraseall_vid_dms.value;ga.value=62208==a?"DUELink "+aa:"MicroBlocks "+aa,ua.value=!0}}())}," Erase All ")]),e[28]||(e[28]=o('<p class="subtitle" data-v-62877687> If <strong data-v-62877687>Erase All</strong> failed, visit the <a href="https://www.duelink.com/docs/loader" target="_blank" data-v-62877687> loader documentation page </a>. </p><hr class="divider" data-v-62877687><h2 class="section-title" data-v-62877687>Step 2 (Load Firmware/Driver)</h2><p class="subtitle" data-v-62877687> This step will update the firmware on a single device, or on the first device in a chain. </p><p class="subtitle" data-v-62877687> Click the button below then select the <em data-v-62877687>DFU in FS Mode</em> device and click <strong data-v-62877687>Connect</strong>. </p><p class="subtitle" data-v-62877687> If using Windows, <a href="https://www.duelink.com/bin/usb-drivers/win-usb-dfu.zip" target="_blank" data-v-62877687>download</a> and install the DFU driver first. </p><img src="'+k+'" alt="DFU selection" class="screenshot" data-v-62877687>',7)),Ea.value?(n(),i("div",x,[e[6]||(e[6]=u("label",{for:"version-select"}," Select firmware version: ",-1)),r(u("select",{id:"version-select","onUpdate:modelValue":e[1]||(e[1]=a=>La.value=a)},[(n(!0),i(d,null,p(Sa.value,(a,e)=>(n(),i("option",{key:a.id,value:e},g(a.name),9,E))),128))],512),[[v,La.value]])])):c("",!0),u("div",{class:"button-row"},[u("button",{class:"outline-button",onClick:Ba}," Load DUELink Firmware/Driver "),e[7]||(e[7]=u("hr",{class:"divider"},null,-1)),e[8]||(e[8]=u("p",{class:"subtitle"},[w(" The update steps are now complete on a single device."),u("br"),u("br"),w(" Continue to step 3 if you have multiple devices in a chain that you want to update. ")],-1))]),e[29]||(e[29]=o('<hr class="divider" data-v-62877687><h2 class="section-title" data-v-62877687>Step 3 (Update Chain)</h2><p class="subtitle" data-v-62877687> This optional step is for updating all modules in a chain (Daisylink). </p><p class="subtitle" data-v-62877687> Click the <strong data-v-62877687>Load Driver Script</strong> button, then select the device. You should only see one named <em data-v-62877687>DUELink Official</em>. </p><img src="'+k+'" alt="Driver selection" class="screenshot" data-v-62877687>',5)),u("div",{class:"button-row"},[u("button",{class:"outline-button",onClick:_a}," Update Chain ")]),ua.value?(n(),i("div",L,[u("div",S,[e[12]||(e[12]=u("div",{class:"dialog-title"},[u("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),w(" Warning ")],-1)),u("div",F,[u("p",null,[w(g(ga.value),1),e[9]||(e[9]=u("br",null,null,-1)),e[10]||(e[10]=u("br",null,null,-1)),w(g("Are you sure you want to erase all?")),e[11]||(e[11]=u("br",null,null,-1))])]),u("div",{class:"dialog-buttons"},[u("button",{class:"yes",onClick:fa},"Yes"),u("button",{class:"no",onClick:ha},"No")])])])):c("",!0),ca.value?(n(),i("div",T,[u("div",A,[e[13]||(e[13]=u("div",{class:"dialog-title-success"},[u("i",{class:"fas fa-check-circle",style:{color:"green","margin-right":"8px"}}),w(" Success ")],-1)),u("div",B,[u("p",null,g(ia.value),1)]),u("div",I,[u("button",{class:"no",onClick:e[2]||(e[2]=a=>{ca.value=!1})},"Close")])])])):c("",!0),ra.value?(n(),i("div",q,[u("div",P,[e[14]||(e[14]=u("div",{class:"dialog-title"},[u("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),w(" Failed ")],-1)),u("div",j,[u("p",null,g(na.value),1)]),u("div",M,[u("button",{class:"no",onClick:e[3]||(e[3]=a=>{ra.value=!1})},"Close")])])])):c("",!0),va.value?(n(),i("div",O,[u("div",N,[e[18]||(e[18]=u("div",{class:"dialog-title-success"},[u("i",{class:"fas fa-question-circle",style:{color:"white","margin-right":"8px"}}),w(" Success ")],-1)),u("div",W,[u("p",null,[w(" Firmware "+g(Fa.value?.name)+" updated. ",1),e[15]||(e[15]=u("br",null,null,-1)),e[16]||(e[16]=u("br",null,null,-1)),e[17]||(e[17]=w("Do you want to load driver? ",-1))])]),u("div",Y,[u("button",{class:"yes",onClick:ma},"Yes"),u("button",{class:"no",onClick:e[4]||(e[4]=a=>va.value=!1)},"No")])])])):c("",!0),pa.value?(n(),i("div",H,[u("div",V,[e[25]||(e[25]=u("div",{class:"dialog-title"},[u("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),w(" Warning ")],-1)),u("div",R,[u("p",null,g(Da.value),1),u("p",{style:f({color:Ta.value?"#000000":"#d9534f"})},g(xa.value),5),!1===Ta.value?(n(),i("p",z,[e[19]||(e[19]=w(" (Recommend: ",-1)),u("button",{class:"link-button underline",onClick:e[5]||(e[5]=a=>{pa.value=!1})}," Update "),e[20]||(e[20]=w(" to the latest firmware.) ",-1))])):c("",!0),e[24]||(e[24]=u("br",null,null,-1)),u("p",null,[e[21]||(e[21]=w("Do you want to load ",-1)),u("a",{target:"_blank",href:h(y).update_driver_path.value},"this driver",8,G),e[22]||(e[22]=w("?",-1)),e[23]||(e[23]=u("br",null,null,-1))])]),u("div",{class:"dialog-buttons"},[u("button",{class:"yes",onClick:ya},"Yes"),u("button",{class:"no",onClick:ba},"No")])])])):c("",!0),da.value?(n(),i("div",$,[u("div",J,[u("div",{class:m(["dialog-title",{"dialog-title-success":100===wa.value}])},[wa.value<100?(n(),i("i",K)):c("",!0),w(" "+g((wa.value,sa.value)),1)],2),u("div",Q,[e[26]||(e[26]=u("br",null,null,-1)),u("div",X,[u("div",{class:"update-driver-progress-bar",style:f({width:wa.value+"%"})},null,4)]),u("div",Z,g(wa.value)+"% ",1)])])])):c("",!0)]))}},[["__scopeId","data-v-62877687"]])).mount("#app");
