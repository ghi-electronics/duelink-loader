import{_ as a,d as e,r as t,e as l,f as s,c as i,o as n,a as o,g as c,h as r,w as u,v as d,F as v,i as b,t as f,j as w,k as g,n as p,b as m}from"./_plugin-vue_export-helper-BG_x5QSZ.js";import{u as h,_ as y,a as k}from"./useWebSerial-CpuvScYG.js";const _=""+new URL("../img/cincobit-daisylinked.webp",import.meta.url).href,U=""+new URL("../img/mcduestem-b-1.webp",import.meta.url).href,C={class:"page"},E={class:"button-row"},M={key:0,class:"version-select"},B=["value"],D={key:1,class:"overlay"},L={class:"dialog"},x={class:"dialog-body"},F={key:2,class:"overlay"},T={class:"dialog"},S={class:"dialog-body"},A={class:"dialog-buttons"},I={key:3,class:"overlay"},q={class:"dialog"},j={class:"dialog-body"},O={class:"dialog-buttons"},P={key:4,class:"overlay"},W={class:"dialog",style:{width:"25vw"}},V={key:0,class:"fas fa-exclamation-triangle",style:{"margin-right":"8px"}},N={class:"dialog-body"},R={class:"update-driver-progress-container"},Y={class:"progress-text"},z="Firmware detected.",G=2048,H=134217728;m(a({__name:"microblocks",setup(a){const m=h();e(async()=>{await async function(){try{const a=await fetch("https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/duelink-fw.json"),e=await a.json();Object.keys(e).forEach(a=>{ra[a]=e[a],ra[a].isGlb=!1,ra[a].image=null})}catch(a){}}()}),t("");const $=t(""),J=t(""),K=t(""),Q=t("");function X(a){return new Promise(e=>setTimeout(e,a))}const Z=t(!1),aa=t(!1),ea=t(!1),ta=t(!1),la=t(0),sa=t(z);async function ia(){for(Z.value=!1,la.value=0,J.value="Please wait...",ta.value=!0,await m.eraseall_dms_execute();m.eraseall_status_dms.value<2;)await X(250),la.value=50;la.value=100,J.value="Done",await X(250),ta.value=!1,K.value="Erase all completed.",aa.value=!0}async function na(){Z.value=!1,m.isConnected&&(await m.disconnect(),await X(250))}let oa;const ca=t(!1),ra=l({});t(""),t("");const ua=s(()=>ra.MicroBlock),da=t(0),va=s(()=>ua.value?.versions?[...ua.value.versions].sort((a,e)=>e.id-a.id):[]);async function ba(){const a=ua;await async function(a){try{0!==(await pa()).status&&(await oa.controlTransferOut({requestType:"class",recipient:"interface",request:4,value:0,index:0}),await X(100));const e=a.byteLength;await async function(a){$.value="Erasing...",J.value=$.value;const e=Math.ceil(a/G);for(let t=0;t<e;t++){const a=H+t*G,l=new Uint8Array(5);l[0]=65,l[1]=255&a,l[2]=a>>8&255,l[3]=a>>16&255,l[4]=a>>24&255,await ga(0,l),await ma(),wa(t,e)}$.value="Erased.",J.value=$.value,wa(0,100)}(e),la.value=0,ta.value=!1,await X(250),ta.value=!0,$.value="Writing...",J.value=$.value;let t=new Uint8Array(5);t[0]=33,t[1]=0,t[2]=0,t[3]=0,t[4]=8,await ga(0,t),await ma();let l=0,s=2;for(;l<e;){const t=a.slice(l,l+1024);await ga(s,t),await ma(),l+=t.byteLength,s++,wa(l,e)}await async function(){let a=new Uint8Array(5);try{return a[0]=33,a[1]=0,a[2]=0,a[3]=0,a[4]=8,await ga(0,a),await ma(),await ga(0,new ArrayBuffer(0)),await ma(),1}catch(e){}return 0}(),$.value="Completed"}catch(e){$.value="Failed"}J.value=$.value}(a.image)}async function fa(){if(await async function(){try{ca.value=!1,oa=await navigator.usb.requestDevice({filters:[{vendorId:1155,productId:57105}]}),await oa.open(),oa.configuration||await oa.selectConfiguration(1),await oa.claimInterface(0),ca.value=!0}catch(a){a.value="Connection error: "+a,ca.value=!1}}(),ca.value)if(la.value=0,J.value="Please wait...",ta.value=!0,await async function(){const a=va?.value[da.value],e=a?.url;try{const a=await fetch(e);if(!a.ok)throw new Error(`HTTP ${a.status}`);const t=await a.blob(),l=await t.arrayBuffer();ua.image=l}catch(t){ua.image=null}}(),await ba(),ta.value=!1,"Completed"==$.value){const a=va?.value[da.value].name;K.value="MicroBlocks Version "+a+" update completed.",aa.value=!0}else ea.value="MicroBlocks update failed.",ea.value=!0}function wa(a,e){la.value=Math.round(a/e*100),la.value}async function ga(a,e){const t=await oa.controlTransferOut({requestType:"class",recipient:"interface",request:1,value:a,index:0},e);if("ok"!==t.status)throw new Error("DNLOAD transfer failed at block "+a);return t}async function pa(){const a=await oa.controlTransferIn({requestType:"class",recipient:"interface",request:3,value:0,index:0},6);if("ok"===a.status&&a.data&&6===a.data.byteLength){const e=new DataView(a.data.buffer);return{status:e.getUint8(0),pollTimeout:e.getUint8(1)|e.getUint8(2)<<8|e.getUint8(3)<<16,state:e.getUint8(4),iString:e.getUint8(5)}}throw new Error("Failed to read DFU status.")}async function ma(){for(;;){const a=await pa();if(5===a.state||2===a.state)break;await X(a.pollTimeout)}}return s(()=>va.value[da.value]||null),t(!0),(a,e)=>(n(),i("div",C,[e[12]||(e[12]=o('<h1 class="title" data-v-b914abf2>MicroBlocks Firmware Loader</h1><p class="subtitle" data-v-b914abf2> This page will load MicroBlocks firmware on a single device or the first device in a chain. </p><p class="subtitle" data-v-b914abf2> If you need to update the DUELink firmware on chained modules, do that first on the <a href="/update" data-v-b914abf2>DUELink update page</a>. </p><img src="'+_+'" alt="Chained modules" class="screenshot" data-v-b914abf2><hr class="divider" data-v-b914abf2><h2 class="section-title" data-v-b914abf2>Step 1 (Erase All)</h2><p class="subtitle" data-v-b914abf2> Connect your module using a USB cable. </p><img src="'+U+'" alt="Module with USB" class="card-image" data-v-b914abf2><p class="subtitle" data-v-b914abf2> Click the <strong data-v-b914abf2>Erase All</strong> button. The pop-up window should have a device named <em data-v-b914abf2>DUELink Official</em> or <em data-v-b914abf2>DUELink MicroBlocks</em>.<br data-v-b914abf2><br data-v-b914abf2> Select the device then click <strong data-v-b914abf2>Connect</strong>. </p><img src="'+y+'" alt="Select COM device" class="screenshot" data-v-b914abf2>',10)),c("div",E,[c("button",{class:"outline-button",onClick:e[0]||(e[0]=a=>async function(){if(m.eraseall_status_dms.value=0,0==m.isConnected.value){for(m.eraseall_vid_dms.value=0,m.connection_mode.value=2,await m.eraseall_dms_connect();0==m.eraseall_status_dms.value;)await X(100);await X(100)}if(0!=m.eraseall_vid_dms.value){let a=65535&m.eraseall_vid_dms.value;sa.value=62208==a?"DUELink "+z:"MicroBlocks "+z,Z.value=!0}}())}," Erase All ")]),e[13]||(e[13]=o('<p class="subtitle" data-v-b914abf2> If the pop-up window didn&#39;t show the needed device or if <strong data-v-b914abf2>Erase All</strong> failed, visit the <a href="https://www.duelink.com/docs/loader" target="_blank" data-v-b914abf2> loader documentation page</a>. </p><hr class="divider" data-v-b914abf2><h2 class="section-title" data-v-b914abf2>Step 2 (Load MicroBlocks Firmware)</h2><p class="subtitle" data-v-b914abf2> Click the button below then select the <em data-v-b914abf2>DFU in FS Mode</em> device and click <strong data-v-b914abf2>Connect</strong>. </p><p class="subtitle" data-v-b914abf2> If using Windows, <a href="https://www.duelink.com/bin/usb-drivers/win-usb-dfu.zip" target="_blank" data-v-b914abf2>download</a> and install the DFU driver first. </p><img src="'+k+'" alt="DFU selection" class="screenshot" data-v-b914abf2>',6)),ua.value?(n(),i("div",M,[e[4]||(e[4]=c("label",{for:"version-select"}," Select firmware version: ",-1)),u(c("select",{id:"version-select","onUpdate:modelValue":e[1]||(e[1]=a=>da.value=a)},[(n(!0),i(v,null,b(va.value,(a,e)=>(n(),i("option",{key:a.id,value:e},f(a.name),9,B))),128))],512),[[d,da.value]])])):r("",!0),c("div",{class:"button-row"},[c("button",{class:"outline-button",onClick:fa}," Load MicroBlocks Firmware ")]),e[14]||(e[14]=c("p",{class:"subtitle"},[w(" Your're now ready to start block-code using "),c("a",{href:"https://www.duelink.com/docs/language/microblocks",target:"_blank"},"MicroBlocks"),w(". ")],-1)),Z.value?(n(),i("div",D,[c("div",L,[e[8]||(e[8]=c("div",{class:"dialog-title"},[c("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),w(" Warning ")],-1)),c("div",x,[c("p",null,[w(f(sa.value),1),e[5]||(e[5]=c("br",null,null,-1)),e[6]||(e[6]=c("br",null,null,-1)),w(f("Are you sure you want to erase all?")),e[7]||(e[7]=c("br",null,null,-1))])]),c("div",{class:"dialog-buttons"},[c("button",{class:"yes",onClick:ia},"Yes"),c("button",{class:"no",onClick:na},"No")])])])):r("",!0),aa.value?(n(),i("div",F,[c("div",T,[e[9]||(e[9]=c("div",{class:"dialog-title-success"},[c("i",{class:"fas fa-check-circle",style:{color:"green","margin-right":"8px"}}),w(" Success ")],-1)),c("div",S,[c("p",null,f(K.value),1)]),c("div",A,[c("button",{class:"no",onClick:e[2]||(e[2]=a=>{aa.value=!1})},"Close")])])])):r("",!0),ea.value?(n(),i("div",I,[c("div",q,[e[10]||(e[10]=c("div",{class:"dialog-title"},[c("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),w(" Failed ")],-1)),c("div",j,[c("p",null,f(Q.value),1)]),c("div",O,[c("button",{class:"no",onClick:e[3]||(e[3]=a=>{ea.value=!1})},"Close")])])])):r("",!0),ta.value?(n(),i("div",P,[c("div",W,[c("div",{class:g(["dialog-title",{"dialog-title-success":100===la.value}])},[la.value<100?(n(),i("i",V)):r("",!0),w(" "+f((la.value,J.value)),1)],2),c("div",N,[e[11]||(e[11]=c("br",null,null,-1)),c("div",R,[c("div",{class:"update-driver-progress-bar",style:p({width:la.value+"%"})},null,4)]),c("div",Y,f(la.value)+"% ",1)])])])):r("",!0)]))}},[["__scopeId","data-v-b914abf2"]])).mount("#app");
