import{_ as a,d as e,o as t,c as l,a as s,e as i,w as n,v as o,F as r,r as c,t as u,f as d,g as v,h as w,n as f,i as g,j as p,k as h,b as m}from"./_plugin-vue_export-helper-C4YAnmRp.js";import{u as y,_ as b,a as k,b as _}from"./useWebSerial-Bqn4S0wa.js";const U=""+new URL("../img/cincobit-daisylinked.webp",import.meta.url).href,C={class:"page"},E={key:0,class:"version-select"},M=["value"],B={key:1,class:"overlay"},D={class:"dialog"},F={class:"dialog-body"},T={key:2,class:"overlay"},x={class:"dialog"},L={class:"dialog-body"},S={class:"dialog-buttons"},A={key:3,class:"overlay"},I={class:"dialog"},q={class:"dialog-body"},j={class:"dialog-buttons"},O={key:4,class:"overlay"},P={class:"dialog",style:{width:"25vw"}},W={key:0,class:"fas fa-exclamation-triangle",style:{"margin-right":"8px"}},V={class:"dialog-body"},N={class:"update-driver-progress-container"},Y={class:"progress-text"},z="Firmware detected.",G=2048,H=134217728;m(a({__name:"microblocks",setup(a){const m=y();e(async()=>{await async function(){try{const a=await fetch("https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/duelink-fw.json"),e=await a.json();Object.keys(e).forEach(a=>{ra[a]=e[a],ra[a].isGlb=!1,ra[a].image=null})}catch(a){}}()});const R=h(""),$=h(""),J=h(""),K=h("");function Q(a){return new Promise(e=>setTimeout(e,a))}const X=h(!1),Z=h(!1),aa=h(!1),ea=h(!1),ta=h(0),la=h(z);async function sa(){for(X.value=!1,ta.value=0,$.value="Please wait...",ea.value=!0,await m.eraseall_dms_execute();m.eraseall_status_dms.value<2;)await Q(250),ta.value=50;ta.value=100,$.value="Done",await Q(250),ea.value=!1,J.value="Erase all completed.",Z.value=!0}async function ia(){X.value=!1,m.isConnected&&(await m.disconnect(),await Q(250))}let na;const oa=h(!1),ra=g({}),ca=p(()=>ra.MicroBlock),ua=h(0),da=p(()=>ca.value?.versions?[...ca.value.versions].sort((a,e)=>e.id-a.id):[]);async function va(){const a=ca;await async function(a){try{0!==(await pa()).status&&(await na.controlTransferOut({requestType:"class",recipient:"interface",request:4,value:0,index:0}),await Q(100));const e=a.byteLength;await async function(a){R.value="Erasing...",$.value=R.value;const e=Math.ceil(a/G);for(let t=0;t<e;t++){const a=H+t*G,l=new Uint8Array(5);l[0]=65,l[1]=255&a,l[2]=a>>8&255,l[3]=a>>16&255,l[4]=a>>24&255,await ga(0,l),await ha(),fa(t,e)}R.value="Erased.",$.value=R.value,fa(0,100)}(e),ta.value=0,ea.value=!1,await Q(250),ea.value=!0,R.value="Writing...",$.value=R.value;let t=new Uint8Array(5);t[0]=33,t[1]=0,t[2]=0,t[3]=0,t[4]=8,await ga(0,t),await ha();let l=0,s=2;for(;l<e;){const t=a.slice(l,l+1024);await ga(s,t),await ha(),l+=t.byteLength,s++,fa(l,e)}await async function(){let a=new Uint8Array(5);try{return a[0]=33,a[1]=0,a[2]=0,a[3]=0,a[4]=8,await ga(0,a),await ha(),await ga(0,new ArrayBuffer(0)),await ha(),1}catch(e){}return 0}(),R.value="Completed"}catch(e){R.value="Failed"}$.value=R.value}(a.image)}async function wa(){if(await async function(){try{oa.value=!1,na=await navigator.usb.requestDevice({filters:[{vendorId:1155,productId:57105}]}),await na.open(),na.configuration||await na.selectConfiguration(1),await na.claimInterface(0),oa.value=!0}catch(a){a.value="Connection error: "+a,oa.value=!1}}(),oa.value)if(ta.value=0,$.value="Please wait...",ea.value=!0,await async function(){const a=da?.value[ua.value],e=a?.url;try{const a=await fetch(e);if(!a.ok)throw new Error(`HTTP ${a.status}`);const t=await a.blob(),l=await t.arrayBuffer();ca.image=l}catch(t){ca.image=null}}(),await va(),ea.value=!1,"Completed"==R.value){const a=da?.value[ua.value].name;J.value="MicroBlocks Version "+a+" update completed.",Z.value=!0}else aa.value="MicroBlocks update failed.",aa.value=!0}function fa(a,e){ta.value=Math.round(a/e*100),ta.value}async function ga(a,e){const t=await na.controlTransferOut({requestType:"class",recipient:"interface",request:1,value:a,index:0},e);if("ok"!==t.status)throw new Error("DNLOAD transfer failed at block "+a);return t}async function pa(){const a=await na.controlTransferIn({requestType:"class",recipient:"interface",request:3,value:0,index:0},6);if("ok"===a.status&&a.data&&6===a.data.byteLength){const e=new DataView(a.data.buffer);return{status:e.getUint8(0),pollTimeout:e.getUint8(1)|e.getUint8(2)<<8|e.getUint8(3)<<16,state:e.getUint8(4),iString:e.getUint8(5)}}throw new Error("Failed to read DFU status.")}async function ha(){for(;;){const a=await pa();if(5===a.state||2===a.state)break;await Q(a.pollTimeout)}}return(a,e)=>(t(),l("div",C,[e[12]||(e[12]=s('<h1 data-v-47a4a559>MicroBlocks Firmware Loader</h1><p data-v-47a4a559> This page will load MicroBlocks firmware on a single device, or on the first device in a chain. </p><img src="'+U+'" alt="cincobit daisylinked" class="screenshot" data-v-47a4a559><p data-v-47a4a559> If you need to update the DUELink firmware on chained modules, do that first on the <a href="/update" data-v-47a4a559>DUELink update page</a>. </p><hr data-v-47a4a559><h2 data-v-47a4a559>Step 1: Erase All</h2><p data-v-47a4a559> Connect your module using a USB cable. </p><img src="'+b+'" alt="Module with USB" class="card-image" data-v-47a4a559><p data-v-47a4a559> Click the <strong data-v-47a4a559>Erase All</strong> button below. The pop-up window should have a device named <em data-v-47a4a559>DUELink Official</em> or <em data-v-47a4a559>DUELink MicroBlocks</em>.<br data-v-47a4a559><br data-v-47a4a559> Select the device then click <strong data-v-47a4a559>Connect</strong>. </p><img src="'+k+'" alt="Select COM device" class="screenshot" data-v-47a4a559>',10)),i("div",null,[i("button",{class:"outline-button",onClick:e[0]||(e[0]=a=>async function(){if(m.eraseall_status_dms.value=0,0==m.isConnected.value){for(m.eraseall_vid_dms.value=0,m.connection_mode.value=2,await m.eraseall_dms_connect();0==m.eraseall_status_dms.value;)await Q(100);await Q(100)}if(0!=m.eraseall_vid_dms.value){let a=65535&m.eraseall_vid_dms.value;la.value=62208==a?"DUELink "+z:"MicroBlocks "+z,X.value=!0}}())}," Erase All ")]),e[13]||(e[13]=s('<p data-v-47a4a559> If the pop-up window didn&#39;t show the needed device or if <strong data-v-47a4a559>Erase All</strong> failed, your device might already be erased. Try Step 2 or visit the <a href="https://www.duelink.com/docs/loader" target="_blank" data-v-47a4a559>loader documentation page</a>. </p><hr data-v-47a4a559><h2 data-v-47a4a559>Step 2: Load MicroBlocks Firmware</h2><p data-v-47a4a559> Click the button below then select the <em data-v-47a4a559>DFU in FS Mode</em> device and click <strong data-v-47a4a559>Connect</strong>. </p><p data-v-47a4a559> If using Windows, <a href="https://www.duelink.com/bin/usb-drivers/win-usb-dfu.zip" target="_blank" data-v-47a4a559>download</a> and install the DFU driver first. </p><img src="'+_+'" alt="DFU selection" class="screenshot" data-v-47a4a559>',6)),ca.value?(t(),l("div",E,[e[4]||(e[4]=i("label",{for:"version-select"}," Select MicroBlocks firmware version: ",-1)),n(i("select",{id:"version-select","onUpdate:modelValue":e[1]||(e[1]=a=>ua.value=a)},[(t(!0),l(r,null,c(da.value,(a,e)=>(t(),l("option",{key:a.id,value:e},u(a.name),9,M))),128))],512),[[o,ua.value]])])):d("",!0),i("div",null,[i("button",{class:"outline-button",onClick:wa}," Load MicroBlocks Firmware ")]),e[14]||(e[14]=i("p",null,[v(" You are now ready to start block-code using "),i("a",{href:"https://www.duelink.com/docs/language/microblocks",target:"_blank"},"MicroBlocks"),v(". ")],-1)),e[15]||(e[15]=i("p",null,[v(" For any issues, consult the "),i("a",{href:"https://www.duelink.com/docs/loader",target:"_blank"}," loader documentation"),v(" page. ")],-1)),X.value?(t(),l("div",B,[i("div",D,[e[8]||(e[8]=i("div",{class:"dialog-title"},[i("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),v(" Warning ")],-1)),i("div",F,[i("p",null,[v(u(la.value),1),e[5]||(e[5]=i("br",null,null,-1)),e[6]||(e[6]=i("br",null,null,-1)),v(u("Are you sure you want to erase all?")),e[7]||(e[7]=i("br",null,null,-1))])]),i("div",{class:"dialog-buttons"},[i("button",{class:"yes",onClick:sa},"Yes"),i("button",{class:"no",onClick:ia},"No")])])])):d("",!0),Z.value?(t(),l("div",T,[i("div",x,[e[9]||(e[9]=i("div",{class:"dialog-title-success"},[i("i",{class:"fas fa-check-circle",style:{color:"green","margin-right":"8px"}}),v(" Success ")],-1)),i("div",L,[i("p",null,u(J.value),1)]),i("div",S,[i("button",{class:"no",onClick:e[2]||(e[2]=a=>{Z.value=!1})},"Close")])])])):d("",!0),aa.value?(t(),l("div",A,[i("div",I,[e[10]||(e[10]=i("div",{class:"dialog-title"},[i("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),v(" Failed ")],-1)),i("div",q,[i("p",null,u(K.value),1)]),i("div",j,[i("button",{class:"no",onClick:e[3]||(e[3]=a=>{aa.value=!1})},"Close")])])])):d("",!0),ea.value?(t(),l("div",O,[i("div",P,[i("div",{class:w(["dialog-title",{"dialog-title-success":100===ta.value}])},[ta.value<100?(t(),l("i",W)):d("",!0),v(" "+u((ta.value,$.value)),1)],2),i("div",V,[e[11]||(e[11]=i("br",null,null,-1)),i("div",N,[i("div",{class:"update-driver-progress-bar",style:f({width:ta.value+"%"})},null,4)]),i("div",Y,u(ta.value)+"% ",1)])])])):d("",!0)]))}},[["__scopeId","data-v-47a4a559"]])).mount("#app");
