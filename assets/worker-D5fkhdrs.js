!function(){"use strict";importScripts("../consumer-queue.min.js");const e=new TextDecoder,t=new TextEncoder;let a=!1,n=!1,s=">",i="",r=null,o=!0,l=null,c=null,u=!0,d="",w=null;const p=new ConsumerQueue,g=[">","$","&"],v=7071;let m=!1;async function f(){N(`Port status ${n}`),await new Promise(e=>setTimeout(e,400)),[r]=await navigator.serial.getPorts();try{if(!r.connected)return;null!=r.readable&&null!=r.writable&&(r.readable.locked||r.writable.locked)&&(await x(),await new Promise(e=>setTimeout(e,1e3))),await r.open({baudRate:115200,dataBits:8,parity:"none",stopBits:1,flowControl:"none"})}catch(s){return postMessage({event:"ConnectFailed",message:s?.message,name:s.name,full:s}),void A(s?.message||"Unable to open port.")}if(r.addEventListener("disconnect",()=>{N("Port disconnected"),x()}),null==r?.writable)return void A("Port is not a writable.");if(null==r?.readable)return void A("Port is not a readable.");if(w=r.writable.getWriter(),c=r.readable.getReader(),l=async function(){let t,r=!0;for(o=!0;o;)try{const{value:s,done:l}=await c.read();N("Reading... Done?",l);const u=e.decode(s).replace(/\r/gm,"");if(n&&!g.includes(u.substring(-1,1))){if(i+=u,i.length>2e3)if(u.length<i.length){i=i.substring(u.length,i.length);const e=i.indexOf("\n");e>-1&&(i=i.substring(e+1,i.length)),r=!0}else i="",postMessage({event:"output",value:"Maximum output limit reached."}),r=!1;r&&!a?postMessage({event:"output",value:i}):a&&(i="")}if(d+=u,!d)continue;let w=d.indexOf("\n");for(w>-1?d.split("\n").forEach(e=>N("->",e)):N("->",d);w>-1;)t=d.substring(0,w),t&&(N("queued:",t),p.push(t)),d=d.substring(w+1),w=d.indexOf("\n");">"!==d&&"$"!==d&&"&"!==d||(N("queued:",d),p.push(d),d=""),l&&(o=!1),await D(2)}catch(s){postMessage({event:"logError",message:s?.message||"There were problems reading."});break}}(),await D(200),0!=await async function(){postMessage({event:"update_driver_percent_msg",value:5}),await w.write(t.encode("")),await D(400),await E(),postMessage({event:"update_driver_percent_msg",value:10}),await w.write(t.encode("\n")),await D(400),await E(),postMessage({event:"update_driver_percent_msg",value:15}),await w.write(t.encode("sel(1)\n")),await D(100),await E(),postMessage({event:"update_driver_percent_msg",value:20}),await w.write(t.encode("")),await D(100),await E(),postMessage({event:"update_driver_percent_msg",value:25}),await w.write(t.encode("\n")),await D(100),await E(),postMessage({event:"update_driver_percent_msg",value:30}),1!=I&&(postMessage({event:"update_driver_percent_msg",value:35}),await w.write(t.encode(`sel(${I})\n`)),await D(50),await E(),postMessage({event:"update_driver_percent_msg",value:40}),await w.write(t.encode("")),await D(50),await E(),postMessage({event:"update_driver_percent_msg",value:45}),await w.write(t.encode("\n")),await D(50),await E());postMessage({event:"update_driver_percent_msg",value:60}),postMessage({event:"update_driver_percent_msg",value:65});const e=await async function(){const e=await O("version()");for(const t of e){if(N("line",t,(t.match(/\./g)||[]).length),-1!=t.indexOf("GHI Electronics DUELink v")){return t.split(":")[0].substring(24)}}return}();if("string"==typeof e)return N("version found",e),postMessage({event:"version",value:e}),postMessage({event:"update_driver_percent_msg",value:100}),1;return postMessage({event:"update_driver_percent_msg",value:71}),await x(),0}()){n=!0;const e=r.getInfo();postMessage({event:"connected"}),postMessage({event:"eraseall_vid_dms",value:e.usbVendorId<<16|e.usbProductId})}else postMessage({event:"ConnectFailed",message:"Unable to detect DUELink firmware.",name:"Device is busy"})}addEventListener("message",e=>{switch(N(`---- on "message", do task: ${e.data.task} ----`),e.data.task){case"clearOutput":i="";break;case"connect":I=e.data.value,f();break;case"disconnect":x();break;case"execute":!async function(e){if(await O(">"),(e=e.toLowerCase()).startsWith("mem")){const t=await O(e);postMessage({event:"memoryRegionsResult",result:t})}else if(e.startsWith("run")){const t=await O(e,null,"\n",100);postMessage({event:"memoryRegionsResult",result:t})}else await O(e);C(`Executed: &nbsp;<code>${e}</code>`)}(e.data.line);break;case"list":!async function(e){const t=await O("list");postMessage({event:"writeResult",callbackId:e,result:t}),C("Listed program code.")}(e.data.callbackId);break;case"listAll":!async function(){const e=await O("list all");postMessage({event:"listAllResult",result:e})}();break;case"memoryRegions":$();break;case"newAll":!async function(){await O("new all"),postMessage({event:"erased"}),await $()}();break;case"play":!async function(){u=!1,postMessage({event:"playing"}),await O("run",null,"\n",-1),u||(u=!0,postMessage({event:"stopped"}))}();break;case"record":!async function(e){postMessage({event:"recording",percent:0}),await O("pgmbrst()","&"),postMessage({event:"isTalking",value:!0}),e=e.replace(/\r/gm,"").replace(/\t/gm," ").split(/\n/);let t=0;for(let a of e)await D(1),0===a.trim().length&&(a=" "),N("line",`"${a}"`),await W(a+"\n"),postMessage({event:"recording",percent:++t/e.length*100});postMessage({event:"recording",percent:100}),await W("\0"),await S(),postMessage({event:"isTalking",value:!1}),postMessage({event:"recorded"}),C("Recorded "+e.length+" line(s) of code.")}(e.data.lines);break;case"region":!async function(e){await O(`region(${e})`),postMessage({event:"regionSelected",index:e})}(e.data.index);break;case"stop":!async function(){u=!0,p.cancelWait(new Error("Stop")),w.write(t.encode("")),postMessage({event:"stopped"})}();break;case"eraseall_dms_execute_msg":!async function(){const e=r.getInfo();e.usbVendorId==v&&62209==e.usbProductId?(await w.write(new Uint8Array([250,15,199])),await D(200),postMessage({event:"eraseall_status_dms",value:2})):e.usbVendorId==v&&62208==e.usbProductId&&(await w.write(t.encode("\n")),await D(400),await w.write(t.encode("reset(1)\n")),await D(100),await w.write(t.encode("reset(1)\n")),await D(700),postMessage({event:"eraseall_status_dms",value:2}))}();break;case"eraseall_dms_connect_msg":!async function(e){N(`Port status ${n}`),await new Promise(e=>setTimeout(e,400)),[r]=await navigator.serial.getPorts();try{if(!r.connected)return;null!=r.readable&&null!=r.writable&&(r.readable.locked||r.writable.locked)&&(await x(),await new Promise(e=>setTimeout(e,1e3))),await r.open({baudRate:115200,dataBits:8,parity:"none",stopBits:1,flowControl:"none"})}catch(s){return postMessage({event:"ConnectFailed",message:s?.message,name:s.name,full:s}),void A(s?.message||"Unable to open port.")}if(r.addEventListener("disconnect",()=>{N("Port disconnected"),x()}),null==r?.writable)return void A("Port is not a writable.");if(null==r?.readable)return void A("Port is not a readable.");const a=r.getInfo();a.usbVendorId==v&&(w=r.writable.getWriter(),postMessage({event:"eraseall_vid_dms",value:a.usbVendorId<<16|a.usbProductId}));I=e,await w.write(t.encode(`sel(${I})\n`)),await D(50),await E(),postMessage({event:"eraseall_status_dms",value:1})}(e.data.value);break;case"driver_connect_msg":!async function(e){if(k=!1,I=e,await f(),await D(100),!n)return;await w.write(t.encode("\n")),await D(400),(await E()).pop(),await w.write(t.encode("Dver()\n")),await D(100);let a=await E();if(a.length>0){a.pop();let e=a.pop();b=e.includes("unknown identifier")?"N/A":e}if(await w.write(t.encode("Info(0)\n")),await D(100),a=await E(),a.length>0){a.pop();let e=a.pop();const t=Number(e).toString(16).toUpperCase().padStart(6,"0");h="0x"+t}await async function(){const e=await fetch("https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/duelink.json"),t=await e.json();_=Array.isArray(t.products)?t.products:[]}();const s=function(e){if(!_)return"NA";const t=String(e).toUpperCase(),a=_.find(e=>String(e.PID).toUpperCase()===t);return a?{name:a.name??"NA",partNumber:a.partNumber??"NA"}:"NA"}(h);if("NA"===s)return;M=s.name,y=s.partNumber,P="https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/code/driver/"+y.toLowerCase()+".txt",postMessage({event:"update_driver_path_msg",value:P}),postMessage({event:"driver_ver_msg",value:b}),postMessage({event:"device_name_msg",value:M}),k=!0}(e.data.value);break;case"driver_connect_updadate_msg":!async function(){if(!n||!k)return;const e=P,a=await fetch(e);if(!a.ok)return;let s=(await a.text()).replace(/\r/gm,"").replace(/\t/gm," ").split(/\n/);postMessage({event:"update_driver_percent_msg",value:0}),await O("new all"),postMessage({event:"update_driver_percent_msg",value:10}),await O("pgmbrst()","&"),await D(250),postMessage({event:"update_driver_percent_msg",value:20});let i=0;for(let t of s){await D(2),0===t.trim().length&&(t=" "),N("line",`"${t}"`),await W(t+"\n"),i++;let e=Math.floor(i/s.length*70);e>70&&(e=70),e+=20,postMessage({event:"update_driver_percent_msg",value:e})}postMessage({event:"update_driver_percent_msg",value:95}),await W("\0"),await S(),await w.write(t.encode("run\n")),await D(100),await w.write(t.encode("Region(1)\n")),await D(100),await E(),await w.write(t.encode("run\n")),await D(1e3),await w.write(t.encode("$\n")),await D(250),postMessage({event:"update_driver_percent_msg",value:96}),await w.write(t.encode("# This is region 1 User\n")),await D(250),await w.write(t.encode("# Replace this with your code\n")),await D(250),postMessage({event:"update_driver_percent_msg",value:97}),await w.write(t.encode("# StatLed(200,200,10)\n")),await D(250),postMessage({event:"update_driver_percent_msg",value:99}),await w.write(t.encode(">\n")),await D(250),await E(),postMessage({event:"update_driver_percent_msg",value:100})}();break;case"sendescape":!async function(){await w.write(t.encode("")),await D(400),await E()}();break;case"do_clone_fw":!async function(e,t){let a=e;for(T=0,a=e;a<t;a++){postMessage({event:"clone_fw_dev",value:a+1}),R(e),await D(100);let t=0;for(;0==T;)postMessage({event:"clone_fw_progress",value:t}),t+=1,await D(300),t>99&&(t=99);if(T<0)break;postMessage({event:"clone_fw_progress",value:100})}postMessage({event:"clone_fw_status",value:a})}(e.data.value1,e.data.value2)}});let _=null;let b="",M="",h="",y="",k=!1,P="",I=1;let T=0;async function R(e){await O(`sel(${e+1})`,null,"\n",1e3);const t=await O("Info(1)");if(t.length>0){if(Number(t.pop())>0){await O(`sel(${e})`,null,"\n",1e3);const t=await O("clone()",null,"\n",3e4);if(t.length>0){const a=Number(t.pop());if(a==e+1)return T=a,T}}}return await O("sel(1)"),T=-1,T}async function x(){try{await async function(){o=!1,l&&(await c.cancel(),await l,l=null)}(),w&&(await w.close(),await w.releaseLock(),w=null),c&&(await c.cancel(),await c.releaseLock(),c=null),await r.close(),C("Port disconnected.")}catch(e){n&&(C("There was an error while disconnecting."),A(e?.message||"Unknown error."))}finally{n=!1,postMessage({event:"disconnected"}),postMessage({event:"version",value:null})}}async function $(){a=!0;const e=await O("mem()");postMessage({event:"memoryRegionsResult",result:e}),a=!1}function E(){return new Promise(async e=>{const t=[];let a;do{a=await p.tryPop(),a?(t.push(a),N("flushed - push line:",a)):N("flushed: No line")}while(a);t.length||(d=""),N("flushed",t),e(t)})}function N(){}function A(e){postMessage({event:"logError",message:e})}function C(e){postMessage({event:"logEvent",message:e})}let L=!1;function U(e,t){const a=[...e];return a.length>1?a.pop():a?.[0]===t&&a.shift(),L=!1,a}function S(e=null,t=3e3){return L?[]:(L=!0,e||(e=s),new Promise(async a=>{const n=[];let s=!1,i=null;const r=()=>{t<0||(clearTimeout(i),i=setTimeout(()=>{s=!0,m=!1,a(U(n,e))},t))};try{let t;r();do{try{t=await p.pop()}catch(o){return N("read until",o.message||o,n),clearTimeout(i),m=!1,void a(U(n,e))}if(!t||s)break;if(r(),n.push(t),t.startsWith("!")){N("Error:",t);break}}while(t!==e)}finally{clearTimeout(i)}m=!s,a(U(n,e))}))}function D(e){return new Promise(t=>setTimeout(t,e))}async function W(e){let a=t.encode(e),n=a.length,s=0;for(;n>0;){const e=a.subarray(s,s+Math.min(10,n));await w.write(e);const t=await p.tryPop();if(t)return t;s+=10,n-=e.length,await D(1)}return null}async function O(e,a=null,n="\n",i=3e3){try{postMessage({event:"isTalking",value:!0}),await E(),w.write(t.encode(e+n)),">"!==e&&"$"!==e||(s=e),await D(50);const r=await S(a||s,i);return r}finally{postMessage({event:"isTalking",value:!1,lastCommand:e})}}}();
