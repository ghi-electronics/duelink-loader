import{_ as a,d as e,r as t,e as l,f as s,c as i,o as n,a as u,g as o,h as r,w as c,v as d,F as v,i as p,j as w,t as f,n as b,u as g,k as h,b as m}from"./_plugin-vue_export-helper-CGQFqKJp.js";import{u as y,_,a as k}from"./useWebSerial-BKyzK64C.js";const C=""+new URL("../img/stamp-usb-connect.webp",import.meta.url).href,U=""+new URL("../img/usbhook-rgb3.webp",import.meta.url).href,D={class:"page"},x={class:"button-row"},E={key:0,class:"version-select"},L=["value"],F={key:1,class:"overlay"},S={class:"dialog"},T={class:"dialog-body"},A={key:2,class:"overlay"},q={class:"dialog"},M={class:"dialog-body"},O={class:"dialog-buttons"},B={key:3,class:"overlay"},I={class:"dialog"},j={class:"dialog-body"},N={class:"dialog-buttons"},W={key:4,class:"overlay"},P={class:"dialog"},Y={class:"dialog-body"},R={class:"dialog-buttons"},V={key:5,class:"overlay"},$={class:"dialog"},H={class:"dialog-body"},z={key:0,class:"firmware-warning"},G=["href"],J={key:6,class:"overlay"},K={class:"dialog",style:{width:"25vw"}},Q={key:0,class:"fas fa-exclamation-triangle",style:{"margin-right":"8px"}},X={class:"dialog-body"},Z={class:"progress-text"},aa={class:"update-driver-progress-container"},ea={class:"progress-text"},ta="Firmware detected.",la=2048,sa=134217728;m(a({__name:"update",setup(a){const m=y();e(async()=>{await async function(){try{const a=await fetch("https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/duelink-fw.json"),e=await a.json();Object.keys(e).forEach(a=>{Ea[a]=e[a],Ea[a].isGlb=!1,Ea[a].image=null})}catch(a){}}()}),t("");const ia=t(""),na=t(""),ua=t(""),oa=t(""),ra=t("");function ca(a){return new Promise(e=>setTimeout(e,a))}const da=t(!1),va=t(!1),pa=t(!1),wa=t(!1),fa=t(!1),ba=t(!1),ga=t(0),ha=t(ta);async function ma(){for(da.value=!1,ga.value=0,ua.value="Erase All",na.value="Erasing....",fa.value=!0,await m.eraseall_dms_execute();m.eraseall_status_dms.value<2;)await ca(250),ga.value=50;ga.value=100,ua.value="Done",await ca(250),fa.value=!1,oa.value="Erase all completed.",va.value=!0}async function ya(){da.value=!1,m.isConnected&&(await m.disconnect(),await ca(250))}async function _a(){if(wa.value=!1,!m.isConnected.value){m.device_name.value="",m.driver_ver.value="",m.progress_percent.value=0,ga.value=0,m.update_driver_status.value=0,m.update_devaddr.value=1,m.connection_mode.value=1;if(await m.driver_connect()){for(ua.value="Driver Update",na.value="Connecting...",fa.value=!0,ga.value=0;0==m.update_driver_status.value;)await ca(100),ga.value=m.progress_percent.value;if(await ca(100),1==m.update_driver_status.value){let a=!1;const e=Date.now()+4e3;for(;!(m.isConnected.value&&""!=m.device_name.value&&""!=m.driver_ver.value||(await ca(100),Date.now()>e));)ga.value=m.progress_percent.value;m.isConnected.value&&Date.now()<e&&(a=!0),a&&(La.value="Device Name: "+m.device_name.value,Fa.value="Firmware Version: "+m.version.value,ba.value=!0,ga.value=100,fa.value=!1)}fa.value=!1,ga.value=0}}}async function ka(){for(ba.value=!1,ua.value="Driver Update",na.value="Writing driver...",fa.value=!0,m.progress_percent.value=0,ga.value=0,m.driver_update();100!=m.progress_percent.value;)await ca(1),ga.value=m.progress_percent.value;m.update_driver_status.value=0,await m.disconnect(),await ca(10),fa.value=!1,oa.value="Load driver completed.",va.value=!0}async function Ca(){m.isConnected.value&&(m.disconnect(),await ca(100)),ba.value=!1}async function Ua(){if(ua.value="Update Chain",0==m.isConnected.value&&await async function(){if(m.connect_status.value=0,m.connection_mode.value=0,m.update_driver_status.value=0,ga.value=0,m.progress_percent.value=0,await m.connect()){for(na.value="Connecting to device 1...",fa.value=!0,ga.value=0;0==m.connect_status.value&&(await ca(100),ga.value=m.progress_percent.value,71!=ga.value););m.connect_status.value>0&&(ga.value=99,await ca(100)),fa.value=!1,ga.value=0,await ca(100),m.connect_status.value<0&&(ra.value="Connection failed",pa.value=!0)}}(),0!=m.isConnected.value){for(m.clone_fw_status.value=0,na.value="Please wait...",fa.value=!0,m.progress_percent.value=0,ga.value=0,m.do_clone_fw(1,200),m.progress_percent.value=0;0==m.clone_fw_status.value;)await ca(100),na.value=m.progress_body_text.value,ga.value=m.progress_percent.value;await ca(100),fa.value=!1,m.disconnect(),m.clone_fw_status.value>1?(2==m.clone_fw_status.value?oa.value=`A total of ${m.clone_fw_status.value-1} device was successfully cloned and its driver updated.`:oa.value=`A total of ${m.clone_fw_status.value-1} devices were successfully cloned and had their drivers updated.`,va.value=!0):(ra.value="No devices were cloned successfully.",pa.value=!0)}}let Da;const xa=t(!1),Ea=l({}),La=t("");t("");const Fa=t(""),Sa=s(()=>Ea.DUELink),Ta=t(0),Aa=s(()=>Sa.value?.versions?[...Sa.value.versions].sort((a,e)=>e.id-a.id):[]),qa=s(()=>Aa.value[Ta.value]||null),Ma=t(!0);async function Oa(){const a=Sa;await async function(a){try{0!==(await Na()).status&&(await Da.controlTransferOut({requestType:"class",recipient:"interface",request:4,value:0,index:0}),await ca(100));const e=a.byteLength;await async function(a){ia.value="Erasing...",na.value=ia.value;const e=Math.ceil(a/la);for(let t=0;t<e;t++){const a=sa+t*la,l=new Uint8Array(5);l[0]=65,l[1]=255&a,l[2]=a>>8&255,l[3]=a>>16&255,l[4]=a>>24&255,await ja(0,l),await Wa(),Ia(t,e)}ia.value="Erased.",na.value=ia.value,Ia(0,100)}(e),ga.value=0,fa.value=!1,await ca(250),fa.value=!0,ia.value="Writing...",na.value=ia.value;let t=new Uint8Array(5);t[0]=33,t[1]=0,t[2]=0,t[3]=0,t[4]=8,await ja(0,t),await Wa();let l=0,s=2;for(;l<e;){const t=a.slice(l,l+1024);await ja(s,t),await Wa(),l+=t.byteLength,s++,Ia(l,e)}await async function(){let a=new Uint8Array(5);try{return a[0]=33,a[1]=0,a[2]=0,a[3]=0,a[4]=8,await ja(0,a),await Wa(),await ja(0,new ArrayBuffer(0)),await Wa(),1}catch(e){}return 0}(),ia.value="Completed"}catch(e){ia.value="Failed"}na.value=ia.value}(a.image)}async function Ba(){await async function(){try{xa.value=!1,Da=await navigator.usb.requestDevice({filters:[{vendorId:1155,productId:57105}]}),await Da.open(),Da.configuration||await Da.selectConfiguration(1),await Da.claimInterface(0),xa.value=!0}catch(a){a.value="Connection error: "+a,xa.value=!1}}(),xa.value&&(ga.value=0,ua.value="Firmware Update",na.value="Fetching firmware url...",fa.value=!0,await async function(){const a=Aa?.value[Ta.value],e=a?.url;try{const a=await fetch(e);if(!a.ok)throw new Error(`HTTP ${a.status}`);const t=await a.blob(),l=await t.arrayBuffer();Sa.image=l}catch(t){Sa.image=null}}(),await Oa(),fa.value=!1,"Completed"==ia.value?wa.value=!0:(ra.value="Loading firmware failed!",pa.value=!0))}function Ia(a,e){ga.value=Math.round(a/e*100),ga.value}async function ja(a,e){const t=await Da.controlTransferOut({requestType:"class",recipient:"interface",request:1,value:a,index:0},e);if("ok"!==t.status)throw new Error("DNLOAD transfer failed at block "+a);return t}async function Na(){const a=await Da.controlTransferIn({requestType:"class",recipient:"interface",request:3,value:0,index:0},6);if("ok"===a.status&&a.data&&6===a.data.byteLength){const e=new DataView(a.data.buffer);return{status:e.getUint8(0),pollTimeout:e.getUint8(1)|e.getUint8(2)<<8|e.getUint8(3)<<16,state:e.getUint8(4),iString:e.getUint8(5)}}throw new Error("Failed to read DFU status.")}async function Wa(){for(;;){const a=await Na();if(5===a.state||2===a.state)break;await ca(a.pollTimeout)}}return(a,e)=>(n(),i("div",D,[e[27]||(e[27]=u('<h1 class="title" data-v-2b586dae>DUELink Loader</h1><p class="subtitle" data-v-2b586dae> Update modules with official firmware and drivers! </p><hr class="divider" data-v-2b586dae><h2 class="section-title" data-v-2b586dae>Step 1 (Erase All)</h2><div class="card-container" data-v-2b586dae><div class="card" data-v-2b586dae><img src="'+C+'" alt="Module with USB" class="card-image" data-v-2b586dae><p class="card-text" data-v-2b586dae> Plug-in the USB cable directly... </p></div><div class="card" data-v-2b586dae><img src="'+U+'" alt="USB Hook" class="card-image" data-v-2b586dae><p class="card-text" data-v-2b586dae> ...or use an adapter on the Uplink connector. </p></div></div><p class="subtitle" data-v-2b586dae> Click the <strong data-v-2b586dae>Erase All</strong> button. The pop-up window should have a device named <em data-v-2b586dae>DUELink Official</em> or <em data-v-2b586dae>DUELink MicroBlocks</em>.<br data-v-2b586dae><br data-v-2b586dae> Select the device then click <strong data-v-2b586dae>Connect</strong>. </p><img src="'+_+'" alt="Select COM device" class="screenshot" data-v-2b586dae>',7)),o("div",x,[o("button",{class:"outline-button",onClick:e[0]||(e[0]=a=>async function(){if(m.eraseall_status_dms.value=0,0==m.isConnected.value){for(m.eraseall_vid_dms.value=0,m.connection_mode.value=2,await m.eraseall_dms_connect();0==m.eraseall_status_dms.value;)await ca(100);await ca(100)}if(0!=m.eraseall_vid_dms.value){let a=65535&m.eraseall_vid_dms.value;ha.value=62208==a?"DUELink "+ta:"MicroBlocks "+ta,da.value=!0}}())}," Erase All ")]),e[28]||(e[28]=u('<p class="subtitle" data-v-2b586dae> If the pop-up window didn&#39;t show the needed device or if <strong data-v-2b586dae>Erase All</strong> failed, visit the <a href="https://www.duelink.com/docs/loader" target="_blank" data-v-2b586dae> loader documentation page</a>. </p><hr class="divider" data-v-2b586dae><h2 class="section-title" data-v-2b586dae>Step 2 (Load Firmware/Driver)</h2><p class="subtitle" data-v-2b586dae> This step will update the firmware on a single device, or on the first device in a chain. </p><p class="subtitle" data-v-2b586dae> Click the button below then select the <em data-v-2b586dae>DFU in FS Mode</em> device and click <strong data-v-2b586dae>Connect</strong>. </p><p class="subtitle" data-v-2b586dae> If using Windows, <a href="https://www.duelink.com/bin/usb-drivers/win-usb-dfu.zip" target="_blank" data-v-2b586dae>download</a> and install the DFU driver first. </p><img src="'+k+'" alt="DFU selection" class="screenshot" data-v-2b586dae>',7)),Sa.value?(n(),i("div",E,[e[6]||(e[6]=o("label",{for:"version-select"}," Select firmware version: ",-1)),c(o("select",{id:"version-select","onUpdate:modelValue":e[1]||(e[1]=a=>Ta.value=a)},[(n(!0),i(v,null,p(Aa.value,(a,e)=>(n(),i("option",{key:a.id,value:e},f(a.name),9,L))),128))],512),[[d,Ta.value]])])):r("",!0),o("div",{class:"button-row"},[o("button",{class:"outline-button",onClick:Ba}," Load DUELink Firmware/Driver "),e[7]||(e[7]=o("hr",{class:"divider"},null,-1)),e[8]||(e[8]=o("p",{class:"subtitle"},[w(" The update steps are now complete on a single device."),o("br"),o("br"),w(" Continue to step 3 if you have multiple devices in a chain that you want to update. ")],-1))]),e[29]||(e[29]=u('<hr class="divider" data-v-2b586dae><h2 class="section-title" data-v-2b586dae>Step 3 (Update Chain)</h2><p class="subtitle" data-v-2b586dae> This optional step is for updating all modules in a chain (Daisylink). </p><p class="subtitle" data-v-2b586dae> Click the <strong data-v-2b586dae>Load Driver Script</strong> button, then select the device. You should only see one named <em data-v-2b586dae>DUELink Official</em>. </p><img src="'+_+'" alt="COM selection" class="screenshot" data-v-2b586dae>',5)),o("div",{class:"button-row"},[o("button",{class:"outline-button",onClick:Ua}," Update Chain ")]),da.value?(n(),i("div",F,[o("div",S,[e[12]||(e[12]=o("div",{class:"dialog-title"},[o("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),w(" Warning ")],-1)),o("div",T,[o("p",null,[w(f(ha.value),1),e[9]||(e[9]=o("br",null,null,-1)),e[10]||(e[10]=o("br",null,null,-1)),w(f("Are you sure you want to erase all?")),e[11]||(e[11]=o("br",null,null,-1))])]),o("div",{class:"dialog-buttons"},[o("button",{class:"yes",onClick:ma},"Yes"),o("button",{class:"no",onClick:ya},"No")])])])):r("",!0),va.value?(n(),i("div",A,[o("div",q,[e[13]||(e[13]=o("div",{class:"dialog-title-success"},[o("i",{class:"fas fa-check-circle",style:{color:"green","margin-right":"8px"}}),w(" Success ")],-1)),o("div",M,[o("p",null,f(oa.value),1)]),o("div",O,[o("button",{class:"no",onClick:e[2]||(e[2]=a=>{va.value=!1})},"Close")])])])):r("",!0),pa.value?(n(),i("div",B,[o("div",I,[e[14]||(e[14]=o("div",{class:"dialog-title"},[o("i",{class:"fa-solid fa-triangle-exclamation",style:{color:"#f5c542","margin-right":"8px"}}),w(" Failed ")],-1)),o("div",j,[o("p",null,f(ra.value),1)]),o("div",N,[o("button",{class:"no",onClick:e[3]||(e[3]=a=>{pa.value=!1})},"Close")])])])):r("",!0),wa.value?(n(),i("div",W,[o("div",P,[e[18]||(e[18]=o("div",{class:"dialog-title-success"},[o("i",{class:"fas fa-question-circle",style:{color:"white","margin-right":"8px"}}),w(" Success ")],-1)),o("div",Y,[o("p",null,[w(" Firmware "+f(qa.value?.name)+" updated. ",1),e[15]||(e[15]=o("br",null,null,-1)),e[16]||(e[16]=o("br",null,null,-1)),e[17]||(e[17]=w("Do you want to load driver? ",-1))])]),o("div",R,[o("button",{class:"yes",onClick:_a},"Yes"),o("button",{class:"no",onClick:e[4]||(e[4]=a=>wa.value=!1)},"No")])])])):r("",!0),ba.value?(n(),i("div",V,[o("div",$,[e[25]||(e[25]=o("div",{class:"dialog-title"},[o("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),w(" Warning ")],-1)),o("div",H,[o("p",null,f(La.value),1),o("p",{style:b({color:Ma.value?"#000000":"#d9534f"})},f(Fa.value),5),!1===Ma.value?(n(),i("p",z,[e[19]||(e[19]=w(" (Recommend: ",-1)),o("button",{class:"link-button underline",onClick:e[5]||(e[5]=a=>{ba.value=!1})}," Update "),e[20]||(e[20]=w(" to the latest firmware.) ",-1))])):r("",!0),e[24]||(e[24]=o("br",null,null,-1)),o("p",null,[e[21]||(e[21]=w("Do you want to load ",-1)),o("a",{target:"_blank",href:g(m).update_driver_path.value},"this driver",8,G),e[22]||(e[22]=w("?",-1)),e[23]||(e[23]=o("br",null,null,-1))])]),o("div",{class:"dialog-buttons"},[o("button",{class:"yes",onClick:ka},"Yes"),o("button",{class:"no",onClick:Ca},"No")])])])):r("",!0),fa.value?(n(),i("div",J,[o("div",K,[o("div",{class:h(["dialog-title",{"dialog-title-success":100===ga.value}])},[ga.value<100?(n(),i("i",Q)):r("",!0),w(" "+f((ga.value,ua.value)),1)],2),o("div",X,[o("div",Z,f(na.value),1),e[26]||(e[26]=o("br",null,null,-1)),o("div",aa,[o("div",{class:"update-driver-progress-bar",style:b({width:ga.value+"%"})},null,4)]),o("div",ea,f(ga.value)+"% ",1)])])])):r("",!0)]))}},[["__scopeId","data-v-2b586dae"]])).mount("#app");
