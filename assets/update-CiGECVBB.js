import{r as e,d as a,c as t,o as l,a as s,e as i,f as n,g as o,t as r,n as c,u,h as d,b as v}from"./runtime-dom.esm-bundler-DNOERz_1.js";import{_ as p,a as w}from"./console-connect-dfu-BOn47yBP.js";import{m as g,u as f}from"./mitt-BVbp22iZ.js";const m=""+new URL("../img/usbhook-rgb3.webp",import.meta.url).href,h={class:"page"},y={class:"button-row"},b={key:0,class:"overlay"},k={class:"dialog"},_={class:"dialog-body"},U={key:1,class:"overlay"},C={class:"dialog"},D={class:"dialog-body"},E={class:"dialog-buttons"},L={key:2,class:"overlay"},x={class:"dialog"},T={class:"dialog-body"},F={class:"dialog-buttons"},S={key:3,class:"overlay"},A={class:"dialog"},B={class:"dialog-buttons"},q={key:4,class:"overlay"},I={class:"dialog"},j={class:"dialog-body"},M={key:0,class:"firmware-warning"},O=["href"],P={key:5,class:"overlay"},N={class:"dialog",style:{width:"25vw"}},W={key:0,class:"fas fa-exclamation-triangle",style:{"margin-right":"8px"}},Y={class:"dialog-body"},H={class:"update-driver-progress-container"},R={class:"progress-text"},V="Firmware detected.\nAre you sure you want to erase all?",z=2048,G=134217728;v({__name:"update",setup(v){const $=g(),J=f({progress:null},$);e("");const K=e(""),Q=e(""),X=e(""),Z=e("");function ee(e){return new Promise(a=>setTimeout(a,e))}const ae=e(!1),te=e(!1),le=e(!1),se=e(!1),ie=e(!1),ne=e(!1),oe=e(0),re=e(V);async function ce(){for(ae.value=!1,oe.value=0,Q.value="Please wait...",ie.value=!0,await J.eraseall_dms_execute();J.eraseall_status_dms.value<2;)await ee(250),oe.value=50;oe.value=100,Q.value="Done",await ee(250),ie.value=!1,X.value="Erase all completed.",te.value=!0}async function ue(){ae.value=!1,J.isConnected&&(await J.disconnect(),await ee(250))}async function de(){if(se.value=!1,!J.isConnected.value){J.device_name.value="",J.driver_ver.value="",J.progress_percent.value=0,oe.value=0,J.update_driver_status.value=0,J.update_devaddr.value=1,J.connection_mode.value=1;if(await J.driver_connect()){for(Q.value="Please wait...",ie.value=!0,oe.value=0;0==J.update_driver_status.value;)await ee(100),oe.value=J.progress_percent.value;if(await ee(100),1==J.update_driver_status.value){let e=!1;const a=Date.now()+4e3;for(;!(J.isConnected.value&&""!=J.device_name.value&&""!=J.driver_ver.value||(await ee(100),Date.now()>a));)oe.value=J.progress_percent.value;J.isConnected.value&&Date.now()<a&&(e=!0),e&&(Q.value="Connected",me.value="Device Name: "+J.device_name.value,he.value="Firmware Version: "+J.version.value,ne.value=!0,oe.value=100,ie.value=!1)}ie.value=!1,oe.value=0}}}async function ve(){for(ne.value=!1,Q.value="Please wait...",ie.value=!0,J.progress_percent.value=0,oe.value=0,J.driver_update();100!=J.progress_percent.value;)await ee(1),oe.value=J.progress_percent.value;J.update_driver_status.value=0,await J.disconnect(),await ee(10),ie.value=!1,X.value="Load driver completed.",te.value=!0}async function pe(){J.isConnected.value&&(J.disconnect(),await ee(100)),ne.value=!1}let we;const ge=e(!1),fe=a({}),me=e("");e("");const he=e("");!async function(){try{const e=await fetch("https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/duelink-fw.json"),a=await e.json();Object.keys(a).forEach(e=>{fe[e]=a[e],fe[e].isGlb=!1,fe[e].image=null})}catch(e){}}();const ye=e(!0);async function be(e){const a=fe[e];await async function(e){try{0!==(await Ce()).status&&(await we.controlTransferOut({requestType:"class",recipient:"interface",request:4,value:0,index:0}),await ee(100));const a=e.byteLength;await async function(e){K.value="Erasing...",Q.value=K.value;const a=Math.ceil(e/z);for(let t=0;t<a;t++){const e=G+t*z,l=new Uint8Array(5);l[0]=65,l[1]=255&e,l[2]=e>>8&255,l[3]=e>>16&255,l[4]=e>>24&255,await Ue(0,l),await De(),_e(t,a)}K.value="Erased.",Q.value=K.value,_e(0,100)}(a),oe.value=0,ie.value=!1,await ee(250),ie.value=!0,K.value="Writing...",Q.value=K.value;let t=new Uint8Array(5);t[0]=33,t[1]=0,t[2]=0,t[3]=0,t[4]=8,await Ue(0,t),await De();let l=0,s=2;for(;l<a;){const t=e.slice(l,l+1024);await Ue(s,t),await De(),l+=t.byteLength,s++,_e(l,a)}await async function(){let e=new Uint8Array(5);try{return e[0]=33,e[1]=0,e[2]=0,e[3]=0,e[4]=8,await Ue(0,e),await De(),await Ue(0,new ArrayBuffer(0)),await De(),1}catch(a){}return 0}(),K.value="Completed"}catch(a){K.value="Failed"}Q.value=K.value}(a.image)}async function ke(){await async function(){try{ge.value=!1,we=await navigator.usb.requestDevice({filters:[{vendorId:1155,productId:57105}]}),await we.open(),we.configuration||await we.selectConfiguration(1),await we.claimInterface(0),ge.value=!0}catch(e){e.value="Connection error: "+e,ge.value=!1}}(),ge.value&&(oe.value=0,Q.value="Please wait...",ie.value=!0,await async function(e){const a=fe[e];if(!a||!Array.isArray(a.versions)||0===a.versions.length)return;const t=a.versions.reduce((e,a)=>a.id>e.id?a:e).url;try{const e=await fetch(t);if(!e.ok)throw new Error(`HTTP ${e.status}`);const l=await e.blob(),s=await l.arrayBuffer();a.image=s}catch(l){a.image=null}}("DUELink"),await be("DUELink"),ie.value=!1,"Completed"==K.value&&(se.value=!0))}function _e(e,a){oe.value=Math.round(e/a*100),oe.value}async function Ue(e,a){const t=await we.controlTransferOut({requestType:"class",recipient:"interface",request:1,value:e,index:0},a);if("ok"!==t.status)throw new Error("DNLOAD transfer failed at block "+e);return t}async function Ce(){const e=await we.controlTransferIn({requestType:"class",recipient:"interface",request:3,value:0,index:0},6);if("ok"===e.status&&e.data&&6===e.data.byteLength){const a=new DataView(e.data.buffer);return{status:a.getUint8(0),pollTimeout:a.getUint8(1)|a.getUint8(2)<<8|a.getUint8(3)<<16,state:a.getUint8(4),iString:a.getUint8(5)}}throw new Error("Failed to read DFU status.")}async function De(){for(;;){const e=await Ce();if(5===e.state||2===e.state)break;await ee(e.pollTimeout)}}return(e,a)=>(l(),t("div",h,[a[25]||(a[25]=s('<h1 class="title">DUELink Loader</h1><p class="subtitle"> This page will help in updating DUELink firmware and its related Driver. </p><hr class="divider"><h2 class="section-title">Step 1 (Erase All)</h2><div class="card-container"><div class="card"><img src="'+p+'" alt="Module with USB" class="card-image"><p class="card-text"> If your module has a USB connector, just plug it in! </p></div><div class="card"><img src="'+m+'" alt="USB Hook" class="card-image"><p class="card-text"> If your module has a <code>U</code> Uplink connector, you need a USB adaptor, like USB Hook. </p></div></div><p class="subtitle"> Click the <strong>Erase All</strong> button, then select the device. You should only see one named <em>DUELink Official</em> or <em>DUELink MicroBlocks</em>. </p><img src="'+w+'" alt="Select DFU device" class="screenshot">',7)),i("div",y,[i("button",{class:"outline-button",onClick:a[0]||(a[0]=e=>async function(){if(J.eraseall_status_dms.value=0,0==J.isConnected.value){for(J.eraseall_vid_dms.value=0,J.connection_mode.value=2,await J.eraseall_dms_connect();0==J.eraseall_status_dms.value;)await ee(100);await ee(100)}if(0!=J.eraseall_vid_dms.value){let e=65535&J.eraseall_vid_dms.value;re.value=62208==e?"DUELink "+V:"MicroBlocks "+V,ae.value=!0}}())}," Erase All ")]),a[26]||(a[26]=s('<p class="subtitle"> If <strong>Erase All</strong> failed, visit the <a href="https://www.duelink.com/docs/loader" target="_blank"> loader documentation page </a>. </p><hr class="divider"><h2 class="section-title">Step 2 (Load Firmware/Driver)</h2><p class="subtitle"> This step will update the firmware on a single device, or on the first device in a chain. </p><p class="subtitle"> Click the button below then select the <em>DFU in FS Mode</em> device and click <strong>Connect</strong>. </p><p class="subtitle"> If using Windows, <a href="https://www.duelink.com/bin/usb-drivers/win-usb-dfu.zip" target="_blank">download</a> and install the DFU driver first. </p><img src="'+w+'" alt="DFU selection" class="screenshot">',7)),i("div",{class:"button-row"},[i("button",{class:"outline-button",onClick:ke}," Load DUELink Firmware/Driver "),a[5]||(a[5]=i("hr",{class:"divider"},null,-1)),a[6]||(a[6]=i("p",{class:"subtitle"},[o(" The update steps are now complete on a single device."),i("br"),i("br"),o(" Continue to step 3 if you have multiple devices in a chain that you want to update. ")],-1))]),a[27]||(a[27]=s('<hr class="divider"><h2 class="section-title">Step 3 (Update Chain)</h2><p class="subtitle"> This optional step is for updating all modules in a chain (Daisylink). </p><p class="subtitle"> Click the <strong>Load Driver Script</strong> button, then select the device. You should only see one named <em>DUELink Official</em>. </p><img src="'+w+'" alt="Driver selection" class="screenshot"><div class="button-row"><button class="outline-button"> Update Chain </button></div>',6)),ae.value?(l(),t("div",b,[i("div",k,[a[9]||(a[9]=i("div",{class:"dialog-title"},[i("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),o(" Warning ")],-1)),i("div",_,[i("p",null,[o(r(re.value),1),a[7]||(a[7]=i("br",null,null,-1)),a[8]||(a[8]=i("br",null,null,-1))])]),i("div",{class:"dialog-buttons"},[i("button",{class:"yes",onClick:ce},"Yes"),i("button",{class:"no",onClick:ue},"No")])])])):n("",!0),te.value?(l(),t("div",U,[i("div",C,[a[10]||(a[10]=i("div",{class:"dialog-title-success"},[i("i",{class:"fas fa-check-circle",style:{color:"green","margin-right":"8px"}}),o(" Success ")],-1)),i("div",D,[i("p",null,r(X.value),1)]),i("div",E,[i("button",{class:"no",onClick:a[1]||(a[1]=e=>{te.value=!1})},"Close")])])])):n("",!0),le.value?(l(),t("div",L,[i("div",x,[a[11]||(a[11]=i("div",{class:"dialog-title"},[i("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),o(" Failed ")],-1)),i("div",T,[i("p",null,r(Z.value),1)]),i("div",F,[i("button",{class:"no",onClick:a[2]||(a[2]=e=>{le.value=!1})},"Close")])])])):n("",!0),se.value?(l(),t("div",S,[i("div",A,[a[12]||(a[12]=i("div",{class:"dialog-title"},[i("i",{class:"fas fa-question-circle",style:{color:"white","margin-right":"8px"}}),o(" Warning ")],-1)),a[13]||(a[13]=i("div",{class:"dialog-body"},[i("p",null," Firmware updated. Do you want to load driver? ")],-1)),i("div",B,[i("button",{class:"yes",onClick:de},"Yes"),i("button",{class:"no",onClick:a[3]||(a[3]=e=>se.value=!1)},"No")])])])):n("",!0),ne.value?(l(),t("div",q,[i("div",I,[a[23]||(a[23]=i("div",{class:"dialog-title"},[i("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),o(" Warning ")],-1)),i("div",j,[i("p",null,[o(r(me.value),1),a[14]||(a[14]=i("br",null,null,-1))]),i("p",{style:c({color:ye.value?"#000000":"#d9534f"})},[o(r(he.value),1),a[15]||(a[15]=i("br",null,null,-1))],4),!1===ye.value?(l(),t("p",M,[a[16]||(a[16]=o(" (Recommend: ",-1)),i("button",{class:"link-button underline",onClick:a[4]||(a[4]=a=>{ne.value=!1,e.dfuModal.start()})}," Update "),a[17]||(a[17]=o(" to the latest firmware.) ",-1))])):n("",!0),a[22]||(a[22]=i("br",null,null,-1)),i("p",null,[a[18]||(a[18]=o("Do you want to load ",-1)),i("a",{target:"_blank",href:u(J).update_driver_path.value},"this driver",8,O),a[19]||(a[19]=o("?",-1)),a[20]||(a[20]=i("br",null,null,-1)),a[21]||(a[21]=i("br",null,null,-1))])]),i("div",{class:"dialog-buttons"},[i("button",{class:"yes",onClick:ve},"Yes"),i("button",{class:"no",onClick:pe},"No")])])])):n("",!0),ie.value?(l(),t("div",P,[i("div",N,[i("div",{class:d(["dialog-title",{"dialog-title-success":100===oe.value}])},[oe.value<100?(l(),t("i",W)):n("",!0),o(" "+r((oe.value,Q.value)),1)],2),i("div",Y,[a[24]||(a[24]=i("br",null,null,-1)),i("div",H,[i("div",{class:"update-driver-progress-bar",style:c({width:oe.value+"%"})},null,4)]),i("div",R,r(oe.value)+"% ",1)])])])):n("",!0)]))}}).mount("#app");
