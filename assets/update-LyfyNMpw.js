import{_ as a,e,o as t,c as l,a as s,f as i,w as n,v as o,g as u,r,h as c,i as v,t as d,n as p,u as w,j as f,b as g,F as b,k as m,l as h,m as y,d as _}from"./Footer-CqatApVj.js";import{_ as k,a as C}from"./console-connect-dfu-CrgV8XxQ.js";import{u as U}from"./useWebSerial-Beh64OSw.js";const D=""+new URL("../img/stamp-usb-connect.webp",import.meta.url).href,E=""+new URL("../img/usbhook-rgb3.webp",import.meta.url).href,L={class:"page"},F={key:0,class:"version-select"},x=["value"],T={key:1,class:"overlay"},S={class:"dialog"},A={class:"dialog-body"},j={key:2,class:"overlay"},q={class:"dialog"},M={class:"dialog-body"},O={class:"dialog-buttons"},B={key:3,class:"overlay"},I={class:"dialog"},N={class:"dialog-body"},W={class:"dialog-buttons"},P={key:4,class:"overlay"},Y={class:"dialog"},R={class:"dialog-body"},V={class:"dialog-buttons"},H={key:5,class:"overlay"},z={class:"dialog"},G={class:"dialog-body"},$={key:0,class:"firmware-warning"},J=["href"],K={key:6,class:"overlay"},Q={class:"dialog",style:{width:"25vw"}},X={key:0,class:"fas fa-exclamation-triangle",style:{"margin-right":"8px"}},Z={class:"dialog-body"},aa={class:"progress-text"},ea={key:0},ta={class:"update-driver-progress-container"},la={class:"progress-text"},sa={class:"dialog-buttons"},ia="Firmware detected.",na=2048,oa=134217728;_(a({__name:"update",setup(a){const _=U();e(async()=>{await async function(){try{const a=await fetch("https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/duelink-fw.json"),e=await a.json();Object.keys(e).forEach(a=>{Sa[a]=e[a],Sa[a].isGlb=!1,Sa[a].image=null})}catch(a){}}()});const ua=y(""),ra=y(""),ca=y(""),va=y(""),da=y("");function pa(a){return new Promise(e=>setTimeout(e,a))}const wa=y(!1),fa=y(!1),ga=y(!1),ba=y(!1),ma=y(!1),ha=y(!1),ya=y(0),_a=y(!1),ka=y(ia);async function Ca(){for(wa.value=!1,_a.value=!1,ya.value=0,ca.value="Erase All",ra.value="Erasing....",ma.value=!0,await _.eraseall_dms_execute();_.eraseall_status_dms.value<2;)await pa(250),ya.value=50;ya.value=100,ca.value="Done",await pa(250),ma.value=!1,va.value="Erase all completed.",fa.value=!0}async function Ua(){wa.value=!1,_.isConnected&&(await _.disconnect(),await pa(250))}async function Da(){if(ba.value=!1,!_.isConnected.value){_.device_name.value="",_.driver_ver.value="",_.progress_percent.value=0,ya.value=0,_.update_driver_status.value=0,_.update_devaddr.value=1,_.connection_mode.value=1;if(await _.driver_connect()){for(ca.value="Driver Update",ra.value="Connecting...",ma.value=!0,ya.value=0;0==_.update_driver_status.value;)await pa(100),ya.value=_.progress_percent.value;if(await pa(100),1==_.update_driver_status.value){let a=!1;const e=Date.now()+4e3;for(;!(_.isConnected.value&&""!=_.device_name.value&&""!=_.driver_ver.value||(await pa(100),Date.now()>e));)ya.value=_.progress_percent.value;_.isConnected.value&&Date.now()<e&&(a=!0),a&&(Aa.value="Device Name: "+_.device_name.value,ja.value="Firmware Version: "+_.version.value,ha.value=!0,ya.value=100,ma.value=!1)}ma.value=!1,ya.value=0}}}async function Ea(){for(ha.value=!1,ca.value="Driver Update",ra.value="Writing driver...",ma.value=!0,_.progress_percent.value=0,ya.value=0,_.driver_update();100!=_.progress_percent.value;)await pa(1),ya.value=_.progress_percent.value;_.update_driver_status.value=0,await _.disconnect(),await pa(10),ma.value=!1,va.value="Load driver completed.",fa.value=!0}async function La(){_.isConnected.value&&(_.disconnect(),await pa(100)),ha.value=!1}async function Fa(){if(_a.value=!1,ca.value="Update Chain",ra.value="Please wait...",0==_.isConnected.value&&await async function(){if(_.connect_status.value=0,_.connection_mode.value=0,_.update_driver_status.value=0,ya.value=0,_.progress_percent.value=0,await _.connect()){for(ra.value="Connecting to device 1...",ma.value=!0,ya.value=0;0==_.connect_status.value&&(await pa(100),ya.value=_.progress_percent.value,71!=ya.value););_.connect_status.value>0&&(ya.value=99,await pa(100)),ma.value=!1,ya.value=0,await pa(100),_.connect_status.value<0&&(da.value="Connection failed",ga.value=!0)}}(),0!=_.isConnected.value){for(_.clone_fw_status.value=0,await pa(50),ma.value=!0,_.progress_percent.value=0,ya.value=0,_.do_clone_fw(1,200),_.progress_percent.value=0;0==_.clone_fw_status.value;)await pa(100),ra.value=_.progress_body_text.value,ya.value=_.progress_percent.value;if(await pa(100),_.disconnect(),_.clone_fw_status.value>1){const a=ra.value.split("\n");a.pop(),ra.value=a.join("\n"),_a.value=!0}else ma.value=!1,da.value="No devices were cloned successfully.",ga.value=!0}}let xa;const Ta=y(!1),Sa=m({}),Aa=y(""),ja=y(""),qa=h(()=>Sa.DUELink),Ma=y(0),Oa=h(()=>qa.value?.versions?[...qa.value.versions].sort((a,e)=>e.id-a.id):[]),Ba=h(()=>Oa.value[Ma.value]||null),Ia=y(!0);async function Na(){const a=qa;await async function(a){try{0!==(await Ra()).status&&(await xa.controlTransferOut({requestType:"class",recipient:"interface",request:4,value:0,index:0}),await pa(100));const e=a.byteLength;await async function(a){ua.value="Erasing...",ra.value=ua.value;const e=Math.ceil(a/na);for(let t=0;t<e;t++){const a=oa+t*na,l=new Uint8Array(5);l[0]=65,l[1]=255&a,l[2]=a>>8&255,l[3]=a>>16&255,l[4]=a>>24&255,await Ya(0,l),await Va(),Pa(t,e)}ua.value="Erased.",ra.value=ua.value,Pa(0,100)}(e),ya.value=0,ma.value=!1,await pa(250),ma.value=!0,ua.value="Writing...",ra.value=ua.value;let t=new Uint8Array(5);t[0]=33,t[1]=0,t[2]=0,t[3]=0,t[4]=8,await Ya(0,t),await Va();let l=0,s=2;for(;l<e;){const t=a.slice(l,l+1024);await Ya(s,t),await Va(),l+=t.byteLength,s++,Pa(l,e)}await async function(){let a=new Uint8Array(5);try{return a[0]=33,a[1]=0,a[2]=0,a[3]=0,a[4]=8,await Ya(0,a),await Va(),await Ya(0,new ArrayBuffer(0)),await Va(),1}catch(e){}return 0}(),ua.value="Completed"}catch(e){ua.value="Failed"}ra.value=ua.value}(a.image)}async function Wa(){await async function(){try{Ta.value=!1,xa=await navigator.usb.requestDevice({filters:[{vendorId:1155,productId:57105}]}),await xa.open(),xa.configuration||await xa.selectConfiguration(1),await xa.claimInterface(0),Ta.value=!0}catch(a){a.value="Connection error: "+a,Ta.value=!1}}(),Ta.value&&(ya.value=0,ca.value="Firmware Update",ra.value="Fetching firmware url...",ma.value=!0,await async function(){const a=Oa?.value[Ma.value],e=a?.url;try{const a=await fetch(e);if(!a.ok)throw new Error(`HTTP ${a.status}`);const t=await a.blob(),l=await t.arrayBuffer();qa.image=l}catch(t){qa.image=null}}(),await Na(),ma.value=!1,"Completed"==ua.value?ba.value=!0:(da.value="Loading firmware failed!",ga.value=!0))}function Pa(a,e){ya.value=Math.round(a/e*100),ya.value}async function Ya(a,e){const t=await xa.controlTransferOut({requestType:"class",recipient:"interface",request:1,value:a,index:0},e);if("ok"!==t.status)throw new Error("DNLOAD transfer failed at block "+a);return t}async function Ra(){const a=await xa.controlTransferIn({requestType:"class",recipient:"interface",request:3,value:0,index:0},6);if("ok"===a.status&&a.data&&6===a.data.byteLength){const e=new DataView(a.data.buffer);return{status:e.getUint8(0),pollTimeout:e.getUint8(1)|e.getUint8(2)<<8|e.getUint8(3)<<16,state:e.getUint8(4),iString:e.getUint8(5)}}throw new Error("Failed to read DFU status.")}async function Va(){for(;;){const a=await Ra();if(5===a.state||2===a.state)break;await pa(a.pollTimeout)}}return(a,e)=>(t(),l("div",L,[e[27]||(e[27]=s('<h1 class="title" data-v-3463853b>DUELink Loader</h1><p data-v-3463853b> Update modules with official firmware and drivers! </p><hr data-v-3463853b><h2 data-v-3463853b>Step 1: Erase All</h2><div class="card-container" data-v-3463853b><div class="card" data-v-3463853b><img src="'+D+'" alt="Module with USB" class="card-image" data-v-3463853b><p data-v-3463853b> Plug-in the USB cable directly... </p></div><div class="card" data-v-3463853b><img src="'+E+'" alt="USB Hook" class="card-image" data-v-3463853b><p data-v-3463853b> ...or use an adapter on the Uplink connector. </p></div></div><p data-v-3463853b> Click the <strong data-v-3463853b>Erase All</strong> button. The pop-up window should have a device named <em data-v-3463853b>DUELink Official</em> or <em data-v-3463853b>DUELink MicroBlocks</em>.<br data-v-3463853b><br data-v-3463853b> Select the device then click <strong data-v-3463853b>Connect</strong>. </p><img src="'+k+'" alt="Select COM device" data-v-3463853b>',7)),i("div",null,[i("button",{class:"outline-button",onClick:e[0]||(e[0]=a=>async function(){if(_.eraseall_status_dms.value=0,0==_.isConnected.value){for(_.eraseall_vid_dms.value=0,_.connection_mode.value=2,await _.eraseall_dms_connect();0==_.eraseall_status_dms.value;)await pa(100);await pa(100)}if(0!=_.eraseall_vid_dms.value){let a=65535&_.eraseall_vid_dms.value;ka.value=62208==a?"DUELink "+ia:"MicroBlocks "+ia,wa.value=!0}}())}," Erase All ")]),e[28]||(e[28]=s('<p data-v-3463853b> If the pop-up window didn&#39;t show the needed device or if <strong data-v-3463853b>Erase All</strong> failed, your device might already be erased. Try Step 2 or visit the <a href="https://www.duelink.com/docs/loader" target="_blank" data-v-3463853b>loader documentation page</a>. </p><hr data-v-3463853b><h2 data-v-3463853b>Step 2: Load Firmware/Driver</h2><p data-v-3463853b> This step will update the firmware on a single device, or on the first device in a chain. </p><p data-v-3463853b> Click the button below then select the <em data-v-3463853b>DFU in FS Mode</em> device and click <strong data-v-3463853b>Connect</strong>. </p><p data-v-3463853b> If using Windows, <a href="https://www.duelink.com/bin/usb-drivers/win-usb-dfu.zip" target="_blank" data-v-3463853b>download</a> and install the DFU driver first. </p><img src="'+C+'" alt="DFU selection" data-v-3463853b>',7)),qa.value?(t(),l("div",F,[e[7]||(e[7]=i("label",{for:"version-select"}," Select DUELink firmware version: ",-1)),n(i("select",{id:"version-select","onUpdate:modelValue":e[1]||(e[1]=a=>Ma.value=a)},[(t(!0),l(u,null,r(Oa.value,(a,e)=>(t(),l("option",{key:a.id,value:e},d(a.name),9,x))),128))],512),[[o,Ma.value]])])):c("",!0),i("div",null,[i("button",{class:"outline-button",onClick:Wa}," Load DUELink Firmware/Driver "),e[8]||(e[8]=i("p",null,[v(" The update steps are now complete on a single device."),i("br"),i("br"),v(" Continue to step 3 if you have multiple devices in a chain that you want to update. ")],-1))]),e[29]||(e[29]=i("hr",null,null,-1)),e[30]||(e[30]=i("h2",null,"Step 3: Update Chain",-1)),e[31]||(e[31]=i("p",null," This optional step uses the first moudle to update all other modules in a chain (Daisylink). ",-1)),e[32]||(e[32]=i("p",null,[v(" Click the "),i("strong",null,"Update Chain"),v(" button, then select the device. You should only see one named "),i("em",null,"DUELink Official"),v(". ")],-1)),e[33]||(e[33]=i("img",{src:k,alt:"COM selection"},null,-1)),i("div",null,[i("button",{class:"outline-button",onClick:Fa}," Update Chain ")]),e[34]||(e[34]=i("p",null,[v(" For any issues, consult the "),i("a",{href:"https://www.duelink.com/docs/loader",target:"_blank"}," loader documentation"),v(" page. ")],-1)),wa.value?(t(),l("div",T,[i("div",S,[e[12]||(e[12]=i("div",{class:"dialog-title"},[i("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),v(" Warning ")],-1)),i("div",A,[i("p",null,[v(d(ka.value),1),e[9]||(e[9]=i("br",null,null,-1)),e[10]||(e[10]=i("br",null,null,-1)),v(d("Are you sure you want to erase all?")),e[11]||(e[11]=i("br",null,null,-1))])]),i("div",{class:"dialog-buttons"},[i("button",{class:"yes",onClick:Ca},"Yes"),i("button",{class:"no",onClick:Ua},"No")])])])):c("",!0),fa.value?(t(),l("div",j,[i("div",q,[e[13]||(e[13]=i("div",{class:"dialog-title-success"},[i("i",{class:"fas fa-check-circle",style:{color:"green","margin-right":"8px"}}),v(" Success ")],-1)),i("div",M,[i("p",null,d(va.value),1)]),i("div",O,[i("button",{class:"no",onClick:e[2]||(e[2]=a=>{fa.value=!1})},"Close")])])])):c("",!0),ga.value?(t(),l("div",B,[i("div",I,[e[14]||(e[14]=i("div",{class:"dialog-title"},[i("i",{class:"fa-solid fa-triangle-exclamation",style:{color:"#f5c542","margin-right":"8px"}}),v(" Failed ")],-1)),i("div",N,[i("p",null,d(da.value),1)]),i("div",W,[i("button",{class:"no",onClick:e[3]||(e[3]=a=>{ga.value=!1})},"Close")])])])):c("",!0),ba.value?(t(),l("div",P,[i("div",Y,[e[18]||(e[18]=i("div",{class:"dialog-title-success"},[i("i",{class:"fas fa-question-circle",style:{color:"white","margin-right":"8px"}}),v(" Success ")],-1)),i("div",R,[i("p",null,[v(" Firmware "+d(Ba.value?.name)+" updated. ",1),e[15]||(e[15]=i("br",null,null,-1)),e[16]||(e[16]=i("br",null,null,-1)),e[17]||(e[17]=v("Do you want to load driver? ",-1))])]),i("div",V,[i("button",{class:"yes",onClick:Da},"Yes"),i("button",{class:"no",onClick:e[4]||(e[4]=a=>ba.value=!1)},"No")])])])):c("",!0),ha.value?(t(),l("div",H,[i("div",z,[e[25]||(e[25]=i("div",{class:"dialog-title"},[i("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),v(" Warning ")],-1)),i("div",G,[i("p",null,d(Aa.value),1),i("p",{style:p({color:Ia.value?"#000000":"#d9534f"})},d(ja.value),5),!1===Ia.value?(t(),l("p",$,[e[19]||(e[19]=v(" (Recommend: ",-1)),i("button",{class:"link-button underline",onClick:e[5]||(e[5]=a=>{ha.value=!1})}," Update "),e[20]||(e[20]=v(" to the latest firmware.) ",-1))])):c("",!0),e[24]||(e[24]=i("br",null,null,-1)),i("p",null,[e[21]||(e[21]=v("Do you want to load ",-1)),i("a",{target:"_blank",href:w(_).update_driver_path.value},"this driver",8,J),e[22]||(e[22]=v("?",-1)),e[23]||(e[23]=i("br",null,null,-1))])]),i("div",{class:"dialog-buttons"},[i("button",{class:"yes",onClick:Ea},"Yes"),i("button",{class:"no",onClick:La},"No")])])])):c("",!0),ma.value?(t(),l("div",K,[i("div",Q,[i("div",{class:f(["dialog-title",{"dialog-title-success":!0===_a.value}])},[ya.value<100?(t(),l("i",X)):c("",!0),v(" "+d((ya.value,ca.value)),1)],2),i("div",Z,[i("div",aa,d(ra.value),1),e[26]||(e[26]=i("br",null,null,-1)),_a.value?c("",!0):(t(),l("div",ea,[i("div",ta,[i("div",{class:"update-driver-progress-bar",style:p({width:ya.value+"%"})},null,4)]),i("div",la,d(ya.value)+"% ",1)])),i("div",sa,[_a.value?(t(),l("button",{key:0,class:"no",onClick:e[6]||(e[6]=a=>{ma.value=!1,_a.value=!1})}," Close ")):c("",!0)])])])])):c("",!0),g(b)]))}},[["__scopeId","data-v-3463853b"]])).mount("#app");
