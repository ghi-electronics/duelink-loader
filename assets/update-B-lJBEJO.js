import{_ as e,d as a,o as t,c as l,a as s,e as i,w as n,v as u,F as o,r,f as c,g as v,t as d,n as f,u as p,h as w,i as g,j as h,k as m,b as y}from"./_plugin-vue_export-helper-C4YAnmRp.js";import{u as _,_ as b,a as k,b as C}from"./useWebSerial-Bqn4S0wa.js";const U=""+new URL("../img/usbhook-rgb3.webp",import.meta.url).href,D={class:"page"},E={key:0,class:"version-select"},x=["value"],L={key:1,class:"overlay"},F={class:"dialog"},S={class:"dialog-body"},T={key:2,class:"overlay"},A={class:"dialog"},q={class:"dialog-body"},M={class:"dialog-buttons"},O={key:3,class:"overlay"},B={class:"dialog"},I={class:"dialog-body"},j={class:"dialog-buttons"},N={key:4,class:"overlay"},W={class:"dialog"},P={class:"dialog-body"},Y={class:"dialog-buttons"},V={key:5,class:"overlay"},$={class:"dialog"},H={class:"dialog-body"},R={key:0,class:"firmware-warning"},z=["href"],G={key:6,class:"overlay"},J={class:"dialog",style:{width:"25vw"}},K={key:0,class:"fas fa-exclamation-triangle",style:{"margin-right":"8px"}},Q={class:"dialog-body"},X={class:"progress-text"},Z={class:"update-driver-progress-container"},ee={class:"progress-text"},ae="Firmware detected.",te=2048,le=134217728;y(e({__name:"update",setup(e){const y=_();a(async()=>{await async function(){try{const e=await fetch("https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/duelink-fw.json"),a=await e.json();Object.keys(a).forEach(e=>{Ee[e]=a[e],Ee[e].isGlb=!1,Ee[e].image=null})}catch(e){}}()});const se=m(""),ie=m(""),ne=m(""),ue=m(""),oe=m("");function re(e){return new Promise(a=>setTimeout(a,e))}const ce=m(!1),ve=m(!1),de=m(!1),fe=m(!1),pe=m(!1),we=m(!1),ge=m(0),he=m(ae);async function me(){for(ce.value=!1,ge.value=0,ne.value="Erase All",ie.value="Erasing....",pe.value=!0,await y.eraseall_dms_execute();y.eraseall_status_dms.value<2;)await re(250),ge.value=50;ge.value=100,ne.value="Done",await re(250),pe.value=!1,ue.value="Erase all completed.",ve.value=!0}async function ye(){ce.value=!1,y.isConnected&&(await y.disconnect(),await re(250))}async function _e(){if(fe.value=!1,!y.isConnected.value){y.device_name.value="",y.driver_ver.value="",y.progress_percent.value=0,ge.value=0,y.update_driver_status.value=0,y.update_devaddr.value=1,y.connection_mode.value=1;if(await y.driver_connect()){for(ne.value="Driver Update",ie.value="Connecting...",pe.value=!0,ge.value=0;0==y.update_driver_status.value;)await re(100),ge.value=y.progress_percent.value;if(await re(100),1==y.update_driver_status.value){let e=!1;const a=Date.now()+4e3;for(;!(y.isConnected.value&&""!=y.device_name.value&&""!=y.driver_ver.value||(await re(100),Date.now()>a));)ge.value=y.progress_percent.value;y.isConnected.value&&Date.now()<a&&(e=!0),e&&(xe.value="Device Name: "+y.device_name.value,Le.value="Firmware Version: "+y.version.value,we.value=!0,ge.value=100,pe.value=!1)}pe.value=!1,ge.value=0}}}async function be(){for(we.value=!1,ne.value="Driver Update",ie.value="Writing driver...",pe.value=!0,y.progress_percent.value=0,ge.value=0,y.driver_update();100!=y.progress_percent.value;)await re(1),ge.value=y.progress_percent.value;y.update_driver_status.value=0,await y.disconnect(),await re(10),pe.value=!1,ue.value="Load driver completed.",ve.value=!0}async function ke(){y.isConnected.value&&(y.disconnect(),await re(100)),we.value=!1}async function Ce(){if(ne.value="Update Chain",0==y.isConnected.value&&await async function(){if(y.connect_status.value=0,y.connection_mode.value=0,y.update_driver_status.value=0,ge.value=0,y.progress_percent.value=0,await y.connect()){for(ie.value="Connecting to device 1...",pe.value=!0,ge.value=0;0==y.connect_status.value&&(await re(100),ge.value=y.progress_percent.value,71!=ge.value););y.connect_status.value>0&&(ge.value=99,await re(100)),pe.value=!1,ge.value=0,await re(100),y.connect_status.value<0&&(oe.value="Connection failed",de.value=!0)}}(),0!=y.isConnected.value){for(y.clone_fw_status.value=0,ie.value="Please wait...",pe.value=!0,y.progress_percent.value=0,ge.value=0,y.do_clone_fw(1,200),y.progress_percent.value=0;0==y.clone_fw_status.value;)await re(100),ie.value=y.progress_body_text.value,ge.value=y.progress_percent.value;await re(100),pe.value=!1,y.disconnect(),y.clone_fw_status.value>1?(2==y.clone_fw_status.value?ue.value=`A total of ${y.clone_fw_status.value-1} device was successfully cloned and its driver updated.`:ue.value=`A total of ${y.clone_fw_status.value-1} devices were successfully cloned and had their drivers updated.`,ve.value=!0):(oe.value="No devices were cloned successfully.",de.value=!0)}}let Ue;const De=m(!1),Ee=g({}),xe=m(""),Le=m(""),Fe=h(()=>Ee.DUELink),Se=m(0),Te=h(()=>Fe.value?.versions?[...Fe.value.versions].sort((e,a)=>a.id-e.id):[]),Ae=h(()=>Te.value[Se.value]||null),qe=m(!0);async function Me(){const e=Fe;await async function(e){try{0!==(await je()).status&&(await Ue.controlTransferOut({requestType:"class",recipient:"interface",request:4,value:0,index:0}),await re(100));const a=e.byteLength;await async function(e){se.value="Erasing...",ie.value=se.value;const a=Math.ceil(e/te);for(let t=0;t<a;t++){const e=le+t*te,l=new Uint8Array(5);l[0]=65,l[1]=255&e,l[2]=e>>8&255,l[3]=e>>16&255,l[4]=e>>24&255,await Ie(0,l),await Ne(),Be(t,a)}se.value="Erased.",ie.value=se.value,Be(0,100)}(a),ge.value=0,pe.value=!1,await re(250),pe.value=!0,se.value="Writing...",ie.value=se.value;let t=new Uint8Array(5);t[0]=33,t[1]=0,t[2]=0,t[3]=0,t[4]=8,await Ie(0,t),await Ne();let l=0,s=2;for(;l<a;){const t=e.slice(l,l+1024);await Ie(s,t),await Ne(),l+=t.byteLength,s++,Be(l,a)}await async function(){let e=new Uint8Array(5);try{return e[0]=33,e[1]=0,e[2]=0,e[3]=0,e[4]=8,await Ie(0,e),await Ne(),await Ie(0,new ArrayBuffer(0)),await Ne(),1}catch(a){}return 0}(),se.value="Completed"}catch(a){se.value="Failed"}ie.value=se.value}(e.image)}async function Oe(){await async function(){try{De.value=!1,Ue=await navigator.usb.requestDevice({filters:[{vendorId:1155,productId:57105}]}),await Ue.open(),Ue.configuration||await Ue.selectConfiguration(1),await Ue.claimInterface(0),De.value=!0}catch(e){e.value="Connection error: "+e,De.value=!1}}(),De.value&&(ge.value=0,ne.value="Firmware Update",ie.value="Fetching firmware url...",pe.value=!0,await async function(){const e=Te?.value[Se.value],a=e?.url;try{const e=await fetch(a);if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.blob(),l=await t.arrayBuffer();Fe.image=l}catch(t){Fe.image=null}}(),await Me(),pe.value=!1,"Completed"==se.value?fe.value=!0:(oe.value="Loading firmware failed!",de.value=!0))}function Be(e,a){ge.value=Math.round(e/a*100),ge.value}async function Ie(e,a){const t=await Ue.controlTransferOut({requestType:"class",recipient:"interface",request:1,value:e,index:0},a);if("ok"!==t.status)throw new Error("DNLOAD transfer failed at block "+e);return t}async function je(){const e=await Ue.controlTransferIn({requestType:"class",recipient:"interface",request:3,value:0,index:0},6);if("ok"===e.status&&e.data&&6===e.data.byteLength){const a=new DataView(e.data.buffer);return{status:a.getUint8(0),pollTimeout:a.getUint8(1)|a.getUint8(2)<<8|a.getUint8(3)<<16,state:a.getUint8(4),iString:a.getUint8(5)}}throw new Error("Failed to read DFU status.")}async function Ne(){for(;;){const e=await je();if(5===e.state||2===e.state)break;await re(e.pollTimeout)}}return(e,a)=>(t(),l("div",D,[a[26]||(a[26]=s('<h1 class="title" data-v-3fa7e6e2>DUELink Loader</h1><p data-v-3fa7e6e2> Update modules with official firmware and drivers! </p><hr data-v-3fa7e6e2><h2 data-v-3fa7e6e2>Step 1: Erase All</h2><div class="card-container" data-v-3fa7e6e2><div class="card" data-v-3fa7e6e2><img src="'+b+'" alt="Module with USB" class="card-image" data-v-3fa7e6e2><p class="card-text" data-v-3fa7e6e2> Plug-in the USB cable directly... </p></div><div class="card" data-v-3fa7e6e2><img src="'+U+'" alt="USB Hook" class="card-image" data-v-3fa7e6e2><p class="card-text" data-v-3fa7e6e2> ...or use an adapter on the Uplink connector. </p></div></div><p data-v-3fa7e6e2> Click the <strong data-v-3fa7e6e2>Erase All</strong> button. The pop-up window should have a device named <em data-v-3fa7e6e2>DUELink Official</em> or <em data-v-3fa7e6e2>DUELink MicroBlocks</em>.<br data-v-3fa7e6e2><br data-v-3fa7e6e2> Select the device then click <strong data-v-3fa7e6e2>Connect</strong>. </p><img src="'+k+'" alt="Select COM device" class="screenshot" data-v-3fa7e6e2>',7)),i("div",null,[i("button",{class:"outline-button",onClick:a[0]||(a[0]=e=>async function(){if(y.eraseall_status_dms.value=0,0==y.isConnected.value){for(y.eraseall_vid_dms.value=0,y.connection_mode.value=2,await y.eraseall_dms_connect();0==y.eraseall_status_dms.value;)await re(100);await re(100)}if(0!=y.eraseall_vid_dms.value){let e=65535&y.eraseall_vid_dms.value;he.value=62208==e?"DUELink "+ae:"MicroBlocks "+ae,ce.value=!0}}())}," Erase All ")]),a[27]||(a[27]=s('<p data-v-3fa7e6e2> If the pop-up window didn&#39;t show the needed device or if <strong data-v-3fa7e6e2>Erase All</strong> failed, your device might already be erased. Try Step 2 or visit the <a href="https://www.duelink.com/docs/loader" target="_blank" data-v-3fa7e6e2>loader documentation page</a>. </p><hr data-v-3fa7e6e2><h2 data-v-3fa7e6e2>Step 2: Load Firmware/Driver</h2><p data-v-3fa7e6e2> This step will update the firmware on a single device, or on the first device in a chain. </p><p data-v-3fa7e6e2> Click the button below then select the <em data-v-3fa7e6e2>DFU in FS Mode</em> device and click <strong data-v-3fa7e6e2>Connect</strong>. </p><p data-v-3fa7e6e2> If using Windows, <a href="https://www.duelink.com/bin/usb-drivers/win-usb-dfu.zip" target="_blank" data-v-3fa7e6e2>download</a> and install the DFU driver first. </p><img src="'+C+'" alt="DFU selection" class="screenshot" data-v-3fa7e6e2>',7)),Fe.value?(t(),l("div",E,[a[6]||(a[6]=i("label",{for:"version-select"}," Select DUELink firmware version: ",-1)),n(i("select",{id:"version-select","onUpdate:modelValue":a[1]||(a[1]=e=>Se.value=e)},[(t(!0),l(o,null,r(Te.value,(e,a)=>(t(),l("option",{key:e.id,value:a},d(e.name),9,x))),128))],512),[[u,Se.value]])])):c("",!0),i("div",null,[i("button",{class:"outline-button",onClick:Oe}," Load DUELink Firmware/Driver "),a[7]||(a[7]=i("p",null,[v(" The update steps are now complete on a single device."),i("br"),i("br"),v(" Continue to step 3 if you have multiple devices in a chain that you want to update. ")],-1))]),a[28]||(a[28]=i("hr",null,null,-1)),a[29]||(a[29]=i("h2",null,"Step 3: Update Chain",-1)),a[30]||(a[30]=i("p",null," This optional step is for updating all modules in a chain (Daisylink). ",-1)),a[31]||(a[31]=i("p",null,[v(" Click the "),i("strong",null,"Load Driver Script"),v(" button, then select the device. You should only see one named "),i("em",null,"DUELink Official"),v(". ")],-1)),a[32]||(a[32]=i("img",{src:k,alt:"COM selection",class:"screenshot"},null,-1)),i("div",null,[i("button",{class:"outline-button",onClick:Ce}," Update Chain ")]),a[33]||(a[33]=i("p",null,[v(" For any issues, consult the "),i("a",{href:"https://www.duelink.com/docs/loader",target:"_blank"}," loader documentation"),v(" page. ")],-1)),ce.value?(t(),l("div",L,[i("div",F,[a[11]||(a[11]=i("div",{class:"dialog-title"},[i("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),v(" Warning ")],-1)),i("div",S,[i("p",null,[v(d(he.value),1),a[8]||(a[8]=i("br",null,null,-1)),a[9]||(a[9]=i("br",null,null,-1)),v(d("Are you sure you want to erase all?")),a[10]||(a[10]=i("br",null,null,-1))])]),i("div",{class:"dialog-buttons"},[i("button",{class:"yes",onClick:me},"Yes"),i("button",{class:"no",onClick:ye},"No")])])])):c("",!0),ve.value?(t(),l("div",T,[i("div",A,[a[12]||(a[12]=i("div",{class:"dialog-title-success"},[i("i",{class:"fas fa-check-circle",style:{color:"green","margin-right":"8px"}}),v(" Success ")],-1)),i("div",q,[i("p",null,d(ue.value),1)]),i("div",M,[i("button",{class:"no",onClick:a[2]||(a[2]=e=>{ve.value=!1})},"Close")])])])):c("",!0),de.value?(t(),l("div",O,[i("div",B,[a[13]||(a[13]=i("div",{class:"dialog-title"},[i("i",{class:"fa-solid fa-triangle-exclamation",style:{color:"#f5c542","margin-right":"8px"}}),v(" Failed ")],-1)),i("div",I,[i("p",null,d(oe.value),1)]),i("div",j,[i("button",{class:"no",onClick:a[3]||(a[3]=e=>{de.value=!1})},"Close")])])])):c("",!0),fe.value?(t(),l("div",N,[i("div",W,[a[17]||(a[17]=i("div",{class:"dialog-title-success"},[i("i",{class:"fas fa-question-circle",style:{color:"white","margin-right":"8px"}}),v(" Success ")],-1)),i("div",P,[i("p",null,[v(" Firmware "+d(Ae.value?.name)+" updated. ",1),a[14]||(a[14]=i("br",null,null,-1)),a[15]||(a[15]=i("br",null,null,-1)),a[16]||(a[16]=v("Do you want to load driver? ",-1))])]),i("div",Y,[i("button",{class:"yes",onClick:_e},"Yes"),i("button",{class:"no",onClick:a[4]||(a[4]=e=>fe.value=!1)},"No")])])])):c("",!0),we.value?(t(),l("div",V,[i("div",$,[a[24]||(a[24]=i("div",{class:"dialog-title"},[i("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),v(" Warning ")],-1)),i("div",H,[i("p",null,d(xe.value),1),i("p",{style:f({color:qe.value?"#000000":"#d9534f"})},d(Le.value),5),!1===qe.value?(t(),l("p",R,[a[18]||(a[18]=v(" (Recommend: ",-1)),i("button",{class:"link-button underline",onClick:a[5]||(a[5]=e=>{we.value=!1})}," Update "),a[19]||(a[19]=v(" to the latest firmware.) ",-1))])):c("",!0),a[23]||(a[23]=i("br",null,null,-1)),i("p",null,[a[20]||(a[20]=v("Do you want to load ",-1)),i("a",{target:"_blank",href:p(y).update_driver_path.value},"this driver",8,z),a[21]||(a[21]=v("?",-1)),a[22]||(a[22]=i("br",null,null,-1))])]),i("div",{class:"dialog-buttons"},[i("button",{class:"yes",onClick:be},"Yes"),i("button",{class:"no",onClick:ke},"No")])])])):c("",!0),pe.value?(t(),l("div",G,[i("div",J,[i("div",{class:w(["dialog-title",{"dialog-title-success":100===ge.value}])},[ge.value<100?(t(),l("i",K)):c("",!0),v(" "+d((ge.value,ne.value)),1)],2),i("div",Q,[i("div",X,d(ie.value),1),a[25]||(a[25]=i("br",null,null,-1)),i("div",Z,[i("div",{class:"update-driver-progress-bar",style:f({width:ge.value+"%"})},null,4)]),i("div",ee,d(ge.value)+"% ",1)])])])):c("",!0)]))}},[["__scopeId","data-v-3fa7e6e2"]])).mount("#app");
