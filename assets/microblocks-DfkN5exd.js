import{_ as a,e,o as t,c as l,a as i,f as s,w as n,v as o,g as r,r as c,t as u,h as d,i as v,j as f,n as w,b as g,F as p,k as m,l as h,m as y,d as b}from"./Footer-CGfy84Zi.js";import{_ as k,a as _}from"./console-connect-dfu-CrgV8XxQ.js";import{u as U}from"./useWebSerial-DIcZrkWu.js";const C=""+new URL("../img/cincobit-daisylinked.webp",import.meta.url).href,E=""+new URL("../img/cincobit-usb-connect.webp",import.meta.url).href,M={class:"page"},B={key:0,class:"version-select"},F=["value"],D={key:1,class:"overlay"},L={class:"dialog"},T={class:"dialog-body"},x={key:2,class:"overlay"},S={class:"dialog"},A={class:"dialog-body"},I={class:"dialog-buttons"},j={key:3,class:"overlay"},q={class:"dialog"},O={class:"dialog-body"},P={class:"dialog-buttons"},W={key:4,class:"overlay"},V={class:"dialog",style:{width:"25vw"}},N={key:0,class:"fas fa-exclamation-triangle",style:{"margin-right":"8px"}},R={class:"dialog-body"},Y={class:"update-driver-progress-container"},z={class:"progress-text"},G="Firmware detected.",H=2048,$=134217728;b(a({__name:"microblocks",setup(a){const b=U();e(async()=>{await async function(){try{const a=await fetch("https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/duelink-fw.json"),e=await a.json();Object.keys(e).forEach(a=>{ua[a]=e[a],ua[a].isGlb=!1,ua[a].image=null})}catch(a){}}()});const J=y(""),K=y(""),Q=y(""),X=y("");function Z(a){return new Promise(e=>setTimeout(e,a))}const aa=y(!1),ea=y(!1),ta=y(!1),la=y(!1),ia=y(0),sa=y(G);async function na(){for(aa.value=!1,ia.value=0,K.value="Please wait...",la.value=!0,await b.eraseall_dms_execute();b.eraseall_status_dms.value<2;)await Z(250),ia.value=50;ia.value=100,K.value="Done",await Z(250),la.value=!1,Q.value="Erase all completed.",ea.value=!0}async function oa(){aa.value=!1,b.isConnected&&(await b.disconnect(),await Z(250))}let ra;const ca=y(!1),ua=m({}),da=h(()=>ua.MicroBlock),va=y(0),fa=h(()=>da.value?.versions?[...da.value.versions].sort((a,e)=>e.id-a.id):[]);async function wa(){const a=da;await async function(a){try{0!==(await ha()).status&&(await ra.controlTransferOut({requestType:"class",recipient:"interface",request:4,value:0,index:0}),await Z(100));const e=a.byteLength;await async function(a){J.value="Erasing...",K.value=J.value;const e=Math.ceil(a/H);for(let t=0;t<e;t++){const a=$+t*H,l=new Uint8Array(5);l[0]=65,l[1]=255&a,l[2]=a>>8&255,l[3]=a>>16&255,l[4]=a>>24&255,await ma(0,l),await ya(),pa(t,e)}J.value="Erased.",K.value=J.value,pa(0,100)}(e),ia.value=0,la.value=!1,await Z(250),la.value=!0,J.value="Writing...",K.value=J.value;let t=new Uint8Array(5);t[0]=33,t[1]=0,t[2]=0,t[3]=0,t[4]=8,await ma(0,t),await ya();let l=0,i=2;for(;l<e;){const t=a.slice(l,l+1024);await ma(i,t),await ya(),l+=t.byteLength,i++,pa(l,e)}await async function(){let a=new Uint8Array(5);try{return a[0]=33,a[1]=0,a[2]=0,a[3]=0,a[4]=8,await ma(0,a),await ya(),await ma(0,new ArrayBuffer(0)),await ya(),1}catch(e){}return 0}(),J.value="Completed"}catch(e){J.value="Failed"}K.value=J.value}(a.image)}async function ga(){if(await async function(){try{ca.value=!1,ra=await navigator.usb.requestDevice({filters:[{vendorId:1155,productId:57105}]}),await ra.open(),ra.configuration||await ra.selectConfiguration(1),await ra.claimInterface(0),ca.value=!0}catch(a){a.value="Connection error: "+a,ca.value=!1}}(),ca.value)if(ia.value=0,K.value="Please wait...",la.value=!0,await async function(){const a=fa?.value[va.value],e=a?.url;try{const a=await fetch(e);if(!a.ok)throw new Error(`HTTP ${a.status}`);const t=await a.blob(),l=await t.arrayBuffer();da.image=l}catch(t){da.image=null}}(),await wa(),la.value=!1,"Completed"==J.value){const a=fa?.value[va.value].name;Q.value="MicroBlocks Version "+a+" update completed.",ea.value=!0}else ta.value="MicroBlocks update failed.",ta.value=!0}function pa(a,e){ia.value=Math.round(a/e*100),ia.value}async function ma(a,e){const t=await ra.controlTransferOut({requestType:"class",recipient:"interface",request:1,value:a,index:0},e);if("ok"!==t.status)throw new Error("DNLOAD transfer failed at block "+a);return t}async function ha(){const a=await ra.controlTransferIn({requestType:"class",recipient:"interface",request:3,value:0,index:0},6);if("ok"===a.status&&a.data&&6===a.data.byteLength){const e=new DataView(a.data.buffer);return{status:e.getUint8(0),pollTimeout:e.getUint8(1)|e.getUint8(2)<<8|e.getUint8(3)<<16,state:e.getUint8(4),iString:e.getUint8(5)}}throw new Error("Failed to read DFU status.")}async function ya(){for(;;){const a=await ha();if(5===a.state||2===a.state)break;await Z(a.pollTimeout)}}return(a,e)=>(t(),l("div",M,[e[12]||(e[12]=i('<h1 data-v-fe677354>MicroBlocks Firmware Loader</h1><p data-v-fe677354> This page will load MicroBlocks firmware on a single device, or on the first device in a chain. </p><img src="'+C+'" alt="cincobit daisylinked" data-v-fe677354><p data-v-fe677354> If you need to update the DUELink firmware on chained modules, do that first on the <a href="/update" data-v-fe677354>DUELink update page</a>. </p><hr data-v-fe677354><h2 data-v-fe677354>Step 1: Erase All</h2><p data-v-fe677354> Connect your module using a USB cable. </p><img src="'+E+'" alt="Module with USB" data-v-fe677354><p data-v-fe677354> Click the <strong data-v-fe677354>Erase All</strong> button below. The pop-up window should have a device named <em data-v-fe677354>DUELink Official</em> or <em data-v-fe677354>DUELink MicroBlocks</em>.<br data-v-fe677354><br data-v-fe677354> Select the device then click <strong data-v-fe677354>Connect</strong>. </p><img src="'+k+'" alt="Select COM device" data-v-fe677354>',10)),s("div",null,[s("button",{class:"outline-button",onClick:e[0]||(e[0]=a=>async function(){if(b.eraseall_status_dms.value=0,0==b.isConnected.value){for(b.eraseall_vid_dms.value=0,b.connection_mode.value=2,await b.eraseall_dms_connect();0==b.eraseall_status_dms.value;)await Z(100);await Z(100)}if(0!=b.eraseall_vid_dms.value){let a=65535&b.eraseall_vid_dms.value;sa.value=62208==a?"DUELink "+G:"MicroBlocks "+G,aa.value=!0}}())}," Erase All ")]),e[13]||(e[13]=i('<p data-v-fe677354> If the pop-up window didn&#39;t show the needed device or if <strong data-v-fe677354>Erase All</strong> failed, your device might already be erased. Try Step 2 or visit the <a href="https://www.duelink.com/docs/loader" target="_blank" data-v-fe677354>loader documentation page</a>. </p><hr data-v-fe677354><h2 data-v-fe677354>Step 2: Load MicroBlocks Firmware</h2><p data-v-fe677354> Click the button below then select the <em data-v-fe677354>DFU in FS Mode</em> device and click <strong data-v-fe677354>Connect</strong>. </p><p data-v-fe677354> If using Windows, <a href="https://www.duelink.com/bin/usb-drivers/win-usb-dfu.zip" target="_blank" data-v-fe677354>download</a> and install the DFU driver first. </p><img src="'+_+'" alt="DFU selection" data-v-fe677354>',6)),da.value?(t(),l("div",B,[e[4]||(e[4]=s("label",{for:"version-select"}," Select MicroBlocks firmware version: ",-1)),n(s("select",{id:"version-select","onUpdate:modelValue":e[1]||(e[1]=a=>va.value=a)},[(t(!0),l(r,null,c(fa.value,(a,e)=>(t(),l("option",{key:a.id,value:e},u(a.name),9,F))),128))],512),[[o,va.value]])])):d("",!0),s("div",null,[s("button",{class:"outline-button",onClick:ga}," Load MicroBlocks Firmware ")]),e[14]||(e[14]=s("p",null,[v(" You are now ready to start block-code using "),s("a",{href:"https://www.duelink.com/docs/language/microblocks",target:"_blank"},"MicroBlocks"),v(". ")],-1)),e[15]||(e[15]=s("p",null,[v(" For any issues, consult the "),s("a",{href:"https://www.duelink.com/docs/loader",target:"_blank"}," loader documentation"),v(" page. ")],-1)),aa.value?(t(),l("div",D,[s("div",L,[e[8]||(e[8]=s("div",{class:"dialog-title"},[s("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),v(" Warning ")],-1)),s("div",T,[s("p",null,[v(u(sa.value),1),e[5]||(e[5]=s("br",null,null,-1)),e[6]||(e[6]=s("br",null,null,-1)),v(u("Are you sure you want to erase all?")),e[7]||(e[7]=s("br",null,null,-1))])]),s("div",{class:"dialog-buttons"},[s("button",{class:"yes",onClick:na},"Yes"),s("button",{class:"no",onClick:oa},"No")])])])):d("",!0),ea.value?(t(),l("div",x,[s("div",S,[e[9]||(e[9]=s("div",{class:"dialog-title-success"},[s("i",{class:"fas fa-check-circle",style:{color:"green","margin-right":"8px"}}),v(" Success ")],-1)),s("div",A,[s("p",null,u(Q.value),1)]),s("div",I,[s("button",{class:"no",onClick:e[2]||(e[2]=a=>{ea.value=!1})},"Close")])])])):d("",!0),ta.value?(t(),l("div",j,[s("div",q,[e[10]||(e[10]=s("div",{class:"dialog-title"},[s("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),v(" Failed ")],-1)),s("div",O,[s("p",null,u(X.value),1)]),s("div",P,[s("button",{class:"no",onClick:e[3]||(e[3]=a=>{ta.value=!1})},"Close")])])])):d("",!0),la.value?(t(),l("div",W,[s("div",V,[s("div",{class:f(["dialog-title",{"dialog-title-success":100===ia.value}])},[ia.value<100?(t(),l("i",N)):d("",!0),v(" "+u((ia.value,K.value)),1)],2),s("div",R,[e[11]||(e[11]=s("br",null,null,-1)),s("div",Y,[s("div",{class:"update-driver-progress-bar",style:w({width:ia.value+"%"})},null,4)]),s("div",z,u(ia.value)+"% ",1)])])])):d("",!0),g(p)]))}},[["__scopeId","data-v-fe677354"]])).mount("#app");
