import{m as a,u as e,d as t,r as l,e as s,f as i,c as n,o,a as c,g as r,h as u,i as d,v,F as f,j as b,t as w,k as g,p as m,n as p,b as h}from"./mitt-DApd8ShI.js";import{_ as y,a as k,b as _}from"./_plugin-vue_export-helper-Dl_H5AQ6.js";const U=""+new URL("../img/arduino-uno-r4-daisylinked.webp",import.meta.url).href,C={class:"page"},E={class:"button-row"},D={key:0,class:"version-select"},F=["value"],x={key:1,class:"overlay"},B={class:"dialog"},L={class:"dialog-body"},M={key:2,class:"overlay"},T={class:"dialog"},A={class:"dialog-body"},S={class:"dialog-buttons"},I={key:3,class:"overlay"},q={class:"dialog"},j={class:"dialog-body"},O={class:"dialog-buttons"},P={key:4,class:"overlay"},V={class:"dialog",style:{width:"25vw"}},W={key:0,class:"fas fa-exclamation-triangle",style:{"margin-right":"8px"}},Y={class:"dialog-body"},N={class:"update-driver-progress-container"},G={class:"progress-text"},H="Firmware detected.\nAre you sure you want to erase all?",R=2048,$=134217728;h(y({__name:"microblocks",setup(h){const y=a(),z=e({progress:null},y);t(async()=>{await async function(){try{const a=await fetch("https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/duelink-fw.json"),e=await a.json();Object.keys(e).forEach(a=>{ua[a]=e[a],ua[a].isGlb=!1,ua[a].image=null})}catch(a){}}()}),l("");const J=l(""),K=l(""),Q=l(""),X=l("");function Z(a){return new Promise(e=>setTimeout(e,a))}const aa=l(!1),ea=l(!1),ta=l(!1),la=l(!1),sa=l(0),ia=l(H);async function na(){for(aa.value=!1,sa.value=0,K.value="Please wait...",la.value=!0,await z.eraseall_dms_execute();z.eraseall_status_dms.value<2;)await Z(250),sa.value=50;sa.value=100,K.value="Done",await Z(250),la.value=!1,Q.value="Erase all completed.",ea.value=!0}async function oa(){aa.value=!1,z.isConnected&&(await z.disconnect(),await Z(250))}let ca;const ra=l(!1),ua=s({});l(""),l("");const da=i(()=>ua.MicroBlock),va=l(0),fa=i(()=>da.value?.versions?[...da.value.versions].sort((a,e)=>e.id-a.id):[]);async function ba(){const a=da;await async function(a){try{0!==(await pa()).status&&(await ca.controlTransferOut({requestType:"class",recipient:"interface",request:4,value:0,index:0}),await Z(100));const e=a.byteLength;await async function(a){J.value="Erasing...",K.value=J.value;const e=Math.ceil(a/R);for(let t=0;t<e;t++){const a=$+t*R,l=new Uint8Array(5);l[0]=65,l[1]=255&a,l[2]=a>>8&255,l[3]=a>>16&255,l[4]=a>>24&255,await ma(0,l),await ha(),ga(t,e)}J.value="Erased.",K.value=J.value,ga(0,100)}(e),sa.value=0,la.value=!1,await Z(250),la.value=!0,J.value="Writing...",K.value=J.value;let t=new Uint8Array(5);t[0]=33,t[1]=0,t[2]=0,t[3]=0,t[4]=8,await ma(0,t),await ha();let l=0,s=2;for(;l<e;){const t=a.slice(l,l+1024);await ma(s,t),await ha(),l+=t.byteLength,s++,ga(l,e)}await async function(){let a=new Uint8Array(5);try{return a[0]=33,a[1]=0,a[2]=0,a[3]=0,a[4]=8,await ma(0,a),await ha(),await ma(0,new ArrayBuffer(0)),await ha(),1}catch(e){}return 0}(),J.value="Completed"}catch(e){J.value="Failed"}K.value=J.value}(a.image)}async function wa(){if(await async function(){try{ra.value=!1,ca=await navigator.usb.requestDevice({filters:[{vendorId:1155,productId:57105}]}),await ca.open(),ca.configuration||await ca.selectConfiguration(1),await ca.claimInterface(0),ra.value=!0}catch(a){a.value="Connection error: "+a,ra.value=!1}}(),ra.value)if(sa.value=0,K.value="Please wait...",la.value=!0,await async function(){const a=fa?.value[va.value],e=a?.url;try{const a=await fetch(e);if(!a.ok)throw new Error(`HTTP ${a.status}`);const t=await a.blob(),l=await t.arrayBuffer();da.image=l}catch(t){da.image=null}}(),await ba(),la.value=!1,"Completed"==J.value){const a=fa?.value[va.value].name;Q.value="MicroBlocks Version "+a+" update completed.",ea.value=!0}else ta.value="MicroBlocks update failed.",ta.value=!0}function ga(a,e){sa.value=Math.round(a/e*100),sa.value}async function ma(a,e){const t=await ca.controlTransferOut({requestType:"class",recipient:"interface",request:1,value:a,index:0},e);if("ok"!==t.status)throw new Error("DNLOAD transfer failed at block "+a);return t}async function pa(){const a=await ca.controlTransferIn({requestType:"class",recipient:"interface",request:3,value:0,index:0},6);if("ok"===a.status&&a.data&&6===a.data.byteLength){const e=new DataView(a.data.buffer);return{status:e.getUint8(0),pollTimeout:e.getUint8(1)|e.getUint8(2)<<8|e.getUint8(3)<<16,state:e.getUint8(4),iString:e.getUint8(5)}}throw new Error("Failed to read DFU status.")}async function ha(){for(;;){const a=await pa();if(5===a.state||2===a.state)break;await Z(a.pollTimeout)}}return i(()=>fa.value[va.value]||null),l(!0),(a,e)=>(o(),n("div",C,[e[11]||(e[11]=c('<h1 class="title" data-v-b222dbf8>MicroBlocks Firmware Loader</h1><hr class="divider" data-v-b222dbf8><h2 class="section-title" data-v-b222dbf8>Step 1 (Erase All)</h2><p class="subtitle" data-v-b222dbf8> Connect your module using a USB cable. </p><img src="'+k+'" alt="Module with USB" class="card-image" data-v-b222dbf8><p class="subtitle" data-v-b222dbf8> Click the <strong data-v-b222dbf8>Erase All</strong> button, then select the device. You should only see one named <em data-v-b222dbf8>DUELink Official</em> or <em data-v-b222dbf8>DUELink MicroBlocks</em>. </p><img src="'+_+'" alt="Select DFU device" class="screenshot" data-v-b222dbf8>',7)),r("div",E,[r("button",{class:"outline-button",onClick:e[0]||(e[0]=a=>async function(){if(z.eraseall_status_dms.value=0,0==z.isConnected.value){for(z.eraseall_vid_dms.value=0,z.connection_mode.value=2,await z.eraseall_dms_connect();0==z.eraseall_status_dms.value;)await Z(100);await Z(100)}if(0!=z.eraseall_vid_dms.value){let a=65535&z.eraseall_vid_dms.value;ia.value=62208==a?"DUELink "+H:"MicroBlocks "+H,aa.value=!0}}())}," Erase All ")]),e[12]||(e[12]=c('<p class="subtitle" data-v-b222dbf8> If <strong data-v-b222dbf8>Erase All</strong> failed, visit the <a href="https://www.duelink.com/docs/loader" target="_blank" data-v-b222dbf8> loader documentation page </a>. </p><hr class="divider" data-v-b222dbf8><h2 class="section-title" data-v-b222dbf8>Step 2 (Load Firmware)</h2><p class="subtitle" data-v-b222dbf8> This step will load MicroBlocks firmware on a single device or the first device in a chain. </p><p class="subtitle" data-v-b222dbf8> If you need to update the DUELink firmware on chained modules, do that first on the DUELink update page. </p><img src="'+U+'" alt="Chained modules" class="screenshot" data-v-b222dbf8><p class="subtitle" data-v-b222dbf8> Click the button, then <strong data-v-b222dbf8>Connect</strong>. Select the <em data-v-b222dbf8>DFU in FS Mode</em> device. If using Windows, install the DFU driver first. </p><img src="'+_+'" alt="DFU selection" class="screenshot" data-v-b222dbf8>',8)),da.value?(o(),n("div",D,[e[4]||(e[4]=r("label",{for:"version-select"}," Select firmware version: ",-1)),d(r("select",{id:"version-select","onUpdate:modelValue":e[1]||(e[1]=a=>va.value=a)},[(o(!0),n(f,null,b(fa.value,(a,e)=>(o(),n("option",{key:a.id,value:e},w(a.name),9,F))),128))],512),[[v,va.value]])])):u("",!0),r("div",{class:"button-row"},[r("button",{class:"outline-button",onClick:wa}," Load MicroBlocks Firmware ")]),e[13]||(e[13]=r("p",{class:"subtitle"},[g(" Congratulations! You can now block-code using "),r("a",{href:"https://www.duelink.com/docs/language/microblocks",target:"_blank"}," MicroBlocks "),g(". ")],-1)),aa.value?(o(),n("div",x,[r("div",B,[e[7]||(e[7]=r("div",{class:"dialog-title"},[r("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),g(" Warning ")],-1)),r("div",L,[r("p",null,[g(w(ia.value),1),e[5]||(e[5]=r("br",null,null,-1)),e[6]||(e[6]=r("br",null,null,-1))])]),r("div",{class:"dialog-buttons"},[r("button",{class:"yes",onClick:na},"Yes"),r("button",{class:"no",onClick:oa},"No")])])])):u("",!0),ea.value?(o(),n("div",M,[r("div",T,[e[8]||(e[8]=r("div",{class:"dialog-title-success"},[r("i",{class:"fas fa-check-circle",style:{color:"green","margin-right":"8px"}}),g(" Success ")],-1)),r("div",A,[r("p",null,w(Q.value),1)]),r("div",S,[r("button",{class:"no",onClick:e[2]||(e[2]=a=>{ea.value=!1})},"Close")])])])):u("",!0),ta.value?(o(),n("div",I,[r("div",q,[e[9]||(e[9]=r("div",{class:"dialog-title"},[r("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),g(" Failed ")],-1)),r("div",j,[r("p",null,w(X.value),1)]),r("div",O,[r("button",{class:"no",onClick:e[3]||(e[3]=a=>{ta.value=!1})},"Close")])])])):u("",!0),la.value?(o(),n("div",P,[r("div",V,[r("div",{class:m(["dialog-title",{"dialog-title-success":100===sa.value}])},[sa.value<100?(o(),n("i",W)):u("",!0),g(" "+w((sa.value,K.value)),1)],2),r("div",Y,[e[10]||(e[10]=r("br",null,null,-1)),r("div",N,[r("div",{class:"update-driver-progress-bar",style:p({width:sa.value+"%"})},null,4)]),r("div",G,w(sa.value)+"% ",1)])])])):u("",!0)]))}},[["__scopeId","data-v-b222dbf8"]])).mount("#app");
