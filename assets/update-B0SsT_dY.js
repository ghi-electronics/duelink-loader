import{r as e,d as a,c as t,o as l,a as s,e as i,f as n,g as o,t as r,n as c,u,h as d,b as v}from"./runtime-dom.esm-bundler-DNOERz_1.js";import{m as w,u as p}from"./mitt-BVbp22iZ.js";const g={class:"page"},f={class:"button-row"},m={key:0,class:"overlay"},h={class:"dialog"},b={class:"dialog-body"},y={key:1,class:"overlay"},k={class:"dialog"},_={class:"dialog-body"},U={class:"dialog-buttons"},C={key:2,class:"overlay"},D={class:"dialog"},E={class:"dialog-body"},L={class:"dialog-buttons"},x={key:3,class:"overlay"},T={class:"dialog"},F={class:"dialog-buttons"},S={key:4,class:"overlay"},A={class:"dialog"},B={class:"dialog-body"},q={key:0,class:"firmware-warning"},I=["href"],M={key:5,class:"overlay"},j={class:"dialog",style:{width:"25vw"}},O={key:0,class:"fas fa-exclamation-triangle",style:{"margin-right":"8px"}},P={class:"dialog-body"},N={class:"update-driver-progress-container"},W={class:"progress-text"},Y="Firmware detected.\nAre you sure you want to erase all?",H=2048,V=134217728;v({__name:"update",setup(v){const z=w(),G=p({progress:null},z);e("");const R=e(""),$=e(""),J=e(""),K=e("");function Q(e){return new Promise(a=>setTimeout(a,e))}const X=e(!1),Z=e(!1),ee=e(!1),ae=e(!1),te=e(!1),le=e(!1),se=e(0),ie=e(1),ne=e(Y);async function oe(){for(X.value=!1,se.value=0,$.value="Please wait...",te.value=!0,await G.eraseall_dms_execute();G.eraseall_status_dms.value<2;)await Q(250),se.value=50;se.value=100,$.value="Done",await Q(250),te.value=!1,J.value="Erase all completed.",Z.value=!0}async function re(){X.value=!1,G.isConnected&&(await G.disconnect(),await Q(250))}async function ce(){if(ae.value=!1,!G.isConnected.value){G.device_name.value="",G.driver_ver.value="",G.progress_percent.value=0,se.value=0,G.update_driver_status.value=0,G.connection_mode.value=1,ie.value=G.update_devaddr.value;if(await G.driver_connect()){for($.value="Please wait...",te.value=!0,se.value=0;0==G.update_driver_status.value;)await Q(100),se.value=G.progress_percent.value;if(await Q(100),1==G.update_driver_status.value){let e=!1;const a=Date.now()+4e3;for(;!(G.isConnected.value&&""!=G.device_name.value&&""!=G.driver_ver.value||(await Q(100),Date.now()>a));)se.value=G.progress_percent.value;G.isConnected.value&&Date.now()<a&&(e=!0),e&&($.value="Connected",ge.value="Device Name: "+G.device_name.value,fe.value="Firmware Version: "+G.version.value,le.value=!0,se.value=100,te.value=!1)}te.value=!1,se.value=0}}}async function ue(){for(le.value=!1,$.value="Please wait...",te.value=!0,G.progress_percent.value=0,se.value=0,G.driver_update();100!=G.progress_percent.value;)await Q(1),se.value=G.progress_percent.value;G.update_driver_status.value=0,await G.disconnect(),await Q(10),te.value=!1,J.value="Load driver completed.",Z.value=!0}async function de(){G.isConnected.value&&(G.disconnect(),await Q(100)),le.value=!1}let ve;const we=e(!1),pe=a({}),ge=e("");e("");const fe=e("");!async function(){try{const e=await fetch("https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/duelink-fw.json"),a=await e.json();Object.keys(a).forEach(e=>{pe[e]=a[e],pe[e].isGlb=!1,pe[e].image=null})}catch(e){}}();const me=e(!0);async function he(e){const a=pe[e];await async function(e){try{0!==(await _e()).status&&(await ve.controlTransferOut({requestType:"class",recipient:"interface",request:4,value:0,index:0}),await Q(100));const a=e.byteLength;await async function(e){R.value="Erasing...",$.value=R.value;const a=Math.ceil(e/H);for(let t=0;t<a;t++){const e=V+t*H,l=new Uint8Array(5);l[0]=65,l[1]=255&e,l[2]=e>>8&255,l[3]=e>>16&255,l[4]=e>>24&255,await ke(0,l),await Ue(),ye(t,a)}R.value="Erased.",$.value=R.value,ye(0,100)}(a),se.value=0,te.value=!1,await Q(250),te.value=!0,R.value="Writing...",$.value=R.value;let t=new Uint8Array(5);t[0]=33,t[1]=0,t[2]=0,t[3]=0,t[4]=8,await ke(0,t),await Ue();let l=0,s=2;for(;l<a;){const t=e.slice(l,l+1024);await ke(s,t),await Ue(),l+=t.byteLength,s++,ye(l,a)}await async function(){let e=new Uint8Array(5);try{return e[0]=33,e[1]=0,e[2]=0,e[3]=0,e[4]=8,await ke(0,e),await Ue(),await ke(0,new ArrayBuffer(0)),await Ue(),1}catch(a){}return 0}(),R.value="Completed"}catch(a){R.value="Failed"}$.value=R.value}(a.image)}async function be(){await async function(){try{we.value=!1,ve=await navigator.usb.requestDevice({filters:[{vendorId:1155,productId:57105}]}),await ve.open(),ve.configuration||await ve.selectConfiguration(1),await ve.claimInterface(0),we.value=!0}catch(e){e.value="Connection error: "+e,we.value=!1}}(),we.value&&(se.value=0,$.value="Please wait...",te.value=!0,await async function(e){const a=pe[e];if(!a||!Array.isArray(a.versions)||0===a.versions.length)return;const t=a.versions.reduce((e,a)=>a.id>e.id?a:e).url;try{const e=await fetch(t);if(!e.ok)throw new Error(`HTTP ${e.status}`);const l=await e.blob(),s=await l.arrayBuffer();a.image=s}catch(l){a.image=null}}("DUELink"),await he("DUELink"),te.value=!1,"Completed"==R.value&&(ae.value=!0))}function ye(e,a){se.value=Math.round(e/a*100),se.value}async function ke(e,a){const t=await ve.controlTransferOut({requestType:"class",recipient:"interface",request:1,value:e,index:0},a);if("ok"!==t.status)throw new Error("DNLOAD transfer failed at block "+e);return t}async function _e(){const e=await ve.controlTransferIn({requestType:"class",recipient:"interface",request:3,value:0,index:0},6);if("ok"===e.status&&e.data&&6===e.data.byteLength){const a=new DataView(e.data.buffer);return{status:a.getUint8(0),pollTimeout:a.getUint8(1)|a.getUint8(2)<<8|a.getUint8(3)<<16,state:a.getUint8(4),iString:a.getUint8(5)}}throw new Error("Failed to read DFU status.")}async function Ue(){for(;;){const e=await _e();if(5===e.state||2===e.state)break;await Q(e.pollTimeout)}}return(e,a)=>(l(),t("div",g,[a[25]||(a[25]=s('<h1 class="title">DUELink Loader</h1><p class="subtitle"> This page will help in updating DUELink firmware and its related Driver. </p><hr class="divider"><h2 class="section-title">Step 1 (Erase All)</h2><div class="card-container"><div class="card"><img src="https://www.duelink.com/img/catalog/mcduestem-b-1.webp" alt="Module with USB" class="card-image"><p class="card-text"> If your module has a USB connector, just plug it in! </p></div><div class="card"><img src="https://www.duelink.com/img/usbhook-rgb3.webp" alt="USB Hook" class="card-image"><p class="card-text"> If your module has a <code>U</code> Uplink connector, you need a USB adaptor, like USB Hook. </p></div></div><p class="subtitle"> Click the <strong>Erase All</strong> button, then select the device. You should only see one named <em>DUELink Official</em> or <em>DUELink MicroBlocks</em>. </p><img src="https://www.duelink.com/img/console-connect-dfu.webp" alt="Select DFU device" class="screenshot">',7)),i("div",f,[i("button",{class:"outline-button",onClick:a[0]||(a[0]=e=>async function(){if(G.eraseall_status_dms.value=0,0==G.isConnected.value){for(G.eraseall_vid_dms.value=0,G.connection_mode.value=2,await G.eraseall_dms_connect();0==G.eraseall_status_dms.value;)await Q(100);await Q(100)}if(0!=G.eraseall_vid_dms.value){let e=65535&G.eraseall_vid_dms.value;ne.value=62208==e?"DUELink "+Y:"MicroBlocks "+Y,X.value=!0}}())}," Erase All ")]),a[26]||(a[26]=s('<p class="subtitle"> If <strong>Erase All</strong> failed, visit the <a href="https://www.duelink.com/docs/loader" target="_blank"> loader documentation page </a>. </p><hr class="divider"><h2 class="section-title">Step 2 (Load Firmware/Driver)</h2><p class="subtitle"> This step will update the firmware on a single device, or on the first device in a chain. </p><p class="subtitle"> Click the button below then select the <em>DFU in FS Mode</em> device and click <strong>Connect</strong>. </p><p class="subtitle"> If using Windows, <a href="https://www.duelink.com/bin/usb-drivers/win-usb-dfu.zip" target="_blank">download</a> and install the DFU driver first. </p><img src="https://www.duelink.com/img/console-connect-dfu.webp" alt="DFU selection" class="screenshot">',7)),i("div",{class:"button-row"},[i("button",{class:"outline-button",onClick:be}," Load DUELink Firmware/Driver "),a[5]||(a[5]=i("hr",{class:"divider"},null,-1)),a[6]||(a[6]=i("p",{class:"subtitle"},[o(" The update steps are now complete on a single device."),i("br"),i("br"),o(" Continue to step 3 if you have multiple devices in a chain that you want to update. ")],-1))]),a[27]||(a[27]=s('<hr class="divider"><h2 class="section-title">Step 3 (Update Chain)</h2><p class="subtitle"> This optional step is for updating all modules in a chain (Daisylink). </p><p class="subtitle"> Click the <strong>Load Driver Script</strong> button, then select the device. You should only see one named <em>DUELink Official</em>. </p><img src="https://www.duelink.com/img/console-connect-dfu.webp" alt="Driver selection" class="screenshot"><div class="button-row"><button class="outline-button"> Update Chain </button></div>',6)),X.value?(l(),t("div",m,[i("div",h,[a[9]||(a[9]=i("div",{class:"dialog-title"},[i("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),o(" Warning ")],-1)),i("div",b,[i("p",null,[o(r(ne.value),1),a[7]||(a[7]=i("br",null,null,-1)),a[8]||(a[8]=i("br",null,null,-1))])]),i("div",{class:"dialog-buttons"},[i("button",{class:"yes",onClick:oe},"Yes"),i("button",{class:"no",onClick:re},"No")])])])):n("",!0),Z.value?(l(),t("div",y,[i("div",k,[a[10]||(a[10]=i("div",{class:"dialog-title-success"},[i("i",{class:"fas fa-check-circle",style:{color:"green","margin-right":"8px"}}),o(" Success ")],-1)),i("div",_,[i("p",null,r(J.value),1)]),i("div",U,[i("button",{class:"no",onClick:a[1]||(a[1]=e=>{Z.value=!1})},"Close")])])])):n("",!0),ee.value?(l(),t("div",C,[i("div",D,[a[11]||(a[11]=i("div",{class:"dialog-title"},[i("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),o(" Failed ")],-1)),i("div",E,[i("p",null,r(K.value),1)]),i("div",L,[i("button",{class:"no",onClick:a[2]||(a[2]=e=>{ee.value=!1})},"Close")])])])):n("",!0),ae.value?(l(),t("div",x,[i("div",T,[a[12]||(a[12]=i("div",{class:"dialog-title"},[i("i",{class:"fas fa-question-circle",style:{color:"white","margin-right":"8px"}}),o(" Warning ")],-1)),a[13]||(a[13]=i("div",{class:"dialog-body"},[i("p",null," Firmware updated. Do you want to load driver? ")],-1)),i("div",F,[i("button",{class:"yes",onClick:ce},"Yes"),i("button",{class:"no",onClick:a[3]||(a[3]=e=>ae.value=!1)},"No")])])])):n("",!0),le.value?(l(),t("div",S,[i("div",A,[a[23]||(a[23]=i("div",{class:"dialog-title"},[i("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),o(" Warning ")],-1)),i("div",B,[i("p",null,[o(r(ge.value),1),a[14]||(a[14]=i("br",null,null,-1))]),i("p",{style:c({color:me.value?"#000000":"#d9534f"})},[o(r(fe.value),1),a[15]||(a[15]=i("br",null,null,-1))],4),!1===me.value?(l(),t("p",q,[a[16]||(a[16]=o(" (Recommend: ",-1)),i("button",{class:"link-button underline",onClick:a[4]||(a[4]=a=>{le.value=!1,e.dfuModal.start()})}," Update "),a[17]||(a[17]=o(" to the latest firmware.) ",-1))])):n("",!0),a[22]||(a[22]=i("br",null,null,-1)),i("p",null,[a[18]||(a[18]=o("Do you want to load ",-1)),i("a",{target:"_blank",href:u(G).update_driver_path.value},"this driver",8,I),a[19]||(a[19]=o("?",-1)),a[20]||(a[20]=i("br",null,null,-1)),a[21]||(a[21]=i("br",null,null,-1))])]),i("div",{class:"dialog-buttons"},[i("button",{class:"yes",onClick:ue},"Yes"),i("button",{class:"no",onClick:de},"No")])])])):n("",!0),te.value?(l(),t("div",M,[i("div",j,[i("div",{class:d(["dialog-title",{"dialog-title-success":100===se.value}])},[se.value<100?(l(),t("i",O)):n("",!0),o(" "+r((se.value,$.value)),1)],2),i("div",P,[a[24]||(a[24]=i("br",null,null,-1)),i("div",N,[i("div",{class:"update-driver-progress-bar",style:c({width:se.value+"%"})},null,4)]),i("div",W,r(se.value)+"% ",1)])])])):n("",!0)]))}}).mount("#app");
