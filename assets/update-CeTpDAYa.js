import{d as a,r as e,e as t,f as l,c as s,o as i,a as n,g as o,h as r,i as u,v as c,F as d,j as v,k as f,t as b,n as p,u as w,l as g,b as m}from"./runtime-dom.esm-bundler-DS9m3pnD.js";import{_ as h,a as y}from"./console-connect-dfu-BOn47yBP.js";import{m as k,u as _}from"./mitt-gCFikzZV.js";const U=""+new URL("../img/usbhook-rgb3.webp",import.meta.url).href,C={class:"page"},D={class:"button-row"},E={key:0,class:"version-select"},L=["value"],x={key:1,class:"overlay"},F={class:"dialog"},T={class:"dialog-body"},S={key:2,class:"overlay"},A={class:"dialog"},B={class:"dialog-body"},I={class:"dialog-buttons"},j={key:3,class:"overlay"},q={class:"dialog"},M={class:"dialog-body"},O={class:"dialog-buttons"},P={key:4,class:"overlay"},N={class:"dialog"},W={class:"dialog-buttons"},Y={key:5,class:"overlay"},H={class:"dialog"},V={class:"dialog-body"},R={key:0,class:"firmware-warning"},z=["href"],G={key:6,class:"overlay"},$={class:"dialog",style:{width:"25vw"}},J={key:0,class:"fas fa-exclamation-triangle",style:{"margin-right":"8px"}},K={class:"dialog-body"},Q={class:"update-driver-progress-container"},X={class:"progress-text"},Z="Firmware detected.\nAre you sure you want to erase all?",aa=2048,ea=134217728;m(((a,e)=>{const t=a.__vccOpts||a;for(const[l,s]of e)t[l]=s;return t})({__name:"update",setup(m){const ta=k(),la=_({progress:null},ta);a(async()=>{await async function(){try{const a=await fetch("https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/duelink-fw.json"),e=await a.json();Object.keys(e).forEach(a=>{Ca[a]=e[a],Ca[a].isGlb=!1,Ca[a].image=null})}catch(a){}}()}),e("");const sa=e(""),ia=e(""),na=e(""),oa=e("");function ra(a){return new Promise(e=>setTimeout(e,a))}const ua=e(!1),ca=e(!1),da=e(!1),va=e(!1),fa=e(!1),ba=e(!1),pa=e(0),wa=e(Z);async function ga(){for(ua.value=!1,pa.value=0,ia.value="Please wait...",fa.value=!0,await la.eraseall_dms_execute();la.eraseall_status_dms.value<2;)await ra(250),pa.value=50;pa.value=100,ia.value="Done",await ra(250),fa.value=!1,na.value="Erase all completed.",ca.value=!0}async function ma(){ua.value=!1,la.isConnected&&(await la.disconnect(),await ra(250))}async function ha(){if(va.value=!1,!la.isConnected.value){la.device_name.value="",la.driver_ver.value="",la.progress_percent.value=0,pa.value=0,la.update_driver_status.value=0,la.update_devaddr.value=1,la.connection_mode.value=1;if(await la.driver_connect()){for(ia.value="Please wait...",fa.value=!0,pa.value=0;0==la.update_driver_status.value;)await ra(100),pa.value=la.progress_percent.value;if(await ra(100),1==la.update_driver_status.value){let a=!1;const e=Date.now()+4e3;for(;!(la.isConnected.value&&""!=la.device_name.value&&""!=la.driver_ver.value||(await ra(100),Date.now()>e));)pa.value=la.progress_percent.value;la.isConnected.value&&Date.now()<e&&(a=!0),a&&(ia.value="Connected",Da.value="Device Name: "+la.device_name.value,Ea.value="Firmware Version: "+la.version.value,ba.value=!0,pa.value=100,fa.value=!1)}fa.value=!1,pa.value=0}}}async function ya(){for(ba.value=!1,ia.value="Please wait...",fa.value=!0,la.progress_percent.value=0,pa.value=0,la.driver_update();100!=la.progress_percent.value;)await ra(1),pa.value=la.progress_percent.value;la.update_driver_status.value=0,await la.disconnect(),await ra(10),fa.value=!1,na.value="Load driver completed.",ca.value=!0}async function ka(){la.isConnected.value&&(la.disconnect(),await ra(100)),ba.value=!1}let _a;const Ua=e(!1),Ca=t({}),Da=e("");e("");const Ea=e(""),La=l(()=>Ca.DUELink),xa=e(0),Fa=l(()=>La.value?.versions?[...La.value.versions].sort((a,e)=>e.id-a.id):[]);l(()=>Fa.value[xa.value]||null);const Ta=e(!0);async function Sa(){const a=La;await async function(a){try{0!==(await ja()).status&&(await _a.controlTransferOut({requestType:"class",recipient:"interface",request:4,value:0,index:0}),await ra(100));const e=a.byteLength;await async function(a){sa.value="Erasing...",ia.value=sa.value;const e=Math.ceil(a/aa);for(let t=0;t<e;t++){const a=ea+t*aa,l=new Uint8Array(5);l[0]=65,l[1]=255&a,l[2]=a>>8&255,l[3]=a>>16&255,l[4]=a>>24&255,await Ia(0,l),await qa(),Ba(t,e)}sa.value="Erased.",ia.value=sa.value,Ba(0,100)}(e),pa.value=0,fa.value=!1,await ra(250),fa.value=!0,sa.value="Writing...",ia.value=sa.value;let t=new Uint8Array(5);t[0]=33,t[1]=0,t[2]=0,t[3]=0,t[4]=8,await Ia(0,t),await qa();let l=0,s=2;for(;l<e;){const t=a.slice(l,l+1024);await Ia(s,t),await qa(),l+=t.byteLength,s++,Ba(l,e)}await async function(){let a=new Uint8Array(5);try{return a[0]=33,a[1]=0,a[2]=0,a[3]=0,a[4]=8,await Ia(0,a),await qa(),await Ia(0,new ArrayBuffer(0)),await qa(),1}catch(e){}return 0}(),sa.value="Completed"}catch(e){sa.value="Failed"}ia.value=sa.value}(a.image)}async function Aa(){await async function(){try{Ua.value=!1,_a=await navigator.usb.requestDevice({filters:[{vendorId:1155,productId:57105}]}),await _a.open(),_a.configuration||await _a.selectConfiguration(1),await _a.claimInterface(0),Ua.value=!0}catch(a){a.value="Connection error: "+a,Ua.value=!1}}(),Ua.value&&(pa.value=0,ia.value="Please wait...",fa.value=!0,await async function(){const a=Fa?.value[xa.value],e=a?.url;try{const a=await fetch(e);if(!a.ok)throw new Error(`HTTP ${a.status}`);const t=await a.blob(),l=await t.arrayBuffer();La.image=l}catch(t){La.image=null}}(),await Sa(),fa.value=!1,"Completed"==sa.value&&(va.value=!0))}function Ba(a,e){pa.value=Math.round(a/e*100),pa.value}async function Ia(a,e){const t=await _a.controlTransferOut({requestType:"class",recipient:"interface",request:1,value:a,index:0},e);if("ok"!==t.status)throw new Error("DNLOAD transfer failed at block "+a);return t}async function ja(){const a=await _a.controlTransferIn({requestType:"class",recipient:"interface",request:3,value:0,index:0},6);if("ok"===a.status&&a.data&&6===a.data.byteLength){const e=new DataView(a.data.buffer);return{status:e.getUint8(0),pollTimeout:e.getUint8(1)|e.getUint8(2)<<8|e.getUint8(3)<<16,state:e.getUint8(4),iString:e.getUint8(5)}}throw new Error("Failed to read DFU status.")}async function qa(){for(;;){const a=await ja();if(5===a.state||2===a.state)break;await ra(a.pollTimeout)}}return(a,e)=>(i(),s("div",C,[e[27]||(e[27]=n('<h1 class="title" data-v-9a49df8b>DUELink Loader</h1><p class="subtitle" data-v-9a49df8b> This page will help in updating DUELink firmware and its related Driver. </p><hr class="divider" data-v-9a49df8b><h2 class="section-title" data-v-9a49df8b>Step 1 (Erase All)</h2><div class="card-container" data-v-9a49df8b><div class="card" data-v-9a49df8b><img src="'+h+'" alt="Module with USB" class="card-image" data-v-9a49df8b><p class="card-text" data-v-9a49df8b> If your module has a USB connector, just plug it in! </p></div><div class="card" data-v-9a49df8b><img src="'+U+'" alt="USB Hook" class="card-image" data-v-9a49df8b><p class="card-text" data-v-9a49df8b> If your module has a <code data-v-9a49df8b>U</code> Uplink connector, you need a USB adaptor, like USB Hook. </p></div></div><p class="subtitle" data-v-9a49df8b> Click the <strong data-v-9a49df8b>Erase All</strong> button, then select the device. You should only see one named <em data-v-9a49df8b>DUELink Official</em> or <em data-v-9a49df8b>DUELink MicroBlocks</em>. </p><img src="'+y+'" alt="Select DFU device" class="screenshot" data-v-9a49df8b>',7)),o("div",D,[o("button",{class:"outline-button",onClick:e[0]||(e[0]=a=>async function(){if(la.eraseall_status_dms.value=0,0==la.isConnected.value){for(la.eraseall_vid_dms.value=0,la.connection_mode.value=2,await la.eraseall_dms_connect();0==la.eraseall_status_dms.value;)await ra(100);await ra(100)}if(0!=la.eraseall_vid_dms.value){let a=65535&la.eraseall_vid_dms.value;wa.value=62208==a?"DUELink "+Z:"MicroBlocks "+Z,ua.value=!0}}())}," Erase All ")]),e[28]||(e[28]=n('<p class="subtitle" data-v-9a49df8b> If <strong data-v-9a49df8b>Erase All</strong> failed, visit the <a href="https://www.duelink.com/docs/loader" target="_blank" data-v-9a49df8b> loader documentation page </a>. </p><hr class="divider" data-v-9a49df8b><h2 class="section-title" data-v-9a49df8b>Step 2 (Load Firmware/Driver)</h2><p class="subtitle" data-v-9a49df8b> This step will update the firmware on a single device, or on the first device in a chain. </p><p class="subtitle" data-v-9a49df8b> Click the button below then select the <em data-v-9a49df8b>DFU in FS Mode</em> device and click <strong data-v-9a49df8b>Connect</strong>. </p><p class="subtitle" data-v-9a49df8b> If using Windows, <a href="https://www.duelink.com/bin/usb-drivers/win-usb-dfu.zip" target="_blank" data-v-9a49df8b>download</a> and install the DFU driver first. </p><img src="'+y+'" alt="DFU selection" class="screenshot" data-v-9a49df8b>',7)),La.value?(i(),s("div",E,[e[6]||(e[6]=o("label",{for:"version-select"}," Select firmware version: ",-1)),u(o("select",{id:"version-select","onUpdate:modelValue":e[1]||(e[1]=a=>xa.value=a)},[(i(!0),s(d,null,v(Fa.value,(a,e)=>(i(),s("option",{key:a.id,value:e},b(a.name),9,L))),128))],512),[[c,xa.value]])])):r("",!0),o("div",{class:"button-row"},[o("button",{class:"outline-button",onClick:Aa}," Load DUELink Firmware/Driver "),e[7]||(e[7]=o("hr",{class:"divider"},null,-1)),e[8]||(e[8]=o("p",{class:"subtitle"},[f(" The update steps are now complete on a single device."),o("br"),o("br"),f(" Continue to step 3 if you have multiple devices in a chain that you want to update. ")],-1))]),e[29]||(e[29]=n('<hr class="divider" data-v-9a49df8b><h2 class="section-title" data-v-9a49df8b>Step 3 (Update Chain)</h2><p class="subtitle" data-v-9a49df8b> This optional step is for updating all modules in a chain (Daisylink). </p><p class="subtitle" data-v-9a49df8b> Click the <strong data-v-9a49df8b>Load Driver Script</strong> button, then select the device. You should only see one named <em data-v-9a49df8b>DUELink Official</em>. </p><img src="'+y+'" alt="Driver selection" class="screenshot" data-v-9a49df8b><div class="button-row" data-v-9a49df8b><button class="outline-button" data-v-9a49df8b> Update Chain </button></div>',6)),ua.value?(i(),s("div",x,[o("div",F,[e[11]||(e[11]=o("div",{class:"dialog-title"},[o("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),f(" Warning ")],-1)),o("div",T,[o("p",null,[f(b(wa.value),1),e[9]||(e[9]=o("br",null,null,-1)),e[10]||(e[10]=o("br",null,null,-1))])]),o("div",{class:"dialog-buttons"},[o("button",{class:"yes",onClick:ga},"Yes"),o("button",{class:"no",onClick:ma},"No")])])])):r("",!0),ca.value?(i(),s("div",S,[o("div",A,[e[12]||(e[12]=o("div",{class:"dialog-title-success"},[o("i",{class:"fas fa-check-circle",style:{color:"green","margin-right":"8px"}}),f(" Success ")],-1)),o("div",B,[o("p",null,b(na.value),1)]),o("div",I,[o("button",{class:"no",onClick:e[2]||(e[2]=a=>{ca.value=!1})},"Close")])])])):r("",!0),da.value?(i(),s("div",j,[o("div",q,[e[13]||(e[13]=o("div",{class:"dialog-title"},[o("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),f(" Failed ")],-1)),o("div",M,[o("p",null,b(oa.value),1)]),o("div",O,[o("button",{class:"no",onClick:e[3]||(e[3]=a=>{da.value=!1})},"Close")])])])):r("",!0),va.value?(i(),s("div",P,[o("div",N,[e[14]||(e[14]=o("div",{class:"dialog-title"},[o("i",{class:"fas fa-question-circle",style:{color:"white","margin-right":"8px"}}),f(" Warning ")],-1)),e[15]||(e[15]=o("div",{class:"dialog-body"},[o("p",null," Firmware updated. Do you want to load driver? ")],-1)),o("div",W,[o("button",{class:"yes",onClick:ha},"Yes"),o("button",{class:"no",onClick:e[4]||(e[4]=a=>va.value=!1)},"No")])])])):r("",!0),ba.value?(i(),s("div",Y,[o("div",H,[e[25]||(e[25]=o("div",{class:"dialog-title"},[o("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),f(" Warning ")],-1)),o("div",V,[o("p",null,[f(b(Da.value),1),e[16]||(e[16]=o("br",null,null,-1))]),o("p",{style:p({color:Ta.value?"#000000":"#d9534f"})},[f(b(Ea.value),1),e[17]||(e[17]=o("br",null,null,-1))],4),!1===Ta.value?(i(),s("p",R,[e[18]||(e[18]=f(" (Recommend: ",-1)),o("button",{class:"link-button underline",onClick:e[5]||(e[5]=e=>{ba.value=!1,a.dfuModal.start()})}," Update "),e[19]||(e[19]=f(" to the latest firmware.) ",-1))])):r("",!0),e[24]||(e[24]=o("br",null,null,-1)),o("p",null,[e[20]||(e[20]=f("Do you want to load ",-1)),o("a",{target:"_blank",href:w(la).update_driver_path.value},"this driver",8,z),e[21]||(e[21]=f("?",-1)),e[22]||(e[22]=o("br",null,null,-1)),e[23]||(e[23]=o("br",null,null,-1))])]),o("div",{class:"dialog-buttons"},[o("button",{class:"yes",onClick:ya},"Yes"),o("button",{class:"no",onClick:ka},"No")])])])):r("",!0),fa.value?(i(),s("div",G,[o("div",$,[o("div",{class:g(["dialog-title",{"dialog-title-success":100===pa.value}])},[pa.value<100?(i(),s("i",J)):r("",!0),f(" "+b((pa.value,ia.value)),1)],2),o("div",K,[e[26]||(e[26]=o("br",null,null,-1)),o("div",Q,[o("div",{class:"update-driver-progress-bar",style:p({width:pa.value+"%"})},null,4)]),o("div",X,b(pa.value)+"% ",1)])])])):r("",!0)]))}},[["__scopeId","data-v-9a49df8b"]])).mount("#app");
