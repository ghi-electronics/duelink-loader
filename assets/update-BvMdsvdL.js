import{m as a,u as e,d as t,r as l,e as s,f as i,c as n,o as c,a as o,g as d,h as r,i as u,v,F as f,j as p,k as w,t as g,n as m,l as h,p as y,b}from"./mitt-DApd8ShI.js";import{_ as k,a as _,b as U}from"./_plugin-vue_export-helper-Dl_H5AQ6.js";const C=""+new URL("../img/usbhook-rgb3.webp",import.meta.url).href,D={class:"page"},E={class:"button-row"},x={key:0,class:"version-select"},L=["value"],F={key:1,class:"overlay"},T={class:"dialog"},S={class:"dialog-body"},A={key:2,class:"overlay"},B={class:"dialog"},I={class:"dialog-body"},q={class:"dialog-buttons"},j={key:3,class:"overlay"},M={class:"dialog"},O={class:"dialog-body"},P={class:"dialog-buttons"},N={key:4,class:"overlay"},W={class:"dialog"},Y={class:"dialog-body"},H={class:"dialog-buttons"},V={key:5,class:"overlay"},R={class:"dialog"},z={class:"dialog-body"},G={key:0,class:"firmware-warning"},$=["href"],J={key:6,class:"overlay"},K={class:"dialog",style:{width:"25vw"}},Q={key:0,class:"fas fa-exclamation-triangle",style:{"margin-right":"8px"}},X={class:"dialog-body"},Z={class:"update-driver-progress-container"},aa={class:"progress-text"},ea="Firmware detected.\nAre you sure you want to erase all?",ta=2048,la=134217728;b(k({__name:"update",setup(b){const k=a(),sa=e({progress:null},k);t(async()=>{await async function(){try{const a=await fetch("https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/duelink-fw.json"),e=await a.json();Object.keys(e).forEach(a=>{Da[a]=e[a],Da[a].isGlb=!1,Da[a].image=null})}catch(a){}}()}),l("");const ia=l(""),na=l(""),ca=l(""),oa=l("");function da(a){return new Promise(e=>setTimeout(e,a))}const ra=l(!1),ua=l(!1),va=l(!1),fa=l(!1),pa=l(!1),wa=l(!1),ga=l(0),ma=l(ea);async function ha(){for(ra.value=!1,ga.value=0,na.value="Please wait...",pa.value=!0,await sa.eraseall_dms_execute();sa.eraseall_status_dms.value<2;)await da(250),ga.value=50;ga.value=100,na.value="Done",await da(250),pa.value=!1,ca.value="Erase all completed.",ua.value=!0}async function ya(){ra.value=!1,sa.isConnected&&(await sa.disconnect(),await da(250))}async function ba(){if(fa.value=!1,!sa.isConnected.value){sa.device_name.value="",sa.driver_ver.value="",sa.progress_percent.value=0,ga.value=0,sa.update_driver_status.value=0,sa.update_devaddr.value=1,sa.connection_mode.value=1;if(await sa.driver_connect()){for(na.value="Please wait...",pa.value=!0,ga.value=0;0==sa.update_driver_status.value;)await da(100),ga.value=sa.progress_percent.value;if(await da(100),1==sa.update_driver_status.value){let a=!1;const e=Date.now()+4e3;for(;!(sa.isConnected.value&&""!=sa.device_name.value&&""!=sa.driver_ver.value||(await da(100),Date.now()>e));)ga.value=sa.progress_percent.value;sa.isConnected.value&&Date.now()<e&&(a=!0),a&&(na.value="Connected",Ea.value="Device Name: "+sa.device_name.value,xa.value="Firmware Version: "+sa.version.value,wa.value=!0,ga.value=100,pa.value=!1)}pa.value=!1,ga.value=0}}}async function ka(){for(wa.value=!1,na.value="Please wait...",pa.value=!0,sa.progress_percent.value=0,ga.value=0,sa.driver_update();100!=sa.progress_percent.value;)await da(1),ga.value=sa.progress_percent.value;sa.update_driver_status.value=0,await sa.disconnect(),await da(10),pa.value=!1,ca.value="Load driver completed.",ua.value=!0}async function _a(){sa.isConnected.value&&(sa.disconnect(),await da(100)),wa.value=!1}let Ua;const Ca=l(!1),Da=s({}),Ea=l("");l("");const xa=l(""),La=i(()=>Da.DUELink),Fa=l(0),Ta=i(()=>La.value?.versions?[...La.value.versions].sort((a,e)=>e.id-a.id):[]),Sa=i(()=>Ta.value[Fa.value]||null),Aa=l(!0);async function Ba(){const a=La;await async function(a){try{0!==(await Ma()).status&&(await Ua.controlTransferOut({requestType:"class",recipient:"interface",request:4,value:0,index:0}),await da(100));const e=a.byteLength;await async function(a){ia.value="Erasing...",na.value=ia.value;const e=Math.ceil(a/ta);for(let t=0;t<e;t++){const a=la+t*ta,l=new Uint8Array(5);l[0]=65,l[1]=255&a,l[2]=a>>8&255,l[3]=a>>16&255,l[4]=a>>24&255,await ja(0,l),await Oa(),qa(t,e)}ia.value="Erased.",na.value=ia.value,qa(0,100)}(e),ga.value=0,pa.value=!1,await da(250),pa.value=!0,ia.value="Writing...",na.value=ia.value;let t=new Uint8Array(5);t[0]=33,t[1]=0,t[2]=0,t[3]=0,t[4]=8,await ja(0,t),await Oa();let l=0,s=2;for(;l<e;){const t=a.slice(l,l+1024);await ja(s,t),await Oa(),l+=t.byteLength,s++,qa(l,e)}await async function(){let a=new Uint8Array(5);try{return a[0]=33,a[1]=0,a[2]=0,a[3]=0,a[4]=8,await ja(0,a),await Oa(),await ja(0,new ArrayBuffer(0)),await Oa(),1}catch(e){}return 0}(),ia.value="Completed"}catch(e){ia.value="Failed"}na.value=ia.value}(a.image)}async function Ia(){await async function(){try{Ca.value=!1,Ua=await navigator.usb.requestDevice({filters:[{vendorId:1155,productId:57105}]}),await Ua.open(),Ua.configuration||await Ua.selectConfiguration(1),await Ua.claimInterface(0),Ca.value=!0}catch(a){a.value="Connection error: "+a,Ca.value=!1}}(),Ca.value&&(ga.value=0,na.value="Please wait...",pa.value=!0,await async function(){const a=Ta?.value[Fa.value],e=a?.url;try{const a=await fetch(e);if(!a.ok)throw new Error(`HTTP ${a.status}`);const t=await a.blob(),l=await t.arrayBuffer();La.image=l}catch(t){La.image=null}}(),await Ba(),pa.value=!1,"Completed"==ia.value&&(fa.value=!0))}function qa(a,e){ga.value=Math.round(a/e*100),ga.value}async function ja(a,e){const t=await Ua.controlTransferOut({requestType:"class",recipient:"interface",request:1,value:a,index:0},e);if("ok"!==t.status)throw new Error("DNLOAD transfer failed at block "+a);return t}async function Ma(){const a=await Ua.controlTransferIn({requestType:"class",recipient:"interface",request:3,value:0,index:0},6);if("ok"===a.status&&a.data&&6===a.data.byteLength){const e=new DataView(a.data.buffer);return{status:e.getUint8(0),pollTimeout:e.getUint8(1)|e.getUint8(2)<<8|e.getUint8(3)<<16,state:e.getUint8(4),iString:e.getUint8(5)}}throw new Error("Failed to read DFU status.")}async function Oa(){for(;;){const a=await Ma();if(5===a.state||2===a.state)break;await da(a.pollTimeout)}}return(a,e)=>(c(),n("div",D,[e[26]||(e[26]=o('<h1 class="title" data-v-ddfc04e0>DUELink Loader</h1><p class="subtitle" data-v-ddfc04e0> This page will help in updating DUELink firmware and its related Driver. </p><hr class="divider" data-v-ddfc04e0><h2 class="section-title" data-v-ddfc04e0>Step 1 (Erase All)</h2><div class="card-container" data-v-ddfc04e0><div class="card" data-v-ddfc04e0><img src="'+_+'" alt="Module with USB" class="card-image" data-v-ddfc04e0><p class="card-text" data-v-ddfc04e0> If your module has a USB connector, just plug it in! </p></div><div class="card" data-v-ddfc04e0><img src="'+C+'" alt="USB Hook" class="card-image" data-v-ddfc04e0><p class="card-text" data-v-ddfc04e0> If your module has a <code data-v-ddfc04e0>U</code> Uplink connector, you need a USB adaptor, like USB Hook. </p></div></div><p class="subtitle" data-v-ddfc04e0> Click the <strong data-v-ddfc04e0>Erase All</strong> button, then select the device. You should only see one named <em data-v-ddfc04e0>DUELink Official</em> or <em data-v-ddfc04e0>DUELink MicroBlocks</em>. </p><img src="'+U+'" alt="Select DFU device" class="screenshot" data-v-ddfc04e0>',7)),d("div",E,[d("button",{class:"outline-button",onClick:e[0]||(e[0]=a=>async function(){if(sa.eraseall_status_dms.value=0,0==sa.isConnected.value){for(sa.eraseall_vid_dms.value=0,sa.connection_mode.value=2,await sa.eraseall_dms_connect();0==sa.eraseall_status_dms.value;)await da(100);await da(100)}if(0!=sa.eraseall_vid_dms.value){let a=65535&sa.eraseall_vid_dms.value;ma.value=62208==a?"DUELink "+ea:"MicroBlocks "+ea,ra.value=!0}}())}," Erase All ")]),e[27]||(e[27]=o('<p class="subtitle" data-v-ddfc04e0> If <strong data-v-ddfc04e0>Erase All</strong> failed, visit the <a href="https://www.duelink.com/docs/loader" target="_blank" data-v-ddfc04e0> loader documentation page </a>. </p><hr class="divider" data-v-ddfc04e0><h2 class="section-title" data-v-ddfc04e0>Step 2 (Load Firmware/Driver)</h2><p class="subtitle" data-v-ddfc04e0> This step will update the firmware on a single device, or on the first device in a chain. </p><p class="subtitle" data-v-ddfc04e0> Click the button below then select the <em data-v-ddfc04e0>DFU in FS Mode</em> device and click <strong data-v-ddfc04e0>Connect</strong>. </p><p class="subtitle" data-v-ddfc04e0> If using Windows, <a href="https://www.duelink.com/bin/usb-drivers/win-usb-dfu.zip" target="_blank" data-v-ddfc04e0>download</a> and install the DFU driver first. </p><img src="'+U+'" alt="DFU selection" class="screenshot" data-v-ddfc04e0>',7)),La.value?(c(),n("div",x,[e[6]||(e[6]=d("label",{for:"version-select"}," Select firmware version: ",-1)),u(d("select",{id:"version-select","onUpdate:modelValue":e[1]||(e[1]=a=>Fa.value=a)},[(c(!0),n(f,null,p(Ta.value,(a,e)=>(c(),n("option",{key:a.id,value:e},g(a.name),9,L))),128))],512),[[v,Fa.value]])])):r("",!0),d("div",{class:"button-row"},[d("button",{class:"outline-button",onClick:Ia}," Load DUELink Firmware/Driver "),e[7]||(e[7]=d("hr",{class:"divider"},null,-1)),e[8]||(e[8]=d("p",{class:"subtitle"},[w(" The update steps are now complete on a single device."),d("br"),d("br"),w(" Continue to step 3 if you have multiple devices in a chain that you want to update. ")],-1))]),e[28]||(e[28]=o('<hr class="divider" data-v-ddfc04e0><h2 class="section-title" data-v-ddfc04e0>Step 3 (Update Chain)</h2><p class="subtitle" data-v-ddfc04e0> This optional step is for updating all modules in a chain (Daisylink). </p><p class="subtitle" data-v-ddfc04e0> Click the <strong data-v-ddfc04e0>Load Driver Script</strong> button, then select the device. You should only see one named <em data-v-ddfc04e0>DUELink Official</em>. </p><img src="'+U+'" alt="Driver selection" class="screenshot" data-v-ddfc04e0><div class="button-row" data-v-ddfc04e0><button class="outline-button" data-v-ddfc04e0> Update Chain </button></div>',6)),ra.value?(c(),n("div",F,[d("div",T,[e[11]||(e[11]=d("div",{class:"dialog-title"},[d("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),w(" Warning ")],-1)),d("div",S,[d("p",null,[w(g(ma.value),1),e[9]||(e[9]=d("br",null,null,-1)),e[10]||(e[10]=d("br",null,null,-1))])]),d("div",{class:"dialog-buttons"},[d("button",{class:"yes",onClick:ha},"Yes"),d("button",{class:"no",onClick:ya},"No")])])])):r("",!0),ua.value?(c(),n("div",A,[d("div",B,[e[12]||(e[12]=d("div",{class:"dialog-title-success"},[d("i",{class:"fas fa-check-circle",style:{color:"green","margin-right":"8px"}}),w(" Success ")],-1)),d("div",I,[d("p",null,g(ca.value),1)]),d("div",q,[d("button",{class:"no",onClick:e[2]||(e[2]=a=>{ua.value=!1})},"Close")])])])):r("",!0),va.value?(c(),n("div",j,[d("div",M,[e[13]||(e[13]=d("div",{class:"dialog-title"},[d("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),w(" Failed ")],-1)),d("div",O,[d("p",null,g(oa.value),1)]),d("div",P,[d("button",{class:"no",onClick:e[3]||(e[3]=a=>{va.value=!1})},"Close")])])])):r("",!0),fa.value?(c(),n("div",N,[d("div",W,[e[14]||(e[14]=d("div",{class:"dialog-title"},[d("i",{class:"fas fa-question-circle",style:{color:"white","margin-right":"8px"}}),w(" Warning ")],-1)),d("div",Y,[d("p",null," Firmware "+g(Sa.value?.name)+" updated. Do you want to load driver? ",1)]),d("div",H,[d("button",{class:"yes",onClick:ba},"Yes"),d("button",{class:"no",onClick:e[4]||(e[4]=a=>fa.value=!1)},"No")])])])):r("",!0),wa.value?(c(),n("div",V,[d("div",R,[e[24]||(e[24]=d("div",{class:"dialog-title"},[d("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),w(" Warning ")],-1)),d("div",z,[d("p",null,[w(g(Ea.value),1),e[15]||(e[15]=d("br",null,null,-1))]),d("p",{style:m({color:Aa.value?"#000000":"#d9534f"})},[w(g(xa.value),1),e[16]||(e[16]=d("br",null,null,-1))],4),!1===Aa.value?(c(),n("p",G,[e[17]||(e[17]=w(" (Recommend: ",-1)),d("button",{class:"link-button underline",onClick:e[5]||(e[5]=a=>{wa.value=!1})}," Update "),e[18]||(e[18]=w(" to the latest firmware.) ",-1))])):r("",!0),e[23]||(e[23]=d("br",null,null,-1)),d("p",null,[e[19]||(e[19]=w("Do you want to load ",-1)),d("a",{target:"_blank",href:h(sa).update_driver_path.value},"this driver",8,$),e[20]||(e[20]=w("?",-1)),e[21]||(e[21]=d("br",null,null,-1)),e[22]||(e[22]=d("br",null,null,-1))])]),d("div",{class:"dialog-buttons"},[d("button",{class:"yes",onClick:ka},"Yes"),d("button",{class:"no",onClick:_a},"No")])])])):r("",!0),pa.value?(c(),n("div",J,[d("div",K,[d("div",{class:y(["dialog-title",{"dialog-title-success":100===ga.value}])},[ga.value<100?(c(),n("i",Q)):r("",!0),w(" "+g((ga.value,na.value)),1)],2),d("div",X,[e[25]||(e[25]=d("br",null,null,-1)),d("div",Z,[d("div",{class:"update-driver-progress-bar",style:m({width:ga.value+"%"})},null,4)]),d("div",aa,g(ga.value)+"% ",1)])])])):r("",!0)]))}},[["__scopeId","data-v-ddfc04e0"]])).mount("#app");
