import{_ as e,e as a,o as t,c as l,a as s,f as i,w as n,v as u,g as o,r,h as d,i as c,t as v,n as f,u as p,j as w,b as g,F as h,k as m,l as y,m as _,d as b}from"./Footer-BqSni8HT.js";import{u as k,_ as C,a as U}from"./useWebSerial-hOL-6pb5.js";const D=""+new URL("../img/stamp-usb-connect.webp",import.meta.url).href,E=""+new URL("../img/usbhook-rgb3.webp",import.meta.url).href,L={class:"page"},F={key:0,class:"version-select"},x=["value"],T={key:1,class:"overlay"},S={class:"dialog"},A={class:"dialog-body"},q={key:2,class:"overlay"},M={class:"dialog"},O={class:"dialog-body"},B={class:"dialog-buttons"},I={key:3,class:"overlay"},j={class:"dialog"},N={class:"dialog-body"},W={class:"dialog-buttons"},P={key:4,class:"overlay"},Y={class:"dialog"},R={class:"dialog-body"},V={class:"dialog-buttons"},$={key:5,class:"overlay"},H={class:"dialog"},z={class:"dialog-body"},G={key:0,class:"firmware-warning"},J=["href"],K={key:6,class:"overlay"},Q={class:"dialog",style:{width:"25vw"}},X={key:0,class:"fas fa-exclamation-triangle",style:{"margin-right":"8px"}},Z={class:"dialog-body"},ee={class:"progress-text"},ae={class:"update-driver-progress-container"},te={class:"progress-text"},le="Firmware detected.",se=2048,ie=134217728;b(e({__name:"update",setup(e){const b=k();a(async()=>{await async function(){try{const e=await fetch("https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/duelink-fw.json"),a=await e.json();Object.keys(a).forEach(e=>{Fe[e]=a[e],Fe[e].isGlb=!1,Fe[e].image=null})}catch(e){}}()});const ne=_(""),ue=_(""),oe=_(""),re=_(""),de=_("");function ce(e){return new Promise(a=>setTimeout(a,e))}const ve=_(!1),fe=_(!1),pe=_(!1),we=_(!1),ge=_(!1),he=_(!1),me=_(0),ye=_(le);async function _e(){for(ve.value=!1,me.value=0,oe.value="Erase All",ue.value="Erasing....",ge.value=!0,await b.eraseall_dms_execute();b.eraseall_status_dms.value<2;)await ce(250),me.value=50;me.value=100,oe.value="Done",await ce(250),ge.value=!1,re.value="Erase all completed.",fe.value=!0}async function be(){ve.value=!1,b.isConnected&&(await b.disconnect(),await ce(250))}async function ke(){if(we.value=!1,!b.isConnected.value){b.device_name.value="",b.driver_ver.value="",b.progress_percent.value=0,me.value=0,b.update_driver_status.value=0,b.update_devaddr.value=1,b.connection_mode.value=1;if(await b.driver_connect()){for(oe.value="Driver Update",ue.value="Connecting...",ge.value=!0,me.value=0;0==b.update_driver_status.value;)await ce(100),me.value=b.progress_percent.value;if(await ce(100),1==b.update_driver_status.value){let e=!1;const a=Date.now()+4e3;for(;!(b.isConnected.value&&""!=b.device_name.value&&""!=b.driver_ver.value||(await ce(100),Date.now()>a));)me.value=b.progress_percent.value;b.isConnected.value&&Date.now()<a&&(e=!0),e&&(xe.value="Device Name: "+b.device_name.value,Te.value="Firmware Version: "+b.version.value,he.value=!0,me.value=100,ge.value=!1)}ge.value=!1,me.value=0}}}async function Ce(){for(he.value=!1,oe.value="Driver Update",ue.value="Writing driver...",ge.value=!0,b.progress_percent.value=0,me.value=0,b.driver_update();100!=b.progress_percent.value;)await ce(1),me.value=b.progress_percent.value;b.update_driver_status.value=0,await b.disconnect(),await ce(10),ge.value=!1,re.value="Load driver completed.",fe.value=!0}async function Ue(){b.isConnected.value&&(b.disconnect(),await ce(100)),he.value=!1}async function De(){if(oe.value="Update Chain",0==b.isConnected.value&&await async function(){if(b.connect_status.value=0,b.connection_mode.value=0,b.update_driver_status.value=0,me.value=0,b.progress_percent.value=0,await b.connect()){for(ue.value="Connecting to device 1...",ge.value=!0,me.value=0;0==b.connect_status.value&&(await ce(100),me.value=b.progress_percent.value,71!=me.value););b.connect_status.value>0&&(me.value=99,await ce(100)),ge.value=!1,me.value=0,await ce(100),b.connect_status.value<0&&(de.value="Connection failed",pe.value=!0)}}(),0!=b.isConnected.value){for(b.clone_fw_status.value=0,ue.value="Please wait...",ge.value=!0,b.progress_percent.value=0,me.value=0,b.do_clone_fw(1,200),b.progress_percent.value=0;0==b.clone_fw_status.value;)await ce(100),ue.value=b.progress_body_text.value,me.value=b.progress_percent.value;await ce(100),ge.value=!1,b.disconnect(),b.clone_fw_status.value>1?(2==b.clone_fw_status.value?re.value=`A total of ${b.clone_fw_status.value-1} device was successfully cloned and its driver updated.`:re.value=`A total of ${b.clone_fw_status.value-1} devices were successfully cloned and had their drivers updated.`,fe.value=!0):(de.value="No devices were cloned successfully.",pe.value=!0)}}let Ee;const Le=_(!1),Fe=m({}),xe=_(""),Te=_(""),Se=y(()=>Fe.DUELink),Ae=_(0),qe=y(()=>Se.value?.versions?[...Se.value.versions].sort((e,a)=>a.id-e.id):[]),Me=y(()=>qe.value[Ae.value]||null),Oe=_(!0);async function Be(){const e=Se;await async function(e){try{0!==(await We()).status&&(await Ee.controlTransferOut({requestType:"class",recipient:"interface",request:4,value:0,index:0}),await ce(100));const a=e.byteLength;await async function(e){ne.value="Erasing...",ue.value=ne.value;const a=Math.ceil(e/se);for(let t=0;t<a;t++){const e=ie+t*se,l=new Uint8Array(5);l[0]=65,l[1]=255&e,l[2]=e>>8&255,l[3]=e>>16&255,l[4]=e>>24&255,await Ne(0,l),await Pe(),je(t,a)}ne.value="Erased.",ue.value=ne.value,je(0,100)}(a),me.value=0,ge.value=!1,await ce(250),ge.value=!0,ne.value="Writing...",ue.value=ne.value;let t=new Uint8Array(5);t[0]=33,t[1]=0,t[2]=0,t[3]=0,t[4]=8,await Ne(0,t),await Pe();let l=0,s=2;for(;l<a;){const t=e.slice(l,l+1024);await Ne(s,t),await Pe(),l+=t.byteLength,s++,je(l,a)}await async function(){let e=new Uint8Array(5);try{return e[0]=33,e[1]=0,e[2]=0,e[3]=0,e[4]=8,await Ne(0,e),await Pe(),await Ne(0,new ArrayBuffer(0)),await Pe(),1}catch(a){}return 0}(),ne.value="Completed"}catch(a){ne.value="Failed"}ue.value=ne.value}(e.image)}async function Ie(){await async function(){try{Le.value=!1,Ee=await navigator.usb.requestDevice({filters:[{vendorId:1155,productId:57105}]}),await Ee.open(),Ee.configuration||await Ee.selectConfiguration(1),await Ee.claimInterface(0),Le.value=!0}catch(e){e.value="Connection error: "+e,Le.value=!1}}(),Le.value&&(me.value=0,oe.value="Firmware Update",ue.value="Fetching firmware url...",ge.value=!0,await async function(){const e=qe?.value[Ae.value],a=e?.url;try{const e=await fetch(a);if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.blob(),l=await t.arrayBuffer();Se.image=l}catch(t){Se.image=null}}(),await Be(),ge.value=!1,"Completed"==ne.value?we.value=!0:(de.value="Loading firmware failed!",pe.value=!0))}function je(e,a){me.value=Math.round(e/a*100),me.value}async function Ne(e,a){const t=await Ee.controlTransferOut({requestType:"class",recipient:"interface",request:1,value:e,index:0},a);if("ok"!==t.status)throw new Error("DNLOAD transfer failed at block "+e);return t}async function We(){const e=await Ee.controlTransferIn({requestType:"class",recipient:"interface",request:3,value:0,index:0},6);if("ok"===e.status&&e.data&&6===e.data.byteLength){const a=new DataView(e.data.buffer);return{status:a.getUint8(0),pollTimeout:a.getUint8(1)|a.getUint8(2)<<8|a.getUint8(3)<<16,state:a.getUint8(4),iString:a.getUint8(5)}}throw new Error("Failed to read DFU status.")}async function Pe(){for(;;){const e=await We();if(5===e.state||2===e.state)break;await ce(e.pollTimeout)}}return(e,a)=>(t(),l("div",L,[a[26]||(a[26]=s('<h1 class="title" data-v-2d3ed14f>DUELink Loader</h1><p data-v-2d3ed14f> Update modules with official firmware and drivers! </p><hr data-v-2d3ed14f><h2 data-v-2d3ed14f>Step 1: Erase All</h2><div class="card-container" data-v-2d3ed14f><div class="card" data-v-2d3ed14f><img src="'+D+'" alt="Module with USB" class="card-image" data-v-2d3ed14f><p data-v-2d3ed14f> Plug-in the USB cable directly... </p></div><div class="card" data-v-2d3ed14f><img src="'+E+'" alt="USB Hook" class="card-image" data-v-2d3ed14f><p data-v-2d3ed14f> ...or use an adapter on the Uplink connector. </p></div></div><p data-v-2d3ed14f> Click the <strong data-v-2d3ed14f>Erase All</strong> button. The pop-up window should have a device named <em data-v-2d3ed14f>DUELink Official</em> or <em data-v-2d3ed14f>DUELink MicroBlocks</em>.<br data-v-2d3ed14f><br data-v-2d3ed14f> Select the device then click <strong data-v-2d3ed14f>Connect</strong>. </p><img src="'+C+'" alt="Select COM device" data-v-2d3ed14f>',7)),i("div",null,[i("button",{class:"outline-button",onClick:a[0]||(a[0]=e=>async function(){if(b.eraseall_status_dms.value=0,0==b.isConnected.value){for(b.eraseall_vid_dms.value=0,b.connection_mode.value=2,await b.eraseall_dms_connect();0==b.eraseall_status_dms.value;)await ce(100);await ce(100)}if(0!=b.eraseall_vid_dms.value){let e=65535&b.eraseall_vid_dms.value;ye.value=62208==e?"DUELink "+le:"MicroBlocks "+le,ve.value=!0}}())}," Erase All ")]),a[27]||(a[27]=s('<p data-v-2d3ed14f> If the pop-up window didn&#39;t show the needed device or if <strong data-v-2d3ed14f>Erase All</strong> failed, your device might already be erased. Try Step 2 or visit the <a href="https://www.duelink.com/docs/loader" target="_blank" data-v-2d3ed14f>loader documentation page</a>. </p><hr data-v-2d3ed14f><h2 data-v-2d3ed14f>Step 2: Load Firmware/Driver</h2><p data-v-2d3ed14f> This step will update the firmware on a single device, or on the first device in a chain. </p><p data-v-2d3ed14f> Click the button below then select the <em data-v-2d3ed14f>DFU in FS Mode</em> device and click <strong data-v-2d3ed14f>Connect</strong>. </p><p data-v-2d3ed14f> If using Windows, <a href="https://www.duelink.com/bin/usb-drivers/win-usb-dfu.zip" target="_blank" data-v-2d3ed14f>download</a> and install the DFU driver first. </p><img src="'+U+'" alt="DFU selection" data-v-2d3ed14f>',7)),Se.value?(t(),l("div",F,[a[6]||(a[6]=i("label",{for:"version-select"}," Select DUELink firmware version: ",-1)),n(i("select",{id:"version-select","onUpdate:modelValue":a[1]||(a[1]=e=>Ae.value=e)},[(t(!0),l(o,null,r(qe.value,(e,a)=>(t(),l("option",{key:e.id,value:a},v(e.name),9,x))),128))],512),[[u,Ae.value]])])):d("",!0),i("div",null,[i("button",{class:"outline-button",onClick:Ie}," Load DUELink Firmware/Driver "),a[7]||(a[7]=i("p",null,[c(" The update steps are now complete on a single device."),i("br"),i("br"),c(" Continue to step 3 if you have multiple devices in a chain that you want to update. ")],-1))]),a[28]||(a[28]=i("hr",null,null,-1)),a[29]||(a[29]=i("h2",null,"Step 3: Update Chain",-1)),a[30]||(a[30]=i("p",null," This optional step uses the first moudle to update all other modules in a chain (Daisylink). ",-1)),a[31]||(a[31]=i("p",null,[c(" Click the "),i("strong",null,"Update Chain"),c(" button, then select the device. You should only see one named "),i("em",null,"DUELink Official"),c(". ")],-1)),a[32]||(a[32]=i("img",{src:C,alt:"COM selection"},null,-1)),i("div",null,[i("button",{class:"outline-button",onClick:De}," Update Chain ")]),a[33]||(a[33]=i("p",null,[c(" For any issues, consult the "),i("a",{href:"https://www.duelink.com/docs/loader",target:"_blank"}," loader documentation"),c(" page. ")],-1)),ve.value?(t(),l("div",T,[i("div",S,[a[11]||(a[11]=i("div",{class:"dialog-title"},[i("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),c(" Warning ")],-1)),i("div",A,[i("p",null,[c(v(ye.value),1),a[8]||(a[8]=i("br",null,null,-1)),a[9]||(a[9]=i("br",null,null,-1)),c(v("Are you sure you want to erase all?")),a[10]||(a[10]=i("br",null,null,-1))])]),i("div",{class:"dialog-buttons"},[i("button",{class:"yes",onClick:_e},"Yes"),i("button",{class:"no",onClick:be},"No")])])])):d("",!0),fe.value?(t(),l("div",q,[i("div",M,[a[12]||(a[12]=i("div",{class:"dialog-title-success"},[i("i",{class:"fas fa-check-circle",style:{color:"green","margin-right":"8px"}}),c(" Success ")],-1)),i("div",O,[i("p",null,v(re.value),1)]),i("div",B,[i("button",{class:"no",onClick:a[2]||(a[2]=e=>{fe.value=!1})},"Close")])])])):d("",!0),pe.value?(t(),l("div",I,[i("div",j,[a[13]||(a[13]=i("div",{class:"dialog-title"},[i("i",{class:"fa-solid fa-triangle-exclamation",style:{color:"#f5c542","margin-right":"8px"}}),c(" Failed ")],-1)),i("div",N,[i("p",null,v(de.value),1)]),i("div",W,[i("button",{class:"no",onClick:a[3]||(a[3]=e=>{pe.value=!1})},"Close")])])])):d("",!0),we.value?(t(),l("div",P,[i("div",Y,[a[17]||(a[17]=i("div",{class:"dialog-title-success"},[i("i",{class:"fas fa-question-circle",style:{color:"white","margin-right":"8px"}}),c(" Success ")],-1)),i("div",R,[i("p",null,[c(" Firmware "+v(Me.value?.name)+" updated. ",1),a[14]||(a[14]=i("br",null,null,-1)),a[15]||(a[15]=i("br",null,null,-1)),a[16]||(a[16]=c("Do you want to load driver? ",-1))])]),i("div",V,[i("button",{class:"yes",onClick:ke},"Yes"),i("button",{class:"no",onClick:a[4]||(a[4]=e=>we.value=!1)},"No")])])])):d("",!0),he.value?(t(),l("div",$,[i("div",H,[a[24]||(a[24]=i("div",{class:"dialog-title"},[i("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),c(" Warning ")],-1)),i("div",z,[i("p",null,v(xe.value),1),i("p",{style:f({color:Oe.value?"#000000":"#d9534f"})},v(Te.value),5),!1===Oe.value?(t(),l("p",G,[a[18]||(a[18]=c(" (Recommend: ",-1)),i("button",{class:"link-button underline",onClick:a[5]||(a[5]=e=>{he.value=!1})}," Update "),a[19]||(a[19]=c(" to the latest firmware.) ",-1))])):d("",!0),a[23]||(a[23]=i("br",null,null,-1)),i("p",null,[a[20]||(a[20]=c("Do you want to load ",-1)),i("a",{target:"_blank",href:p(b).update_driver_path.value},"this driver",8,J),a[21]||(a[21]=c("?",-1)),a[22]||(a[22]=i("br",null,null,-1))])]),i("div",{class:"dialog-buttons"},[i("button",{class:"yes",onClick:Ce},"Yes"),i("button",{class:"no",onClick:Ue},"No")])])])):d("",!0),ge.value?(t(),l("div",K,[i("div",Q,[i("div",{class:w(["dialog-title",{"dialog-title-success":100===me.value}])},[me.value<100?(t(),l("i",X)):d("",!0),c(" "+v((me.value,oe.value)),1)],2),i("div",Z,[i("div",ee,v(ue.value),1),a[25]||(a[25]=i("br",null,null,-1)),i("div",ae,[i("div",{class:"update-driver-progress-bar",style:f({width:me.value+"%"})},null,4)]),i("div",te,v(me.value)+"% ",1)])])])):d("",!0),g(h)]))}},[["__scopeId","data-v-2d3ed14f"]])).mount("#app");
