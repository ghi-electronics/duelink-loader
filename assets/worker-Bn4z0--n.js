!function(){"use strict";importScripts("../consumer-queue.min.js");const e=new TextDecoder,t=new TextEncoder;let a=!1,n=">",s="",r=null,i=!0,o=null,l=null,c="",d=null;const u=new ConsumerQueue,w=[">","$","&"],p=7071,g=62208,v=62209;let f=!1,m=!0,_=0;async function b(){G(`Port status ${a}`),await new Promise(e=>setTimeout(e,400)),[r]=await navigator.serial.getPorts();try{if(null==r)return;{r.connected&&null!=r.readable&&null!=r.writable&&(r.readable.locked||r.writable.locked)&&(await q(),await new Promise(e=>setTimeout(e,1e3))),await r.open({baudRate:115200,dataBits:8,parity:"none",stopBits:1,flowControl:"none"});const e=r.getInfo();if(e.usbVendorId==p&&e.usbProductId==v)return postMessage({event:"eraseall_vid_dms",value:e.usbVendorId<<16|e.usbProductId}),postMessage({event:"progress_percent",value:71}),void q()}}catch(e){return postMessage({event:"ConnectFailed",message:e?.message,name:e.name,full:e}),void H(e?.message||"Unable to open port.")}if(r.addEventListener("disconnect",()=>{G("Port disconnected"),q()}),null==r?.writable)return void H("Port is not a writable.");if(null==r?.readable)return void H("Port is not a readable.");if(d=r.writable.getWriter(),l=r.readable.getReader(),Y(),await X(200),0!=await ee()){a=!0;const e=r.getInfo();postMessage({event:"connected"}),postMessage({event:"eraseall_vid_dms",value:e.usbVendorId<<16|e.usbProductId})}else postMessage({event:"ConnectFailed",message:"Unable to detect DUELink firmware.",name:"Device is busy"})}async function h(){await d.write(t.encode("")),await X(400),await W()}addEventListener("message",e=>{switch(G(`---- on "message", do task: ${e.data.task} ----`),e.data.task){case"clearOutput":s="";break;case"connect":T=e.data.value,m=!0,b();break;case"disconnect":q();break;case"eraseall_dms_execute_msg":!async function(){const e=r.getInfo();if(e.usbVendorId==p&&e.usbProductId==v)await d.write(new Uint8Array([250,15,199])),await X(200),postMessage({event:"eraseall_status_dms",value:2});else if(e.usbVendorId==p&&e.usbProductId==g){await d.write(t.encode("\n")),await X(400),await h(),await X(400);await te("Info(3)")>1&&(await te('cmd("setadd(0)")'),await X(500)),await d.write(t.encode("reset(1)\n")),await X(100),await d.write(t.encode("reset(1)\n")),await X(700),postMessage({event:"eraseall_status_dms",value:2}),await q()}}();break;case"eraseall_dms_connect_msg":!async function(e){G(`Port status ${a}`),await new Promise(e=>setTimeout(e,400)),[r]=await navigator.serial.getPorts();try{if(null==r)return;r.connected&&null!=r.readable&&null!=r.writable&&(r.readable.locked||r.writable.locked)&&(await q(),await new Promise(e=>setTimeout(e,1e3))),await r.open({baudRate:115200,dataBits:8,parity:"none",stopBits:1,flowControl:"none"})}catch(s){return postMessage({event:"ConnectFailed",message:s?.message,name:s.name,full:s}),void H(s?.message||"Unable to open port.")}if(r.addEventListener("disconnect",()=>{G("Port disconnected"),q()}),null==r?.writable)return void H("Port is not a writable.");if(null==r?.readable)return void H("Port is not a readable.");const n=r.getInfo();n.usbVendorId==p&&(d=r.writable.getWriter(),postMessage({event:"eraseall_vid_dms",value:n.usbVendorId<<16|n.usbProductId}),n.usbProductId==g&&(l=r.readable.getReader(),Y(),await X(200)));T=e,n.usbProductId==g&&(await d.write(t.encode(`sel(${T})\n`)),await X(50),await W());postMessage({event:"eraseall_status_dms",value:1})}(e.data.value);break;case"driver_connect_msg":A(e.data.value);break;case"driver_connect_updadate_msg":U();break;case"sendescape":h();break;case"do_clone_fw":!async function(e,a){let n=e;for(S=await async function(){await d.write(t.encode("Info(0)\n")),await X(100);let e=await W();if(e.length>0){e.pop();let t=e.pop();const a=Number(t).toString(16).toUpperCase().padStart(6,"0");$="0x"+a}await y();const a=k($);return"NA"===a?void 0:a.name}(),L=S?`${S}(${e}) detected\n`:"",n=e;n<a;n++){E=0,postMessage({event:"clone_fw_dev",value:n+1}),V(n),await X(100);let e=0;for(;0==E;)postMessage({event:"progress_percent",value:e}),e+=1,await X(300),e>99&&(e=99);if(E<0)break;e<90&&(e+=5),postMessage({event:"progress_percent",value:e}),postMessage({event:"progress_body_text",value:L+`\nConnecting to device ${n+1}...`}),m=!1,await A(n+1),m=!0,e<95&&(e+=5),postMessage({event:"progress_percent",value:e}),postMessage({event:"progress_body_text",value:L+`\n${I} detected at address ${n+1}\nLoading the driver onto device...`}),m=!1,await U(),m=!0,_>0&&(e<99&&(e=99),postMessage({event:"progress_percent",value:e}),postMessage({event:"progress_body_text",value:L+`\n${I} detected at address ${n+1}\nFinishing loading the driver...`}),L+=`${I}(${n+1}) updated`,L+="\n",n>10&&(L=L.split("\n").slice(1).join("\n")),await X(2e3))}postMessage({event:"clone_fw_status",value:n})}(e.data.value1,e.data.value2);break;case"do_discover":!async function(){if(a){D=[];let e=1,t=0;R=0,O=0,j=0;let a=R;for(;;){if(await F(e)<0||a!=R)break;t++,e++}return postMessage({event:"add_device_chain_status",value:t}),1}postMessage({event:"add_device_chain_status",value:-1})}()}});let M=null;async function y(){if(null==M){const e=await fetch("https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/duelink.json"),t=await e.json();M=Array.isArray(t.products)?t.products:[]}}function k(e){if(!M)return"NA";const t=String(e).toUpperCase(),a=M.find(e=>String(e.PID).toUpperCase()===t);return a?{name:a.name??"NA",partNumber:a.partNumber??"NA"}:"NA"}let P="",I="",$="",N="",x=!1,C="",T=1;async function A(e){if(x=!1,T=e,a){if(!(await ee()))return}else await b();if(await X(100),!a)return;await d.write(t.encode("\n")),await X(400),(await W()).pop(),await d.write(t.encode("Dver()\n")),await X(100);let n=await W();if(n.length>0){n.pop();let e=n.pop();P=e.includes("unknown identifier")?"N/A":e}if(await d.write(t.encode("Info(0)\n")),await X(100),n=await W(),n.length>0){n.pop();let e=n.pop();const t=Number(e).toString(16).toUpperCase().padStart(6,"0");$="0x"+t}await y();const s=k($);"NA"!==s&&(I=s.name,N=s.partNumber,C="https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/code/driver/"+N.toLowerCase()+".txt",postMessage({event:"update_driver_path_msg",value:C}),postMessage({event:"driver_ver_msg",value:P}),postMessage({event:"device_name_msg",value:I}),x=!0)}async function U(){if(_=0,!a||!x)return void(_=-1);const e=C,n=await fetch(e);if(!n.ok)return void(_=-1);let s=(await n.text()).replace(/\r/gm,"").replace(/\t/gm," ").split(/\n/);m&&postMessage({event:"progress_percent",value:0}),await te("new all"),m&&postMessage({event:"progress_percent",value:10}),await te("pgmbrst()","&"),await X(250),m&&postMessage({event:"progress_percent",value:20});let r=0;for(let t of s){await X(2),0===t.trim().length&&(t=" "),G("line",`"${t}"`),await Z(t+"\n"),r++;let e=Math.floor(r/s.length*70);e>70&&(e=70),e+=20,m&&postMessage({event:"progress_percent",value:e})}m&&postMessage({event:"progress_percent",value:95}),await Z("\0"),await K(),await d.write(t.encode("run\n")),await X(100),await d.write(t.encode("Region(1)\n")),await X(100),await W(),await d.write(t.encode("run\n")),await X(1e3),await d.write(t.encode("$\n")),await X(250),m&&postMessage({event:"progress_percent",value:96}),await d.write(t.encode("# This is region 1 User\n")),await X(250),await d.write(t.encode("# Replace this with your code\n")),await X(250),m&&postMessage({event:"progress_percent",value:97}),await d.write(t.encode("# StatLed(200,200,10)\n")),await X(250),m&&postMessage({event:"progress_percent",value:99}),await d.write(t.encode(">\n")),await X(250),await W(),m&&postMessage({event:"progress_percent",value:100}),_=1}let E=0,L="";async function V(e){postMessage({event:"progress_body_text",value:L+`\nChecking if device ${e+1} existsâ€¦`});try{await te(`sel(${e+1})`,null,"\n",1e3);const t=await te("Info(1)");if(t.length>0){if(Number(t.pop())>.1){await te(`sel(${e})`,null,"\n",1e3),postMessage({event:"progress_body_text",value:L+`\nCloning firmware from device(${e}) to device(${e+1})...`});const t=await te("clone()",null,"\n",4e4);if(t.length>0){const a=Number(t.pop());if(a==e+1)return E=a,E}}}await te("sel(1)")}catch{}return L="",E=-1,E}let S="";let D=[];let R=0,O=0,j=0;function B(e){let t=e;for(let a=0;a<R;a++)t=`cmd("${t}")`;return t}async function F(e){if(!a)return-1;const n=performance.now();let s=B(`sel(${e})`);await te(s,null,"\n",1e3);if(performance.now()-n>500)return-2;s=B("Info(0)")+"\n",await d.write(t.encode(s)),await X(100);let r=await W(),i="";if(r.length>0){r.pop();let e=r.pop();i="0x"+Number(e).toString(16).toUpperCase().padStart(6,"0")}if(""!=i){s=B("Info(3)")+"\n",await d.write(t.encode(s)),await X(100),r=await W();let a=1;if(r.length>0){r.pop();let e=r.pop();a=Number(e)}if(1==a||2==a){await y();const n=k(i);if("NA"===n)return;{const r="https://www.duelink.com/img/catalog/",o="https://www.duelink.com/docs/products/";let l=n.partNumber,c=r+l.toLowerCase().slice(4)+"-1.webp",u=o+l.toLowerCase().slice(4);s=B("Info(1)")+"\n",await d.write(t.encode(s)),await X(100);const w=await W();let p=0;if(w.length>0){w.pop();let e=w.pop();p=Number(e)}if(p>0){j++;const t={address:e,name:n.name,firmwareVersion:p,image:c,detail:u,dl_mode:2==a?2:0,parent_address:O,pid:i,order:j,host_deep:R};if(function(e){D.push(e)}(t),postMessage({event:"add_device_chain",address:t.address,name:t.name,firmwareVersion:t.firmwareVersion,image:t.image,detail:t.detail,dl_mode:t.dl_mode,parent_address:t.parent_address,pid:t.pid,order:t.order,host_deep:t.host_deep}),await X(250),2==a){let e=1;R++;let a=R;if(O=t.address,R>=2)postMessage({event:"add_device_chain",address:0,name:"NA",firmwareVersion:0,image:"NA",detail:"NA",dl_mode:0,parent_address:0,pid:0,order:0,host_deep:R});else for(;;){if(await F(e)<0||a!=R)break;e++}}return 1}}}return-4}return-3}async function q(){try{await async function(){i=!1,o&&(await l.cancel(),await o,o=null)}(),d&&(await d.close(),await d.releaseLock(),d=null),l&&(await l.cancel(),await l.releaseLock(),l=null),await r.close(),Q("Port disconnected.")}catch(e){a&&(Q("There was an error while disconnecting."),H(e?.message||"Unknown error."))}finally{a=!1,postMessage({event:"disconnected"}),postMessage({event:"version",value:null})}}function W(){return new Promise(async e=>{const t=[];let a;do{a=await u.tryPop(),a?(t.push(a),G("flushed - push line:",a)):G("flushed: No line")}while(a);t.length||(c=""),G("flushed",t),e(t)})}function G(){}function H(e){postMessage({event:"logError",message:e})}function Q(e){postMessage({event:"logEvent",message:e})}let z=!1;function J(e,t){const a=[...e];return a.length>1?a.pop():a?.[0]===t&&a.shift(),z=!1,a}function K(e=null,t=3e3){return z?[]:(z=!0,e||(e=n),new Promise(async a=>{const n=[];let s=!1,r=null;const i=()=>{t<0||(clearTimeout(r),r=setTimeout(()=>{s=!0,f=!1,a(J(n,e))},t))};try{let t;i();do{try{t=await u.pop()}catch(o){return G("read until",o.message||o,n),clearTimeout(r),f=!1,void a(J(n,e))}if(!t||s)break;if(i(),n.push(t),t.startsWith("!")){G("Error:",t);break}}while(t!==e)}finally{clearTimeout(r)}f=!s,a(J(n,e))}))}function X(e){return new Promise(t=>setTimeout(t,e))}function Y(){o=async function(){let t,n=!0;for(i=!0;i;)try{const{value:r,done:o}=await l.read();G("Reading... Done?",o);const d=e.decode(r).replace(/\r/gm,"");if(a&&!w.includes(d.substring(-1,1))){if(s+=d,s.length>2e3)if(d.length<s.length){s=s.substring(d.length,s.length);const e=s.indexOf("\n");e>-1&&(s=s.substring(e+1,s.length)),n=!0}else s="",postMessage({event:"output",value:"Maximum output limit reached."}),n=!1;n&&postMessage({event:"output",value:s})}if(c+=d,!c)continue;let p=c.indexOf("\n");for(p>-1?c.split("\n").forEach(e=>{}):G("->",c);p>-1;)t=c.substring(0,p),t&&(G("queued:",t),u.push(t)),c=c.substring(p+1),p=c.indexOf("\n");">"!==c&&"$"!==c&&"&"!==c||(G("queued:",c),u.push(c),c=""),o&&(i=!1),await X(2)}catch(r){postMessage({event:"logError",message:r?.message||"There were problems reading."});break}}()}async function Z(e){let a=t.encode(e),n=a.length,s=0;for(;n>0;){const e=a.subarray(s,s+Math.min(10,n));await d.write(e);const t=await u.tryPop();if(t)return t;s+=10,n-=e.length,await X(1)}return null}async function ee(){m&&postMessage({event:"progress_percent",value:5}),await d.write(t.encode("")),await X(400),await W(),m&&postMessage({event:"progress_percent",value:10}),await d.write(t.encode("\n")),await X(400),await W(),m&&postMessage({event:"progress_percent",value:15}),await d.write(t.encode("sel(1)\n")),await X(100),await W(),m&&postMessage({event:"progress_percent",value:20}),await d.write(t.encode("")),await X(100),await W(),m&&postMessage({event:"progress_percent",value:25}),await d.write(t.encode("\n")),await X(100),await W(),m&&postMessage({event:"progress_percent",value:30}),1!=T&&(m&&postMessage({event:"progress_percent",value:35}),await d.write(t.encode(`sel(${T})\n`)),await X(50),await W(),m&&postMessage({event:"progress_percent",value:40}),await d.write(t.encode("")),await X(50),await W(),m&&postMessage({event:"progress_percent",value:45}),await d.write(t.encode("\n")),await X(50),await W()),m&&postMessage({event:"progress_percent",value:60}),m&&postMessage({event:"progress_percent",value:65});const e=await async function(){const e=await te("version()");for(const t of e)if(G("line",t,(t.match(/\./g)||[]).length),-1!=t.indexOf("GHI Electronics DUELink v"))return t.split(":")[0].substring(24)}();return"string"==typeof e?(postMessage({event:"version",value:e}),m&&postMessage({event:"progress_percent",value:100}),1):(m&&postMessage({event:"progress_percent",value:71}),await q(),0)}async function te(e,a=null,s="\n",r=3e3){try{postMessage({event:"isTalking",value:!0}),await W(),d.write(t.encode(e+s)),">"!==e&&"$"!==e||(n=e),await X(50);const i=await K(a||n,r);return i}finally{postMessage({event:"isTalking",value:!1,lastCommand:e})}}}();
