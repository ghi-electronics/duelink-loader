import{r as e,d as a,c as t,o as s,a as i,e as l,f as n,g as o,t as r,u as c,n as u,h as d,b as v}from"./runtime-dom.esm-bundler-to4JhdcG.js";import{m as w,u as p}from"./mitt-CapaXOQL.js";const g={class:"page"},m={class:"button-row"},h={key:0,class:"overlay"},f={class:"dialog"},y={class:"dialog-body"},b={key:1,class:"overlay"},k={class:"dialog"},U={class:"dialog-buttons"},D={key:2,class:"overlay"},E={class:"dialog",style:{width:"25vw"}},_={key:0,class:"fas fa-exclamation-triangle",style:{"margin-right":"8px"}},L={class:"dialog-body"},C={class:"update-driver-progress-container"},x={class:"progress-text"},S={key:3,class:"overlay"},A={class:"dialog",style:{width:"25vw"}},F={key:0,class:"fas fa-exclamation-triangle",style:{"margin-right":"8px"}},T={class:"dialog-body"},B={class:"update-driver-progress-container"},I={class:"progress-text"},M="Firmware detected.\nAre you sure you want to erase all and enter DFU mode?",q=2048,j=134217728;v({__name:"official",setup(v){const O=w(),Y=p({progress:null},O);e("");const H=e("");function P(e){return new Promise(a=>setTimeout(a,e))}const W=e(!1),N=e(!1),G=e(!1),V=e(!1),$=e(0);e(1);const z=e(M);async function J(){for(W.value=!1,$.value=0,G.value=!0,await Y.eraseall_dms_execute();Y.eraseall_status_dms.value<2;)await P(250),$.value=50;$.value=100,await P(250),G.value=!1,N.value=!0}async function K(){W.value=!1,Y.isConnected&&(await Y.disconnect(),await P(250))}let Q;const R=e(!1);e(!1);const X=a({});async function Z(e){const a=X[e];await async function(e){try{0!==(await se()).status&&(await Q.controlTransferOut({requestType:"class",recipient:"interface",request:4,value:0,index:0}),await P(100));const a=e.byteLength;await async function(e){H.value="Erasing...";const a=Math.ceil(e/q);for(let t=0;t<a;t++){const e=j+t*q,s=new Uint8Array(5);s[0]=65,s[1]=255&e,s[2]=e>>8&255,s[3]=e>>16&255,s[4]=e>>24&255,await te(0,s),await ie(),ae(t,a)}H.value="Erased.",ae(0,100)}(a),$.value=0,V.value=!1,await P(250),V.value=!0,H.value="Writing...";let t=new Uint8Array(5);t[0]=33,t[1]=0,t[2]=0,t[3]=0,t[4]=8,await te(0,t),await ie();let s=0,i=2;for(;s<a;){const t=e.slice(s,s+1024);await te(i,t),await ie(),s+=t.byteLength,i++,ae(s,a)}await async function(){let e=new Uint8Array(5);try{return e[0]=33,e[1]=0,e[2]=0,e[3]=0,e[4]=8,await te(0,e),await ie(),await te(0,new ArrayBuffer(0)),await ie(),1}catch(a){}return 0}()}catch(a){}}(a.image)}async function ee(){await async function(){try{R.value=!1,Q=await navigator.usb.requestDevice({filters:[{vendorId:1155,productId:57105}]}),await Q.open(),Q.configuration||await Q.selectConfiguration(1),await Q.claimInterface(0),R.value=!0}catch(e){e.value="Connection error: "+e,R.value=!1}}(),R.value&&($.value=0,V.value=!0,await async function(e){const a=X[e];if(!a||!Array.isArray(a.versions)||0===a.versions.length)return;const t=a.versions.reduce((e,a)=>a.id>e.id?a:e).url;try{const e=await fetch(t);if(!e.ok)throw new Error(`HTTP ${e.status}`);const s=await e.blob(),i=await s.arrayBuffer();a.image=i}catch(s){a.image=null}}("DUELink"),await Z("DUELink"),V.value=!1)}function ae(e,a){$.value=Math.round(e/a*100),$.value}async function te(e,a){const t=await Q.controlTransferOut({requestType:"class",recipient:"interface",request:1,value:e,index:0},a);if("ok"!==t.status)throw new Error("DNLOAD transfer failed at block "+e);return t}async function se(){const e=await Q.controlTransferIn({requestType:"class",recipient:"interface",request:3,value:0,index:0},6);if("ok"===e.status&&e.data&&6===e.data.byteLength){const a=new DataView(e.data.buffer);return{status:a.getUint8(0),pollTimeout:a.getUint8(1)|a.getUint8(2)<<8|a.getUint8(3)<<16,state:a.getUint8(4),iString:a.getUint8(5)}}throw new Error("Failed to read DFU status.")}async function ie(){for(;;){const e=await se();if(5===e.state||2===e.state)break;await P(e.pollTimeout)}}return async function(){try{const e=await fetch("https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/duelink-fw.json"),a=await e.json();Object.keys(a).forEach(e=>{X[e]=a[e],X[e].isGlb=!1,X[e].image=null})}catch(e){}}(),(e,a)=>(s(),t("div",g,[a[9]||(a[9]=i('<h1 class="title">DUELink Loader</h1><p class="subtitle"> This page will help in updating DUELink firmware on a single module or on the entire chain of modules. </p><p class="subtitle"> If you are using MicroBlocks or Arduino on the first module in a chain, you need to update all modules first and then upload the first module with a different firmware. </p><img src="https://www.duelink.com/img/arduino-uno-r4-daisylinked.webp" alt="Chained modules" class="screenshot"><hr class="divider"><h2 class="section-title">Step 1 (Erase All)</h2><p class="subtitle"> Erase the module and enter DFU (Device Firmware Update) mode. </p><div class="card-container"><div class="card"><img src="https://www.duelink.com/img/catalog/mcduestem-b-1.webp" alt="Module with USB" class="card-image"><p class="card-text"> If your module has a USB connector, just plug it in! </p></div><div class="card"><img src="https://www.duelink.com/img/usbhook-rgb3.webp" alt="USB Hook" class="card-image"><p class="card-text"> If your module has a <code>U</code> Uplink connector, you need a USB adaptor, like USB Hook. </p></div></div><p class="subtitle"> Click the <strong>Erase All</strong> button, then select the device. You should only see one named <em>DUELink Official</em> or <em>DUELink MicroBlocks</em>. </p><img src="https://www.duelink.com/img/console-connect-dfu.webp" alt="Select DFU device" class="screenshot">',10)),l("div",m,[l("button",{class:"outline-button",onClick:a[0]||(a[0]=e=>async function(){if(Y.eraseall_status_dms.value=0,0==Y.isConnected.value){for(Y.eraseall_vid_dms.value=0,Y.connection_mode.value=2,await Y.eraseall_dms_connect();0==Y.eraseall_status_dms.value;)await P(100);await P(100)}if(0!=Y.eraseall_vid_dms.value){let e=65535&Y.eraseall_vid_dms.value;z.value=62208==e?"DUELink "+M:"MicroBlocks "+M,W.value=!0}}())}," Erase All ")]),a[10]||(a[10]=i('<p class="subtitle"> If <strong>Erase All</strong> failed, visit the <a href="https://www.duelink.com/docs/loader" target="_blank"> loader documentation page </a>. </p><hr class="divider"><h2 class="section-title">Step 2 (Load Firmware)</h2><p class="subtitle"> This step will update the firmware on a single device, or on the first device in a chain. </p><p class="subtitle"> Click the button, then <strong>Connect</strong>. Select the <em>DFU in FS Mode</em> device. If using Windows, install the DFU driver first. </p><img src="https://www.duelink.com/img/console-connect-dfu.webp" alt="DFU selection" class="screenshot">',6)),l("div",{class:"button-row"},[l("button",{class:"outline-button",onClick:ee}," Load DUELink Firmware ")]),a[11]||(a[11]=i('<hr class="divider"><h2 class="section-title">Step 3 (Load Drivers)</h2><p class="subtitle"> This step will automatically detect the connected module and load the appropriate Driver Script. </p><p class="subtitle"> Click the <strong>Load Driver Script</strong> button, then select the device. You should only see one named <em>DUELink Official</em>. </p><img src="https://www.duelink.com/img/console-connect-dfu.webp" alt="Driver selection" class="screenshot"><div class="button-row"><button class="outline-button"> Load Driver Script </button></div>',6)),W.value?(s(),t("div",h,[l("div",f,[a[4]||(a[4]=l("div",{class:"dialog-title"},[l("i",{class:"fas fa-exclamation-triangle",style:{color:"yellow","margin-right":"8px"}}),o(" Warning ")],-1)),l("div",y,[l("p",null,[o(r(z.value),1),a[2]||(a[2]=l("br",null,null,-1)),a[3]||(a[3]=l("br",null,null,-1))])]),l("div",{class:"dialog-buttons"},[l("button",{class:"yes",onClick:J},"Yes"),l("button",{class:"no",onClick:K},"No")])])])):n("",!0),N.value?(s(),t("div",b,[l("div",k,[a[5]||(a[5]=l("div",{class:"dialog-title-success"},[l("i",{class:"fas fa-check-circle",style:{color:"green","margin-right":"8px"}}),o(" Success ")],-1)),a[6]||(a[6]=l("div",{class:"dialog-body"},[l("p",null,[o('"Erase All" operation completed. You are in DFU Mode now!'),l("br"),l("br"),o("Click the Connect button on the next window.")])],-1)),l("div",U,[l("button",{class:"no",onClick:a[1]||(a[1]=e=>{N.value=!1,c(Y).isBusy=!1})},"Close")])])])):n("",!0),G.value?(s(),t("div",D,[l("div",E,[l("div",{class:u(["dialog-title",{"dialog-title-success":100===$.value}])},[$.value<100?(s(),t("i",_)):n("",!0),o(" "+r($.value<100?"Please wait...":"Completed"),1)],2),l("div",L,[a[7]||(a[7]=l("br",null,null,-1)),l("div",C,[l("div",{class:"update-driver-progress-bar",style:d({width:$.value+"%"})},null,4)]),l("div",x,r($.value)+"% ",1)])])])):n("",!0),V.value?(s(),t("div",S,[l("div",A,[l("div",{class:u(["dialog-title",{"dialog-title-success":100===$.value}])},[$.value<100?(s(),t("i",F)):n("",!0),o(" "+r(($.value,H.value)),1)],2),l("div",T,[a[8]||(a[8]=l("br",null,null,-1)),l("div",B,[l("div",{class:"update-driver-progress-bar",style:d({width:$.value+"%"})},null,4)]),l("div",I,r($.value)+"% ",1)])])])):n("",!0)]))}}).mount("#app");
